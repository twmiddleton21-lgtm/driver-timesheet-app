<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Driver Archive">
    <meta name="description" content="Driver Timesheet Pro - Professional timesheet and VOR defect reporting with AI-powered OCR">
    
    <title>Driver Archive</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons - iOS uses these instead of manifest icons -->
    <link rel="apple-touch-icon" href="Trucker Archive App Icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Trucker Archive App Icon.png">
    <link rel="apple-touch-icon" sizes="192x192" href="Trucker Archive App Icon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="Trucker Archive App Icon.png">
    
    <!-- Favicon for browsers -->
    <link rel="icon" type="image/png" href="Trucker Archive App Icon.png">
    
    <!-- iOS Splash Screen Images (optional but recommended) -->
    <!-- iPhone 14 Pro Max, 14 Plus, 13 Pro Max, 12 Pro Max -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 14 Pro, 14, 13 Pro, 13, 12 Pro, 12 -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 13 mini, 12 mini, 11 Pro, XS, X -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 11 Pro Max, XS Max -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 11, XR -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 8 Plus, 7 Plus, 6s Plus, 6 Plus -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPhone 8, 7, 6s, 6, SE (2nd/3rd gen) -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPad Pro 12.9" -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPad Pro 11", iPad Air 10.9" -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    <!-- iPad 10.2", iPad Air 10.5", iPad mini -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="Trucker Archive App Icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#0F172A',
                        'dark-card': '#1E293B',
                        'dark-surface': '#334155',
                        'vor-orange': '#F97316',
                        'biometric': '#8B5CF6'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }
        
        .calendar-day:active { transform: scale(0.95); }
        .calendar-day.has-data { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .calendar-day.has-docs { background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .calendar-day.has-data.has-docs { background: linear-gradient(135deg, #10B981 0%, #8B5CF6 100%); }
        .calendar-day.has-vor { background: linear-gradient(135deg, #F97316 0%, #EA580C 100%); color: white; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
        .calendar-day.has-biometric { background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .calendar-day.today { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.3); z-index: 10; }
        .calendar-day.today.has-data { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.5); }
        .calendar-day.other-month { opacity: 0.3; }
        
        .upload-zone { transition: all 0.3s ease; border: 2px dashed #cbd5e1; }
        .upload-zone.active { border-color: #3B82F6; background-color: rgba(59, 130, 246, 0.05); transform: scale(1.02); }
        .upload-zone.has-file { border-color: #10B981; background-color: rgba(16, 185, 129, 0.05); }
        .upload-zone.required { border-color: #EF4444; background-color: rgba(239, 68, 68, 0.05); }
        .upload-zone.vor-zone { border-color: #F97316; }
        .upload-zone.vor-zone.has-file { border-color: #F97316; background-color: rgba(249, 115, 22, 0.05); }
        
        .nav-item { transition: all 0.3s ease; }
        .nav-item.active { color: #3B82F6; }
        .nav-item.active.vor-active { color: #F97316; }
        .nav-item.active i { transform: translateY(-2px); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .extraction-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 0.7rem;
        }
        
        .day-cell {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 2px;
            text-align: center;
            min-height: 50px;
            background: white;
            position: relative;
        }
        
        .dark .day-cell {
            background: #1E293B;
            border-color: #334155;
            color: #e2e8f0;
        }
        
        .day-cell.has-data { 
            background: linear-gradient(135deg, #dbeafe 0%, #dcfce7 100%); 
            border-color: #3B82F6; 
        }
        
        .dark .day-cell.has-data {
            background: linear-gradient(135deg, #1e3a5f 0%, #14532d 100%);
            border-color: #3B82F6;
        }
        
        .day-cell.first-day { box-shadow: 0 0 0 2px #10B981; }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 0.65rem;
        }
        
        .correction-row {
            display: grid;
            grid-template-columns: 60px 1fr 1fr 60px;
            gap: 8px;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .dark .correction-row {
            background: #1E293B;
            border-color: #334155;
        }
        
        .correction-row.ring-2 {
            background: #f0fdf4;
            border-color: #10B981;
        }
        
        .dark .correction-row.ring-2 {
            background: #064e3b;
            border-color: #10B981;
        }
        
        .correction-row .day-label {
            font-weight: 600;
            color: #374151;
        }
        
        .dark .correction-row .day-label {
            color: #e2e8f0;
        }
        
        .correction-row .day-label.first-day {
            color: #059669;
        }
        
        .dark .correction-row .day-label.first-day {
            color: #34d399;
        }
        
        .correction-row input[type="time"],
        .correction-row input[type="number"] {
            background: white;
            border: 1px solid #d1d5db;
            color: #111827;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.875rem;
            width: 100%;
        }
        
        .dark .correction-row input[type="time"],
        .dark .correction-row input[type="number"] {
            background: #0F172A;
            border-color: #475569;
            color: #f1f5f9;
        }
        
        .correction-row input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dark .correction-row input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }
        
        .correction-row label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
            display: block;
        }
        
        .dark .correction-row label {
            color: #94a3b8;
        }
        
        .column-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        .col-on { background: #10B981; }
        .col-off { background: #EF4444; }
        
        .danger-zone {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
        
        .dark .danger-zone {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            border-color: #dc2626;
        }
        
        .ocr-debug-info {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f3f4f6;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .dark .ocr-debug-info {
            background: #1f2937;
            color: #d1d5db;
        }
        
        .manual-entry-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .image-preview-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-processing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }
        
        .auto-filled {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            border-color: #3B82F6 !important;
        }

        .dark .auto-filled {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%) !important;
            border-color: #60a5fa !important;
        }

        .word-box {
            position: absolute;
            border: 1px solid rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.1);
            font-size: 8px;
            color: #3B82F6;
            pointer-events: none;
        }

        .scanning-pulse {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .progress-bar-animated {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }

        .dark h3 {
            color: #f1f5f9;
        }

        .dark .bg-white {
            background-color: #1E293B;
        }

        .dark .text-gray-900 {
            color: #f1f5f9;
        }

        .dark .text-gray-700 {
            color: #cbd5e1;
        }

        .dark .text-gray-500 {
            color: #94a3b8;
        }

        .dark .border-gray-100 {
            border-color: #334155;
        }

        .dark .border-gray-200 {
            border-color: #475569;
        }

        .dark .border-gray-300 {
            border-color: #475569;
        }

        .dark .bg-gray-50 {
            background-color: #1E293B;
        }

        .dark .bg-gray-100 {
            background-color: #334155;
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: #334155;
        }

        .dark .hover\:bg-gray-100:hover {
            background-color: #475569;
        }

        /* Document upload specific styles - FIXED VERSION */
        .doc-upload-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .doc-upload-item {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 8px;
            text-align: center;
        }
        
        .doc-upload-item:hover {
            border-color: #3B82F6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .doc-upload-item.has-file {
            border-color: #10B981;
            background-color: rgba(16, 185, 129, 0.1);
            border-style: solid;
            padding: 0;
        }
        
        .doc-upload-item i {
            font-size: 1.25rem;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }
        
        .doc-upload-item .doc-label {
            font-size: 0.65rem;
            font-weight: 600;
            line-height: 1.2;
            transition: all 0.2s ease;
        }
        
        .doc-upload-item .doc-status {
            font-size: 0.6rem;
            color: #6b7280;
        }
        
        .doc-preview-thumb {
            position: absolute;
            inset: 0;
            object-fit: cover;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Action buttons at bottom of image - SMALLER SIZE */
        .doc-actions-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 6px;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .doc-upload-item.has-file .doc-actions-bar {
            opacity: 1;
        }
        
        .doc-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            border: none;
            color: white;
            transition: transform 0.2s ease;
        }
        
        .doc-action-btn:hover {
            transform: scale(1.1);
        }
        
        .doc-action-btn.view-btn {
            background: #10B981;
        }
        
        .doc-action-btn.share-btn {
            background: #3B82F6;
        }
        
        .doc-action-btn.delete-btn {
            background: #EF4444;
        }

        .storage-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #10B981);
            transition: width 0.3s ease;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #3B82F6;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Full screen image viewer styles - UPDATED WITH BETTER CLOSE HANDLING */
        .fullscreen-image-viewer {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s ease-out;
        }
        
        .fullscreen-image-viewer .viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            display: flex;
            justify-content: flex-end;
            z-index: 10;
            pointer-events: none; /* Allow clicks to pass through to image */
        }
        
        .fullscreen-image-viewer .close-btn {
            width: 44px;
            height: 44px;
            background: rgba(239, 68, 68, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease;
            pointer-events: auto; /* Re-enable clicks on button */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .fullscreen-image-viewer .close-btn:hover {
            transform: scale(1.1);
            background: rgba(239, 68, 68, 1);
        }
        
        .fullscreen-image-viewer .viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px 100px;
            cursor: pointer; /* Indicate clickable to close */
        }
        
        .fullscreen-image-viewer .viewer-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            pointer-events: none; /* Let clicks pass through to container */
        }
        
        .fullscreen-image-viewer .viewer-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            pointer-events: auto;
        }
        
        .fullscreen-image-viewer .filename-container {
            flex: 1;
            min-width: 0;
        }
        
        .fullscreen-image-viewer .filename {
            color: white;
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .fullscreen-image-viewer .doc-type-label {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .fullscreen-image-viewer .share-btn-large {
            background: #3B82F6;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .fullscreen-image-viewer .share-btn-large:hover {
            background: #2563EB;
            transform: scale(1.05);
        }

        /* History page attached docs thumbnail */
        .attached-doc-thumbnail {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .attached-doc-thumbnail:hover {
            transform: scale(1.05);
        }
        
        .attached-doc-thumbnail img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .attached-doc-thumbnail .doc-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .attached-doc-thumbnail:hover .doc-overlay {
            opacity: 1;
        }
        
        .attached-doc-thumbnail .doc-overlay i {
            color: white;
            font-size: 20px;
        }

        /* Share fallback modal */
        .share-fallback-modal {
            position: fixed;
            inset: 0;
            z-index: 300;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .share-fallback-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 100%;
            text-align: center;
        }
        
        .dark .share-fallback-content {
            background: #1E293B;
            color: white;
        }

        /* VOR specific styles */
        .vor-badge {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
        }
        
        .vor-card {
            border-left: 4px solid #F97316;
        }
        
        .defect-number-search {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #F59E0B;
        }
        
        .dark .defect-number-search {
            background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
            border-color: #F59E0B;
        }
        
        .vor-section-header {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border: 1px solid #fdba74;
        }
        
        .dark .vor-section-header {
            background: linear-gradient(135deg, #431407 0%, #7c2d12 100%);
            border-color: #ea580c;
        }

        /* Biometric specific styles */
        .biometric-badge {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }
        
        .biometric-card {
            border-left: 4px solid #8B5CF6;
        }
        
        .biometric-pulse {
            animation: biometric-pulse 2s infinite;
        }
        
        @keyframes biometric-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
        }
        
        .biometric-icon {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: white;
        }
        
        .biometric-btn {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .biometric-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .biometric-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .biometric-status-available {
            color: #10B981;
        }
        
        .biometric-status-unavailable {
            color: #EF4444;
        }

        .face-id-icon {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
        }
        
        .touch-id-icon {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
        }

        /* Biometric prompt modal */
        .biometric-prompt-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .biometric-prompt-card {
            background: white;
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 340px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .dark .biometric-prompt-card {
            background: #1E293B;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .biometric-prompt-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: biometric-pulse 2s infinite;
        }

        .biometric-prompt-title {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }

        .dark .biometric-prompt-title {
            color: #f1f5f9;
        }

        .biometric-prompt-subtitle {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 28px;
            line-height: 1.5;
        }

        .dark .biometric-prompt-subtitle {
            color: #9ca3af;
        }

        .biometric-prompt-btn {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .biometric-prompt-btn.primary {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
        }

        .biometric-prompt-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(139, 92, 246, 0.4);
        }

        .biometric-prompt-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .dark .biometric-prompt-btn.secondary {
            background: #374151;
            color: #d1d5db;
        }

        .biometric-prompt-btn.secondary:hover {
            background: #e5e7eb;
        }

        /* Auto-login loading screen - ENHANCED FOR IMMEDIATE AUTH */
        .auto-login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.3s ease;
        }

        .auto-login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .auto-login-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 24px;
            animation: biometric-pulse 2s infinite;
        }

        .auto-login-text {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .auto-login-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        .auto-login-fallback {
            margin-top: 32px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auto-login-fallback:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Quick auth button for immediate biometric trigger */
        .quick-auth-btn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            color: #7C3AED;
            padding: 16px 32px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 201;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .quick-auth-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        .quick-auth-btn i {
            font-size: 20px;
        }
    </style>
    <!-- THEME INITIALIZATION SCRIPT - Runs immediately before page renders -->
    <script>
        (function() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
<base target="_blank">
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-800 dark:text-gray-100 transition-colors duration-300 min-h-screen pb-20">

    <!-- Auto Login Screen (shown when attempting biometric auth on launch) -->
    <div id="auto-login-screen" class="auto-login-screen hidden">
        <div class="auto-login-icon" id="auto-login-icon">
            <i class="fas fa-fingerprint"></i>
        </div>
        <div class="auto-login-text" id="auto-login-text">Authenticating...</div>
        <div class="auto-login-subtext" id="auto-login-subtext">Touch ID / Face ID</div>
        <button class="auto-login-fallback" onclick="cancelAutoLogin()">
            Use PIN Instead
        </button>
    </div>

    <!-- Quick Auth Button (appears when auto-login is available but needs user gesture) -->
    <button id="quick-auth-btn" class="quick-auth-btn hidden" onclick="triggerQuickAuth()">
        <i class="fas fa-fingerprint"></i>
        <span id="quick-auth-text">Tap to unlock with Face ID</span>
    </button>

    <!-- Biometric Setup Prompt (shown after account creation) -->
    <div id="biometric-setup-prompt" class="biometric-prompt-overlay hidden">
        <div class="biometric-prompt-card">
            <div class="biometric-prompt-icon biometric-icon">
                <i class="fas fa-fingerprint"></i>
            </div>
            <h2 class="biometric-prompt-title">Enable Face ID?</h2>
            <p class="biometric-prompt-subtitle">
                Use Face ID or Touch ID for faster, more secure access to your timesheets. You can always change this in settings.
            </p>
            <button class="biometric-prompt-btn primary" onclick="enableBiometricFromPrompt()">
                <i class="fas fa-fingerprint"></i>
                Enable Face ID
            </button>
            <button class="biometric-prompt-btn secondary" onclick="skipBiometricSetup()">
                Not Now
            </button>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-white dark:bg-dark flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shadow-blue-500/30 mx-auto mb-4">
                    <i class="fas fa-truck"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Driver Timesheet Pro</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center justify-center gap-2">
                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded" id="version-display">v5.3.0</span>
                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Face ID Ready</span>
                </p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Driver</label>
                    <select id="user-select" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                
                <div id="pin-section" class="hidden">
                    <input type="password" id="pin-input" maxlength="4" inputmode="numeric" 
                        class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest" 
                        placeholder="••••">
                </div>

                <button onclick="loginWithPin()" id="login-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95">
                    Login with PIN
                </button>

                <!-- Biometric Quick Login Button (shown when biometric is available) -->
                <button id="biometric-quick-login-btn" onclick="triggerBiometricFromLogin()" class="hidden w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-4 rounded-xl shadow-lg shadow-purple-500/30 transition-all transform active:scale-95">
                    <i class="fas fa-fingerprint mr-2"></i>
                    <span id="biometric-login-text">Login with Face ID</span>
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-dark text-gray-500">Admin Only</span></div>
                </div>

                <button onclick="showCreateUser()" class="w-full border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-4 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-card transition-all">
                    <i class="fas fa-user-plus mr-2"></i>Create New Driver
                </button>
            </div>

            <!-- Create User Form -->
            <div id="create-user-form" class="hidden space-y-4">
                <h2 class="text-xl font-bold text-center mb-4 text-gray-900 dark:text-white">Create New Driver</h2>
                
                <input type="text" id="new-username" placeholder="Driver Name" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-gray-900 dark:text-white">
                
                <input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="Create 4-digit PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest text-gray-900 dark:text-white">
                
                <input type="password" id="confirm-pin" maxlength="4" inputmode="numeric" placeholder="Confirm PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest text-gray-900 dark:text-white">
                
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                    <label class="block text-sm font-medium text-blue-900 dark:text-blue-300 mb-2">
                        <i class="fas fa-brain mr-2"></i>Gemini AI OCR + Document Storage
                    </label>
                    <p class="text-xs text-blue-700 dark:text-blue-400">Uses Google Gemini 2.0 Flash for timesheets. Additional documents stored securely in IndexedDB.</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="hideCreateUser()" class="flex-1 py-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-dark-card transition-all">Cancel</button>
                    <button onclick="createUser()" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-dark-card shadow-sm sticky top-0 z-40">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                        <i class="fas fa-truck text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight" id="header-username">Driver</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="sync-status"><i class="fas fa-database text-green-500"></i> IndexedDB Storage</p>
                    </div>
                </div>
                <button onclick="switchView('settings')" class="touch-btn flex items-center justify-center text-gray-500 hover:text-primary transition-colors">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </header>

        <main class="px-4 py-4 max-w-lg mx-auto">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section fade-in space-y-4">
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="changeMonth(-1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400"></i>
                        </button>
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white" id="calendar-month-year">February 2024</h2>
                        <button onclick="changeMonth(1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">M</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">W</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">F</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                    </div>
                    
                    <div id="calendar-grid" class="calendar-grid"></div>
                    
                    <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-500 dark:text-gray-400 flex-wrap">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-green-500"></div><span>Timesheet</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-purple-500"></div><span>Documents</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-orange-500"></div><span>VOR</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-gradient-to-r from-green-500 to-purple-500"></div><span>Both</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-primary ring-2 ring-primary ring-offset-2"></div><span>Today</span></div>
                    </div>
                </div>

                <div id="week-preview" class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 dark:text-white" id="preview-week-range">Week of Feb 5-11</h3>
                        <span class="text-sm font-bold text-primary" id="preview-total-hours">60h</span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="preview-days"></div>
                    
                    <!-- Document indicators -->
                    <div id="preview-documents" class="flex gap-2 mt-3 mb-3 hidden">
                        <div class="flex items-center gap-2 text-xs text-purple-600 bg-purple-50 dark:bg-purple-900/20 px-3 py-1.5 rounded-full">
                            <i class="fas fa-paperclip"></i>
                            <span id="preview-doc-count">3 docs attached</span>
                        </div>
                    </div>
                    
                    <button onclick="openSelectedWeek()" class="w-full mt-3 py-3 bg-primary/10 dark:bg-primary/20 text-primary font-semibold rounded-xl hover:bg-primary/20 transition-colors">
                        View Full Details
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">This Month</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-month-hours">0h</p>
                    </div>
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700" id="storage-widget">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Storage Used</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-storage-used">0 MB</p>
                        <div class="storage-bar">
                            <div class="storage-fill" id="storage-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Uploads</h3>
                    <div id="recent-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Scan View -->
            <div id="scan-view" class="view-section hidden fade-in space-y-4">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Scan Timesheet & Docs</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Timesheet required • Additional docs optional</p>
                </div>

                <!-- API Key Warning -->
                <div id="api-key-warning" class="hidden bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-4 border border-amber-200 dark:border-amber-800">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-key text-amber-600"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-amber-800 dark:text-amber-300">Gemini API Key Required</p>
                            <p class="text-xs text-amber-700 dark:text-amber-400">Add your API key in Settings to enable AI scanning</p>
                        </div>
                        <button onclick="showGeminiKeyModal()" class="px-3 py-1 bg-amber-600 text-white rounded-lg text-xs font-medium">Add Key</button>
                    </div>
                </div>

                <!-- Week Ending Date -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Week Ending Date (Saturday) 
                        <span id="auto-detected-badge" class="hidden ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <input type="date" id="scan-date-select" class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-primary outline-none text-gray-900 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="selected-week-info">Week ending auto-detected from timesheet</p>
                </div>

                <!-- Timesheet Upload (OCR - MANDATORY) -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                            <i class="fas fa-clock text-primary"></i>
                            Timesheet <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold">REQUIRED</span>
                        </h3>
                        <span class="text-xs text-red-500 font-medium" id="front-status">Required</span>
                    </div>
                    <div class="upload-zone rounded-xl p-6 text-center cursor-pointer relative overflow-hidden bg-gray-50 dark:bg-dark-surface image-preview-container" id="timesheet-upload-zone"
                         onclick="document.getElementById('file-front').click()"
                         ondrop="handleDrop(event, 'front')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="file-front" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'front')">
                        <div id="upload-front-default">
                            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Tap to take timesheet photo</p>
                            <p class="text-xs text-gray-400 mt-1">This is required for processing</p>
                        </div>
                        <img id="preview-front" class="hidden w-full h-48 object-cover rounded-lg mx-auto">
                        <div id="image-processing-indicator" class="image-processing-overlay hidden">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Processing...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Documents (No OCR) - FIXED WITH SMALLER BUTTONS AT BOTTOM -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                            <i class="fas fa-file-alt text-purple-500"></i>
                            Additional Documents
                        </h3>
                        <span class="text-xs text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full font-medium" id="doc-count-badge">0/3</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Tap to add. Documents save without AI processing.</p>
                    
                    <div class="doc-upload-grid">
                        <!-- Timesheet Front -->
                        <div class="doc-upload-item" id="doc-1-item" onclick="handleDocItemClick(1)">
                            <input type="file" id="file-doc-1" class="hidden" accept="image/*,application/pdf" onchange="handleDocSelect(event, 1)">
                            <i class="fas fa-file-image text-gray-400" id="doc-1-icon"></i>
                            <span class="doc-label text-gray-600 dark:text-gray-300">Timesheet<br>Front</span>
                            <span class="doc-status" id="doc-1-status">Add</span>
                            <img id="doc-1-preview" class="doc-preview-thumb hidden">
                            
                            <!-- Action buttons at bottom - SMALLER -->
                            <div class="doc-actions-bar" id="doc-1-actions" style="display: none;">
                                <button class="doc-action-btn view-btn" onclick="event.stopPropagation(); viewDoc(1)" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="doc-action-btn share-btn" onclick="event.stopPropagation(); shareDoc(1)" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="doc-action-btn delete-btn" onclick="event.stopPropagation(); removeDoc(1)" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Fuel And Expense -->
                        <div class="doc-upload-item" id="doc-2-item" onclick="handleDocItemClick(2)">
                            <input type="file" id="file-doc-2" class="hidden" accept="image/*,application/pdf" onchange="handleDocSelect(event, 2)">
                            <i class="fas fa-gas-pump text-gray-400" id="doc-2-icon"></i>
                            <span class="doc-label text-gray-600 dark:text-gray-300">Fuel &<br>Expense</span>
                            <span class="doc-status" id="doc-2-status">Add</span>
                            <img id="doc-2-preview" class="doc-preview-thumb hidden">
                            
                            <!-- Action buttons at bottom - SMALLER -->
                            <div class="doc-actions-bar" id="doc-2-actions" style="display: none;">
                                <button class="doc-action-btn view-btn" onclick="event.stopPropagation(); viewDoc(2)" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="doc-action-btn share-btn" onclick="event.stopPropagation(); shareDoc(2)" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="doc-action-btn delete-btn" onclick="event.stopPropagation(); removeDoc(2)" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Circle Check Sheets -->
                        <div class="doc-upload-item" id="doc-3-item" onclick="handleDocItemClick(3)">
                            <input type="file" id="file-doc-3" class="hidden" accept="image/*,application/pdf" onchange="handleDocSelect(event, 3)">
                            <i class="fas fa-clipboard-check text-gray-400" id="doc-3-icon"></i>
                            <span class="doc-label text-gray-600 dark:text-gray-300">Circle Check<br>Sheets</span>
                            <span class="doc-status" id="doc-3-status">Add</span>
                            <img id="doc-3-preview" class="doc-preview-thumb hidden">
                            
                            <!-- Action buttons at bottom - SMALLER -->
                            <div class="doc-actions-bar" id="doc-3-actions" style="display: none;">
                                <button class="doc-action-btn view-btn" onclick="event.stopPropagation(); viewDoc(3)" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="doc-action-btn share-btn" onclick="event.stopPropagation(); shareDoc(3)" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="doc-action-btn delete-btn" onclick="event.stopPropagation(); removeDoc(3)" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="ocr-error" class="hidden bg-red-50 dark:bg-red-900/20 rounded-2xl p-4 border border-red-200 dark:border-red-800">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-red-800 dark:text-red-300">Extraction Failed</p>
                            <p class="text-xs text-red-600 dark:text-red-400" id="error-message">Please try again or enter manually</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="toggleDebugInfo()" class="text-xs text-red-600 underline mb-2">
                            <i class="fas fa-bug mr-1"></i>Show Debug Info
                        </button>
                        <div id="ocr-debug-info" class="ocr-debug-info hidden"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="retryOCR()" class="py-2 bg-red-100 dark:bg-red-900/30 text-red-700 rounded-lg text-sm font-medium">
                            <i class="fas fa-redo mr-1"></i>Retry
                        </button>
                        <button onclick="showManualEntryFallback()" class="py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 rounded-lg text-sm font-medium manual-entry-btn text-white">
                            <i class="fas fa-edit mr-1"></i>Manual Entry
                        </button>
                    </div>
                </div>

                <!-- OCR Progress -->
                <div id="ocr-progress" class="hidden bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="ocr-status-text">Initializing...</span>
                        <span class="text-sm text-primary" id="ocr-percentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-surface rounded-full h-2 overflow-hidden">
                        <div id="ocr-progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300 progress-bar-animated" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                        <i class="fas fa-circle-notch fa-spin" id="ocr-spinner"></i>
                        <span id="ocr-stage">Preparing image...</span>
                    </div>
                </div>

                <!-- Auto-Detection Results -->
                <div id="auto-results" class="hidden space-y-4">
                    
                    <!-- Detection Summary -->
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-2xl p-4 border border-green-200 dark:border-green-800">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-green-800 dark:text-green-300">
                                <i class="fas fa-check-circle mr-2"></i>Detection Complete
                            </h3>
                            <span class="text-xs bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full" id="confidence-badge">High Confidence</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Week Ending:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-week-ending">14 Feb 2026</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Working Days:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-working-days">3 days</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Shifts:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-shifts">6 shifts</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Total Hours:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-hours">~38h</span>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Grid -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Detected Schedule</h3>
                        <div class="extraction-grid relative" id="detection-grid"></div>
                        <div class="flex gap-4 mt-3 text-xs justify-center">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-400 rounded"></div><span>ON Time</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-400 rounded"></div><span>OFF Time</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-400 rounded"></div><span>Both</span></div>
                        </div>
                    </div>

                    <!-- Time Correction Table -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-900 dark:text-white text-sm">Review & Correct Times</h3>
                            <button onclick="resetToAuto()" class="text-xs text-primary hover:underline">Reset to Auto</button>
                        </div>
                        <div id="correction-table" class="space-y-2"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="reprocessImage()" class="flex-1 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-50 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-redo mr-2"></i>Re-scan
                        </button>
                        <button onclick="confirmAndSave()" class="flex-1 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save All
                        </button>
                    </div>
                </div>

                <button onclick="startOCR()" id="scan-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    <i class="fas fa-magic mr-2"></i>Auto-Extract Times
                </button>
            </div>

            <!-- VOR Scan View -->
            <div id="vor-view" class="view-section hidden fade-in space-y-4">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center justify-center gap-2">
                        <i class="fas fa-exclamation-triangle text-orange-500"></i>
                        VOR Defect Report
                    </h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Vehicle Off Road - Report defects</p>
                </div>

                <!-- API Key Warning -->
                <div id="vor-api-key-warning" class="hidden bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-4 border border-amber-200 dark:border-amber-800">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-key text-amber-600"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-amber-800 dark:text-amber-300">Gemini API Key Required</p>
                            <p class="text-xs text-amber-700 dark:text-amber-400">Add your API key in Settings to enable AI scanning</p>
                        </div>
                        <button onclick="showGeminiKeyModal()" class="px-3 py-1 bg-amber-600 text-white rounded-lg text-xs font-medium">Add Key</button>
                    </div>
                </div>

                <!-- Date -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Date of Defect
                        <span id="vor-auto-detected-badge" class="hidden ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <input type="date" id="vor-date-select" class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-orange-500 outline-none text-gray-900 dark:text-white">
                </div>

                <!-- Defect Number -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Defect Number
                        <span id="vor-defect-number-badge" class="hidden ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <input type="text" id="vor-defect-number" placeholder="e.g., 092018" 
                        class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-orange-500 outline-none font-mono text-lg text-gray-900 dark:text-white">
                </div>

                <!-- Reg/Trailer Number -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Reg/Trailer Number
                        <span id="vor-reg-badge" class="hidden ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <input type="text" id="vor-reg-number" placeholder="e.g., WU69 XDY" 
                        class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-orange-500 outline-none font-mono text-lg uppercase text-gray-900 dark:text-white">
                </div>

                <!-- Time -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Time
                        <span id="vor-time-badge" class="hidden ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <input type="time" id="vor-time" 
                        class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-orange-500 outline-none text-gray-900 dark:text-white">
                </div>

                <!-- Nature of Defect -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Nature of Defect
                        <span id="vor-nature-badge" class="hidden ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Auto-detected
                        </span>
                    </label>
                    <textarea id="vor-nature" rows="3" placeholder="Describe the defect..." 
                        class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-orange-500 outline-none resize-none text-gray-900 dark:text-white"></textarea>
                </div>

                <!-- Main VOR Photo (Required) -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-orange-500"></i>
                            Defect Photo <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold">REQUIRED</span>
                        </h3>
                        <span class="text-xs text-red-500 font-medium" id="vor-photo-status">Required</span>
                    </div>
                    <div class="upload-zone vor-zone rounded-xl p-6 text-center cursor-pointer relative overflow-hidden bg-gray-50 dark:bg-dark-surface image-preview-container" id="vor-upload-zone"
                         onclick="document.getElementById('vor-file-main').click()"
                         ondrop="handleVORDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="vor-file-main" class="hidden" accept="image/*" capture="environment" onchange="handleVORFileSelect(event)">
                        <div id="vor-upload-default">
                            <i class="fas fa-camera text-3xl text-orange-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Tap to take defect photo</p>
                            <p class="text-xs text-gray-400 mt-1">This is required for processing</p>
                        </div>
                        <img id="vor-preview-main" class="hidden w-full h-48 object-cover rounded-lg mx-auto">
                        <div id="vor-processing-indicator" class="image-processing-overlay hidden">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Processing...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Photo (Optional) -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white flex items-center gap-2">
                            <i class="fas fa-image text-gray-400"></i>
                            Additional Photo <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-medium">OPTIONAL</span>
                        </h3>
                        <span class="text-xs text-gray-400 font-medium" id="vor-additional-status">Optional</span>
                    </div>
                    <div class="upload-zone rounded-xl p-6 text-center cursor-pointer relative overflow-hidden bg-gray-50 dark:bg-dark-surface image-preview-container" id="vor-additional-zone"
                         onclick="document.getElementById('vor-file-additional').click()">
                        <input type="file" id="vor-file-additional" class="hidden" accept="image/*" capture="environment" onchange="handleVORAdditionalSelect(event)">
                        <div id="vor-additional-default">
                            <i class="fas fa-plus-circle text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Tap to add optional photo</p>
                        </div>
                        <img id="vor-preview-additional" class="hidden w-full h-48 object-cover rounded-lg mx-auto">
                    </div>
                </div>

                <!-- VOR OCR Error -->
                <div id="vor-ocr-error" class="hidden bg-red-50 dark:bg-red-900/20 rounded-2xl p-4 border border-red-200 dark:border-red-800">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-red-800 dark:text-red-300">Extraction Failed</p>
                            <p class="text-xs text-red-600 dark:text-red-400" id="vor-error-message">Please try again or enter manually</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="retryVOROCR()" class="py-2 bg-red-100 dark:bg-red-900/30 text-red-700 rounded-lg text-sm font-medium">
                            <i class="fas fa-redo mr-1"></i>Retry Scan
                        </button>
                        <button onclick="showVORManualEntry()" class="py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 rounded-lg text-sm font-medium">
                            <i class="fas fa-edit mr-1"></i>Manual Entry
                        </button>
                    </div>
                </div>

                <!-- VOR OCR Progress -->
                <div id="vor-ocr-progress" class="hidden bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="vor-ocr-status-text">Initializing...</span>
                        <span class="text-sm text-orange-500" id="vor-ocr-percentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-surface rounded-full h-2 overflow-hidden">
                        <div id="vor-ocr-progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-300 progress-bar-animated" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                        <i class="fas fa-circle-notch fa-spin" id="vor-ocr-spinner"></i>
                        <span id="vor-ocr-stage">Preparing image...</span>
                    </div>
                </div>

                <!-- VOR Auto Results -->
                <div id="vor-auto-results" class="hidden space-y-4">
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-2xl p-4 border border-orange-200 dark:border-orange-800">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-orange-800 dark:text-orange-300">
                                <i class="fas fa-check-circle mr-2"></i>Defect Detected
                            </h3>
                            <span class="text-xs bg-orange-200 dark:bg-orange-800 text-orange-800 dark:text-orange-200 px-2 py-1 rounded-full" id="vor-confidence-badge">High Confidence</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Defect Number:</span>
                                <span class="font-bold text-gray-900 dark:text-white font-mono" id="vor-result-defect-number">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Date:</span>
                                <span class="font-bold text-gray-900 dark:text-white" id="vor-result-date">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Time:</span>
                                <span class="font-bold text-gray-900 dark:text-white" id="vor-result-time">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500 dark:text-gray-400">Reg/Trailer:</span>
                                <span class="font-bold text-gray-900 dark:text-white font-mono" id="vor-result-reg">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="startVOROCR()" id="vor-scan-btn" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-500/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Scan Defect Report
                </button>

                <button onclick="saveVORReport()" id="vor-save-btn" class="hidden w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-500/30 transition-all transform active:scale-95 mt-4">
                    <i class="fas fa-save mr-2"></i>Save VOR Report
                </button>
            </div>

            <!-- History View -->
            <div id="history-view" class="view-section hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">All Records</h2>
                    <button onclick="showArchiveView()" class="text-sm text-primary hover:underline">
                        <i class="fas fa-archive mr-1"></i>View Archive
                    </button>
                </div>
                
                <!-- Defect Number Search - UPDATED LABEL -->
                <div class="defect-number-search rounded-2xl p-4 mb-4">
                    <label class="block text-sm font-medium text-amber-800 dark:text-amber-300 mb-2">
                        <i class="fas fa-search mr-2"></i>Search Defect # or Reg/Trailer
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="defect-search-input" placeholder="Enter defect number or reg..." 
                            class="flex-1 p-3 bg-white dark:bg-dark-surface rounded-xl border-2 border-amber-300 dark:border-amber-700 focus:border-amber-500 outline-none font-mono text-gray-900 dark:text-white">
                        <button onclick="searchDefectNumber()" class="px-4 py-2 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition-colors">
                            <i class="fas fa-search"></i>
                        </button>
                        <button onclick="clearDefectSearch()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-300 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-xs text-amber-700 dark:text-amber-400 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>Searches both defect numbers and registration/trailer numbers
                    </p>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterHistory('all')" class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm font-medium whitespace-nowrap" data-filter="all">All</button>
                    <button onclick="filterHistory('month')" class="filter-btn px-4 py-2 rounded-full bg-gray-200 dark:bg-dark-surface text-gray-700 dark:text-gray-300 text-sm font-medium whitespace-nowrap" data-filter="month">This Month</button>
                    <button onclick="filterHistory('year')" class="filter-btn px-4 py-2 rounded-full bg-gray-200 dark:bg-dark-surface text-gray-700 dark:text-gray-300 text-sm font-medium whitespace-nowrap" data-filter="year">This Year</button>
                </div>

                <!-- Timesheets Section -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                        <i class="fas fa-calendar-week text-primary"></i>
                        Timesheets
                    </h3>
                    <div id="history-list" class="space-y-3"></div>
                </div>

                <!-- VOR Reports Section -->
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-orange-500"></i>
                        VOR Defect Reports
                    </h3>
                    <div id="vor-history-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Archive View -->
            <div id="archive-view" class="view-section hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Archived Weeks</h2>
                    <button onclick="switchView('history')" class="text-sm text-primary hover:underline">
                        <i class="fas fa-arrow-left mr-1"></i>Back to Active
                    </button>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Archived weeks are stored locally but hidden from main views to improve performance.</p>
                <div id="archive-list" class="space-y-3"></div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-section hidden fade-in space-y-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Settings</h2>

                <!-- Biometric Authentication Settings -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-fingerprint text-biometric mr-2"></i>Biometric Authentication
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-dark-surface rounded-xl">
                            <div class="flex items-center gap-3">
                                <div id="biometric-icon-status" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                    <i class="fas fa-fingerprint text-gray-500"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900 dark:text-white text-sm" id="biometric-setting-title">Face ID / Touch ID</p>
                                    <p class="text-xs text-gray-500" id="biometric-setting-status">Checking availability...</p>
                                </div>
                            </div>
                            <div class="toggle-switch" id="biometric-toggle" onclick="toggleBiometricAuth()"></div>
                        </div>

                        <div id="biometric-info-box" class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800 hidden">
                            <p class="text-xs text-purple-700 dark:text-purple-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span id="biometric-info-text">Enable to login with Face ID or Touch ID on this device.</span>
                            </p>
                        </div>

                        <button onclick="setupBiometricNow()" id="setup-biometric-btn" class="w-full py-3 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-xl font-medium hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors hidden">
                            <i class="fas fa-fingerprint mr-2"></i>Set Up Face ID / Touch ID
                        </button>
                    </div>
                </div>

                <!-- Storage Info -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-database text-primary mr-2"></i>Storage Status
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Used Space</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="storage-used">0 MB</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Available</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="storage-available">Unknown</span>
                        </div>
                        <div class="storage-bar">
                            <div class="storage-fill" id="settings-storage-bar" style="width: 0%"></div>
                        </div>
                        <button onclick="checkStorageQuota()" class="w-full py-2 bg-gray-100 dark:bg-dark-surface rounded-lg text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-200 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Storage Info
                        </button>
                    </div>
                </div>

                <!-- Dashboard Widget Toggle -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-toggle-on text-primary mr-2"></i>Dashboard Options
                    </h3>
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-dark-surface rounded-xl">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white text-sm">Show Storage Widget</p>
                            <p class="text-xs text-gray-500">Display storage usage on calendar page</p>
                        </div>
                        <div class="toggle-switch active" id="storage-widget-toggle" onclick="toggleStorageWidget()"></div>
                    </div>
                </div>

                <!-- Gemini API Settings -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-brain text-primary mr-2"></i>AI OCR Engine
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Gemini 2.0 Flash</p>
                                <p class="text-xs text-gray-500">Latest stable model</p>
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium" id="api-status-badge">
                                Not Configured
                            </span>
                        </div>

                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <p class="text-xs text-blue-700 dark:text-blue-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline font-medium">Google AI Studio</a>
                            </p>
                        </div>

                        <button onclick="showGeminiKeyModal()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <div class="text-left">
                                <p class="font-medium text-gray-900 dark:text-white" id="api-key-btn-text">Configure API Key</p>
                                <p class="text-xs text-gray-500" id="api-key-status">Required for AI scanning</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Appearance</h3>
                    <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                            <i class="fas fa-moon text-blue-400 hidden dark:block"></i>
                            <span class="font-medium text-gray-900 dark:text-white" id="theme-label">Dark Mode</span>
                        </div>
                        <div class="w-12 h-6 bg-gray-300 dark:bg-primary rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 dark:left-6 transition-all shadow-sm"></div>
                        </div>
                    </button>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-info-circle text-primary mr-2"></i>About</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <p><strong>Version:</strong> <span id="settings-version">v5.3.0 (Biometric Edition)</span></p>
                        <p><strong>OCR Engine:</strong> Google Gemini 2.0 Flash AI</p>
                        <p><strong>Storage:</strong> IndexedDB (Local Device)</p>
                        <p class="text-xs">Required timesheet OCR + 3 additional document uploads per week.</p>
                        <p class="text-xs text-orange-600">VOR Defect reporting with AI extraction.</p>
                        <p class="text-xs text-purple-600">Face ID / Touch ID biometric authentication.</p>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-database text-primary mr-2"></i>Data Management</h3>
                    
                    <div class="space-y-2">
                        <button onclick="showDeleteOptions('week')" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete Specific Week</p>
                                <p class="text-xs text-gray-500">Remove one week's data</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="showDeleteOptions('month')" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete Month</p>
                                <p class="text-xs text-gray-500">Remove all data for a month</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="showDeleteVOROptions()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete VOR Reports</p>
                                <p class="text-xs text-gray-500">Manage defect reports</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="manageArchives()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Manage Archives</p>
                                <p class="text-xs text-gray-500">View or restore archived weeks</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="deleteAllData()" class="w-full p-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors mt-2">
                            <i class="fas fa-trash-alt mr-2"></i>Delete All Timesheet Data
                        </button>
                    </div>
                </div>

                <!-- Logout Button -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-sign-out-alt text-primary mr-2"></i>Account</h3>
                    <button onclick="logout()" class="w-full p-4 bg-gray-100 dark:bg-dark-surface hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i>
                        Log Out
                    </button>
                </div>

                <!-- Account Deletion -->
                <div class="danger-zone rounded-2xl p-4">
                    <h3 class="font-semibold text-red-600 dark:text-red-400 mb-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i> Danger Zone
                    </h3>
                    <p class="text-sm text-red-600/80 dark:text-red-400/80 mb-4">
                        This will permanently delete your account, all stored data, and remove the app from this device.
                    </p>
                    <button onclick="showRemoveAccountConfirm()" class="w-full p-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-red-500/30 flex items-center justify-center gap-2">
                        <i class="fas fa-user-slash"></i>
                        Delete Account & All Data
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t border-gray-200 dark:border-gray-700 z-40">
            <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
                <button onclick="switchView('dashboard')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center active" data-view="dashboard">
                    <i class="fas fa-calendar-alt text-xl transition-transform"></i>
                    <span class="text-xs font-medium">Calendar</span>
                </button>
                <button onclick="switchView('scan')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="scan">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-500/30 -mt-6 border-4 border-gray-50 dark:border-dark">
                        <i class="fas fa-plus text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">Scan</span>
                </button>
                <button onclick="switchView('vor')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center vor-nav-item" data-view="vor">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white shadow-lg shadow-orange-500/30 -mt-6 border-4 border-gray-50 dark:border-dark">
                        <i class="fas fa-exclamation-triangle text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">VOR</span>
                </button>
                <button onclick="switchView('history')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="history">
                    <i class="fas fa-list text-xl transition-transform"></i>
                    <span class="text-xs font-medium">History</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- API Key Modal -->
    <div id="gemini-key-modal" class="fixed inset-0 z-[100] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card rounded-2xl p-6 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-key text-2xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Gemini API Key</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">
                    Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary underline">Google AI Studio</a>
                </p>
            </div>

            <div class="space-y-4">
                <div>
                    <input type="password" id="gemini-api-key-input" 
                        placeholder="Paste your API key here (starts with AIza...)" 
                        class="w-full p-4 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-primary outline-none text-sm font-mono text-gray-900 dark:text-white">
                </div>

                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 border border-yellow-200 dark:border-yellow-800">
                    <p class="text-xs text-yellow-700 dark:text-yellow-400">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Your key is stored locally on your device and never sent to our servers.
                    </p>
                </div>

                <button onclick="saveGeminiKey()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition-colors">
                    Save API Key
                </button>

                <button onclick="closeGeminiKeyModal()" class="w-full text-gray-500 py-2 text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Biometric Setup Modal (for settings) -->
    <div id="biometric-setup-modal" class="fixed inset-0 z-[100] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card rounded-2xl p-6 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-20 h-20 biometric-icon rounded-full flex items-center justify-center mx-auto mb-4 biometric-pulse">
                    <i class="fas fa-fingerprint text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Set Up Biometric Login</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">
                    Use Face ID, Touch ID, or fingerprint for faster, more secure login on this device.
                </p>
            </div>

            <div class="space-y-4">
                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 border border-purple-200 dark:border-purple-800">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-shield-alt text-purple-600"></i>
                        <span class="font-medium text-purple-900 dark:text-purple-300">Secure & Private</span>
                    </div>
                    <p class="text-xs text-purple-700 dark:text-purple-400">
                        Your biometric data never leaves this device. It's stored securely in your device's hardware security module.
                    </p>
                </div>

                <div class="bg-gray-50 dark:bg-dark-surface rounded-lg p-4">
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">You'll need to:</p>
                    <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                        <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Verify with your PIN first</li>
                        <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Scan your biometric</li>
                        <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Use it for future logins</li>
                    </ul>
                </div>

                <button onclick="startBiometricRegistration()" id="start-biometric-setup-btn" class="w-full biometric-btn font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-fingerprint"></i>
                    <span>Set Up Now</span>
                </button>

                <button onclick="closeBiometricSetupModal()" class="w-full text-gray-500 py-2 text-sm">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>

    <!-- Full Screen Image Viewer - UPDATED WITH CLICK TO CLOSE -->
    <div id="fullscreen-viewer" class="fullscreen-image-viewer hidden" onclick="handleViewerBackdropClick(event)">
        <div class="viewer-header">
            <button class="close-btn" onclick="closeFullscreenViewer(event)" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="viewer-content" onclick="handleViewerContentClick(event)">
            <img id="viewer-image" src="" alt="Document">
        </div>
        <div class="viewer-footer">
            <div class="filename-container">
                <div class="filename" id="viewer-filename">image.jpg</div>
                <div class="doc-type-label" id="viewer-doc-type">Timesheet Front</div>
            </div>
            <button class="share-btn-large" onclick="shareViewerDocument(event)" type="button">
                <i class="fas fa-share-alt"></i>
                Share
            </button>
        </div>
    </div>

    <!-- Share Fallback Modal -->
    <div id="share-fallback-modal" class="share-fallback-modal hidden" onclick="closeShareFallback(event)">
        <div class="share-fallback-content" onclick="event.stopPropagation()">
            <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-share-alt text-2xl text-blue-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Share Document</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" id="share-fallback-text">Your document is ready to share</p>
            <div class="space-y-2">
                <button onclick="downloadCurrentDocument()" class="w-full bg-primary text-white font-semibold py-3 rounded-xl">
                    <i class="fas fa-download mr-2"></i>Download File
                </button>
                <button onclick="closeShareFallback()" class="w-full text-gray-500 py-2 text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-md md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[80vh] overflow-y-auto">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="delete-modal-title">Delete Data</h3>
                    <button onclick="closeDeleteModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4" id="delete-options-content"></div>
            </div>
        </div>
    </div>

    <div id="remove-account-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card rounded-2xl p-6 max-w-sm w-full text-center border-2 border-red-500">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-red-600 mb-2">Delete Account?</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">This will permanently delete all your data including biometric credentials.</p>
            <button onclick="executeRemoveAccount()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl mb-2">
                Yes, Delete Everything
            </button>
            <button onclick="hideRemoveAccountModal()" class="w-full text-gray-500 py-2 text-sm">
                Cancel
            </button>
        </div>
    </div>

    <div id="final-removal-screen" class="fixed inset-0 z-[100] bg-red-600 hidden flex flex-col items-center justify-center p-6 text-white">
        <div class="text-center">
            <i class="fas fa-check-circle text-6xl mb-6 opacity-0" id="removal-check"></i>
            <h2 class="text-3xl font-bold mb-4 opacity-0" id="removal-title">Account Deleted</h2>
            <p class="text-white/80 mb-8 opacity-0" id="removal-text">All data has been permanently removed.</p>
        </div>
    </div>

    <div id="week-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeWeekModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-10">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="week-modal-title">Week Details</h3>
                    <button onclick="closeWeekModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4" id="week-modal-content"></div>
            </div>
        </div>
    </div>

    <!-- VOR Detail Modal -->
    <div id="vor-detail-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeVORDetailModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-10">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-orange-500"></i>
                        VOR Defect Report
                    </h3>
                    <button onclick="closeVORDetailModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4" id="vor-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-xl shadow-lg transform -translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 max-w-md">
        <i id="toast-icon" class="fas fa-check-circle text-green-400 dark:text-green-600"></i>
        <span id="toast-message" class="font-medium text-sm">Operation successful</span>
    </div>

    <script>
        // ==================== CONFIG ====================
        const APP_VERSION = '5.3.0';
        const GEMINI_MODEL = 'gemini-2.0-flash';
        
        let currentUser = null;
        let currentMonth = new Date();
        let selectedWeekStart = null;
        let currentImage = null;
        let processedImage = null;
        let imageDB = null;
        let autoDetectedData = null;
        let autoDetectedWeekEnding = null;
        let ocrAttempts = 0;
        let lastOcrResult = null;
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        let showStorageWidget = localStorage.getItem('showStorageWidget') !== 'false';
        
        // Document storage (no OCR)
        let currentDocs = {
            1: null,
            2: null,
            3: null
        };

        // VOR State
        let vorCurrentImage = null;
        let vorProcessedImage = null;
        let vorAdditionalImage = null;
        let vorAutoDetectedData = null;

        // Biometric State - ENHANCED
        let biometricAvailable = false;
        let biometricEnabled = false;
        let pendingBiometricRegistration = false;
        let tempUserForBiometric = null;
        let lastLoggedInUser = localStorage.getItem('lastLoggedInUser') || null;
        let autoLoginAttempted = false;
        let biometricCredentialId = null; // Store the credential ID for faster auth

        const DOC_NAMES = {
            1: 'Timesheet Front',
            2: 'Fuel & Expense',
            3: 'Circle Check'
        };

        const DOC_ICONS = {
            1: 'fa-file-image',
            2: 'fa-gas-pump',
            3: 'fa-clipboard-check'
        };

        // Current viewer state
        let currentViewerDoc = null;
        let currentTimesheetForShare = null;

        // ==================== ENHANCED BIOMETRIC AUTHENTICATION ====================
        
        // Check if biometric authentication is available with better detection
        async function checkBiometricAvailability() {
            if (!window.PublicKeyCredential) {
                console.log('WebAuthn not supported');
                return false;
            }

            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                console.log('Biometric available:', available);
                
                // Also check if we can use conditional mediation
                if (available && 'PublicKeyCredential' in window) {
                    // Try to check for conditional UI support
                    const conditionalSupported = await PublicKeyCredential.isConditionalMediationAvailable?.() || false;
                    console.log('Conditional mediation available:', conditionalSupported);
                }
                
                return available;
            } catch (e) {
                console.error('Error checking biometric availability:', e);
                return false;
            }
        }

        // Get device info for better UX
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isApple = /iPad|iPhone|iPod|Macintosh/.test(ua) && !window.MSStream;
            const hasFaceID = isApple && /iPhone|iPad/.test(ua) && !/iPod/.test(ua);
            const hasTouchID = isApple && (/Macintosh/.test(ua) || /iPhone|iPad|iPod/.test(ua));
            
            return {
                isApple,
                hasFaceID,
                hasTouchID,
                isIOS: /iPad|iPhone|iPod/.test(ua),
                platform: isApple ? (hasFaceID ? 'Face ID' : 'Touch ID') : 'Biometric'
            };
        }

        // Get biometric credentials for user
        async function getBiometricCredentials(username) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction(['biometricCredentials'], 'readonly');
                const store = transaction.objectStore('biometricCredentials');
                const request = store.get(`biometric_${username}`);
                request.onsuccess = () => {
                    const result = request.result;
                    if (result) {
                        biometricCredentialId = result.credentialId;
                    }
                    resolve(result || null);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Save biometric credential with metadata
        async function saveBiometricCredential(username, credential) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const deviceInfo = getDeviceInfo();
                const transaction = imageDB.transaction(['biometricCredentials'], 'readwrite');
                const store = transaction.objectStore('biometricCredentials');
                const request = store.put({
                    id: `biometric_${username}`,
                    username: username,
                    credentialId: credential.id,
                    rawId: Array.from(new Uint8Array(credential.rawId)),
                    type: credential.type,
                    deviceType: deviceInfo.platform,
                    createdAt: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                });
                request.onsuccess = () => {
                    biometricCredentialId = credential.id;
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Delete biometric credential
        async function deleteBiometricCredential(username) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction(['biometricCredentials'], 'readwrite');
                const store = transaction.objectStore('biometricCredentials');
                const request = store.delete(`biometric_${username}`);
                request.onsuccess = () => {
                    biometricCredentialId = null;
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // ENHANCED: Register biometric with better options for automatic auth
        async function registerBiometric(username) {
            try {
                const deviceInfo = getDeviceInfo();
                
                // Create challenge
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                // Create user ID from username (must be stable)
                const userId = new TextEncoder().encode(username);

                // Enhanced options for better UX
                const publicKeyCredentialCreationOptions = {
                    challenge: challenge,
                    rp: {
                        name: 'Driver Timesheet Pro',
                        id: window.location.hostname
                    },
                    user: {
                        id: userId,
                        name: username,
                        displayName: username
                    },
                    pubKeyCredParams: [
                        { alg: -7, type: 'public-key' },   // ES256 (widely supported)
                        { alg: -257, type: 'public-key' }  // RS256 (fallback)
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: 'platform', // Use built-in sensor (Face ID/Touch ID)
                        userVerification: 'required',        // Always require biometric
                        residentKey: 'required',             // Store credential on device for automatic use
                        requireResidentKey: true
                    },
                    attestation: 'none',
                    extensions: {
                        credProps: true
                    }
                };

                console.log('Creating credential with options:', publicKeyCredentialCreationOptions);
                
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                if (!credential) {
                    throw new Error('Biometric registration cancelled');
                }

                console.log('Credential created:', credential.id);
                
                // Save credential info
                await saveBiometricCredential(username, credential);
                
                return true;
            } catch (error) {
                console.error('Biometric registration error:', error);
                throw error;
            }
        }

        // ENHANCED: Authenticate with biometric - optimized for automatic login
        async function authenticateWithBiometric(username, isAutoLogin = false) {
            try {
                const storedCred = await getBiometricCredentials(username);
                if (!storedCred) {
                    throw new Error('No biometric credential found');
                }

                // Create challenge
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                // Build allowCredentials with the stored credential ID
                const allowCredentials = [{
                    id: new Uint8Array(storedCred.rawId),
                    type: 'public-key',
                    transports: ['internal'] // Platform authenticator only
                }];

                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: allowCredentials,
                    userVerification: 'required',
                    rpId: window.location.hostname,
                    // For auto-login, we want to be more aggressive about using the credential
                    ...(isAutoLogin && {
                        // These hints help the browser understand we want immediate auth
                        hints: ['hybrid'] // Prefer platform authenticator
                    })
                };

                console.log('Authenticating with options:', publicKeyCredentialRequestOptions);

                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                if (!assertion) {
                    throw new Error('Biometric authentication cancelled');
                }

                // Update last used timestamp
                await updateCredentialLastUsed(username);
                
                return true;
            } catch (error) {
                console.error('Biometric authentication error:', error);
                throw error;
            }
        }

        // Update last used timestamp
        async function updateCredentialLastUsed(username) {
            if (!imageDB) return;
            try {
                const cred = await getBiometricCredentials(username);
                if (cred) {
                    const transaction = imageDB.transaction(['biometricCredentials'], 'readwrite');
                    const store = transaction.objectStore('biometricCredentials');
                    cred.lastUsed = new Date().toISOString();
                    await store.put(cred);
                }
            } catch (e) {
                console.log('Failed to update last used:', e);
            }
        }

        // ==================== ENHANCED AUTO LOGIN ====================
        
        async function attemptAutoLogin() {
            // Prevent multiple attempts
            if (autoLoginAttempted) return;
            autoLoginAttempted = true;
            
            const users = DB_LS.getUsers();
            
            // If no users exist, show normal auth screen
            if (users.length === 0) {
                return;
            }

            // Check if we have a last logged in user with biometric enabled
            if (!lastLoggedInUser) {
                // If only one user exists, try that one
                if (users.length === 1) {
                    lastLoggedInUser = users[0].username;
                } else {
                    // Multiple users, no last known - show normal login with biometric option
                    updateBiometricLoginButton();
                    return;
                }
            }

            // Check if this user has biometric enabled
            const hasBiometric = localStorage.getItem(`biometric_${lastLoggedInUser}`) === 'true';
            const storedCred = await getBiometricCredentials(lastLoggedInUser);
            
            if (!hasBiometric || !storedCred) {
                // Biometric not set up for this user - show biometric login button if available
                updateBiometricLoginButton();
                return;
            }

            // Check if biometric hardware is available
            const available = await checkBiometricAvailability();
            if (!available) {
                updateBiometricLoginButton();
                return;
            }

            // Show auto-login screen
            showAutoLoginScreen(lastLoggedInUser);
            
            // Small delay to let the UI render
            await new Promise(r => setTimeout(r, 300));
            
            try {
                // Attempt automatic authentication
                await authenticateWithBiometric(lastLoggedInUser, true);
                
                // Success! Get user data and login
                const user = users.find(u => u.username === lastLoggedInUser);
                if (user) {
                    hideAutoLoginScreen();
                    completeLogin(user, true);
                    return;
                }
            } catch (error) {
                console.log('Auto-login failed:', error);
                
                // Check if this is a user cancellation or system error
                if (error.name === 'NotAllowedError' || error.message.includes('cancelled')) {
                    // User cancelled - show fallback options
                    showQuickAuthButton(lastLoggedInUser);
                } else if (error.message.includes('No biometric credential')) {
                    // Credential lost - clear it
                    localStorage.removeItem(`biometric_${lastLoggedInUser}`);
                    hideAutoLoginScreen();
                    showToast('Biometric credential expired. Please use PIN.', 'error');
                } else {
                    // Other error - show fallback
                    showQuickAuthButton(lastLoggedInUser);
                }
            }
        }

        function showAutoLoginScreen(username) {
            const screen = document.getElementById('auto-login-screen');
            const text = document.getElementById('auto-login-text');
            const subtext = document.getElementById('auto-login-subtext');
            const icon = document.getElementById('auto-login-icon');
            
            const deviceInfo = getDeviceInfo();
            
            text.textContent = `Welcome, ${username}`;
            subtext.textContent = deviceInfo.hasFaceID ? 'Use Face ID to unlock' : 'Use Touch ID to unlock';
            
            // Update icon based on device
            if (deviceInfo.hasFaceID) {
                icon.innerHTML = '<i class="fas fa-smile"></i>';
            } else {
                icon.innerHTML = '<i class="fas fa-fingerprint"></i>';
            }
            
            screen.classList.remove('hidden');
        }

        function hideAutoLoginScreen() {
            const screen = document.getElementById('auto-login-screen');
            screen.classList.add('hidden');
            hideQuickAuthButton();
        }

        function showQuickAuthButton(username) {
            const btn = document.getElementById('quick-auth-btn');
            const text = document.getElementById('quick-auth-text');
            const deviceInfo = getDeviceInfo();
            
            text.textContent = `Tap to unlock with ${deviceInfo.platform}`;
            btn.classList.remove('hidden');
            
            // Also update the login form button
            updateBiometricLoginButton(username);
        }

        function hideQuickAuthButton() {
            const btn = document.getElementById('quick-auth-btn');
            btn.classList.add('hidden');
        }

        async function triggerQuickAuth() {
            const username = lastLoggedInUser || document.getElementById('user-select')?.value;
            if (!username) return;
            
            hideQuickAuthButton();
            showAutoLoginScreen(username);
            
            try {
                await authenticateWithBiometric(username, false);
                const users = DB_LS.getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    hideAutoLoginScreen();
                    completeLogin(user, true);
                }
            } catch (error) {
                console.error('Quick auth failed:', error);
                hideAutoLoginScreen();
                showToast('Authentication failed. Please use PIN.', 'error');
            }
        }

        // Update the biometric login button in the login form
        function updateBiometricLoginButton(preferredUser = null) {
            const btn = document.getElementById('biometric-quick-login-btn');
            const text = document.getElementById('biometric-login-text');
            const deviceInfo = getDeviceInfo();
            
            // Only show if biometric is available
            if (!biometricAvailable) {
                btn.classList.add('hidden');
                return;
            }
            
            text.textContent = `Login with ${deviceInfo.platform}`;
            btn.classList.remove('hidden');
        }

        // Trigger biometric from login button
        async function triggerBiometricFromLogin() {
            const username = document.getElementById('user-select')?.value || lastLoggedInUser;
            if (!username) {
                showToast('Please select a user first', 'error');
                return;
            }
            
            showAutoLoginScreen(username);
            
            try {
                await authenticateWithBiometric(username, false);
                const users = DB_LS.getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    hideAutoLoginScreen();
                    completeLogin(user, true);
                }
            } catch (error) {
                console.error('Biometric login failed:', error);
                hideAutoLoginScreen();
                showToast('Biometric authentication failed. Please use PIN.', 'error');
            }
        }

        function cancelAutoLogin() {
            hideAutoLoginScreen();
            // User can now use PIN login normally
            updateBiometricLoginButton();
        }

        // ==================== BIOMETRIC SETUP PROMPT ====================
        
        let userJustCreated = null;

        function showBiometricSetupPrompt() {
            const prompt = document.getElementById('biometric-setup-prompt');
            const icon = prompt.querySelector('.biometric-prompt-icon i');
            const title = prompt.querySelector('.biometric-prompt-title');
            const btn = prompt.querySelector('.biometric-prompt-btn.primary');
            
            const deviceInfo = getDeviceInfo();
            
            if (deviceInfo.hasFaceID) {
                icon.className = 'fas fa-smile';
                title.textContent = 'Enable Face ID?';
                btn.innerHTML = '<i class="fas fa-smile"></i> Enable Face ID';
            } else if (deviceInfo.isApple) {
                icon.className = 'fas fa-fingerprint';
                title.textContent = 'Enable Touch ID?';
                btn.innerHTML = '<i class="fas fa-fingerprint"></i> Enable Touch ID';
            } else {
                icon.className = 'fas fa-fingerprint';
                title.textContent = 'Enable Biometric Login?';
                btn.innerHTML = '<i class="fas fa-fingerprint"></i> Enable Biometric Login';
            }
            
            prompt.classList.remove('hidden');
        }

        function hideBiometricSetupPrompt() {
            document.getElementById('biometric-setup-prompt').classList.add('hidden');
        }

        async function enableBiometricFromPrompt() {
            if (!userJustCreated) {
                hideBiometricSetupPrompt();
                return;
            }

            const btn = document.querySelector('#biometric-setup-prompt .biometric-prompt-btn.primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting up...';
            btn.disabled = true;

            try {
                await registerBiometric(userJustCreated.username);
                
                // Mark as enabled
                localStorage.setItem(`biometric_${userJustCreated.username}`, 'true');
                lastLoggedInUser = userJustCreated.username;
                localStorage.setItem('lastLoggedInUser', lastLoggedInUser);
                
                hideBiometricSetupPrompt();
                showToast(`${getDeviceInfo().platform} enabled successfully!`);
                
                // Auto-login with the new biometric
                completeLogin(userJustCreated, true);
                
            } catch (error) {
                console.error('Setup error:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('Setup failed. You can enable later in settings.', 'error');
                // Still login with PIN
                completeLogin(userJustCreated, false);
            }
            
            userJustCreated = null;
        }

        function skipBiometricSetup() {
            hideBiometricSetupPrompt();
            // Continue to normal login
            if (userJustCreated) {
                completeLogin(userJustCreated, false);
                userJustCreated = null;
            }
        }

        // ==================== INDEXEDDB ====================
        const DB_NAME = 'DriverTimesheetDB_v5';
        const DB_VERSION = 4; // Incremented for biometric store
        const STORES = {
            images: 'images',
            timesheets: 'timesheets',
            archives: 'archives',
            documents: 'documents',
            vorReports: 'vorReports',
            biometricCredentials: 'biometricCredentials'
        };
        
        async function initImageDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => { 
                    imageDB = request.result; 
                    resolve(imageDB); 
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORES.images)) {
                        db.createObjectStore(STORES.images, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.documents)) {
                        const docStore = db.createObjectStore(STORES.documents, { keyPath: 'id' });
                        docStore.createIndex('weekStart', 'weekStart', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.timesheets)) {
                        const tsStore = db.createObjectStore(STORES.timesheets, { keyPath: 'id' });
                        tsStore.createIndex('weekStart', 'weekStart', { unique: false });
                        tsStore.createIndex('archived', 'archived', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.archives)) {
                        db.createObjectStore(STORES.archives, { keyPath: 'id' });
                    }

                    if (!db.objectStoreNames.contains(STORES.vorReports)) {
                        const vorStore = db.createObjectStore(STORES.vorReports, { keyPath: 'id' });
                        vorStore.createIndex('defectNumber', 'defectNumber', { unique: false });
                        vorStore.createIndex('date', 'date', { unique: false });
                    }

                    // New store for biometric credentials
                    if (!db.objectStoreNames.contains(STORES.biometricCredentials)) {
                        db.createObjectStore(STORES.biometricCredentials, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveToStore(storeName, id, data) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put({ id, ...data, timestamp: Date.now() });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getFromStore(storeName, id) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result || null);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteFromStore(storeName, id) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllFromStore(storeName) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        async function getDocumentsForWeek(weekStart) {
            const allDocs = await getAllFromStore(STORES.documents);
            return allDocs.filter(doc => doc.weekStart === weekStart);
        }

        async function getVORReportsForUser(username) {
            const allReports = await getAllFromStore(STORES.vorReports);
            return allReports.filter(report => report.username === username)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        async function clearAllStores() {
            if (!imageDB) await initImageDB();
            const stores = Object.values(STORES);
            for (const storeName of stores) {
                await new Promise((resolve, reject) => {
                    const transaction = imageDB.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        async function checkStorageQuota() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                try {
                    const { usage, quota } = await navigator.storage.estimate();
                    const usedMB = (usage / (1024 * 1024)).toFixed(1);
                    const quotaMB = quota ? (quota / (1024 * 1024)).toFixed(0) : 'Unknown';
                    const percent = quota ? Math.round((usage / quota) * 100) : 0;
                    
                    document.getElementById('storage-used').textContent = `${usedMB} MB`;
                    document.getElementById('storage-available').textContent = quota ? `${quotaMB} MB` : 'Unknown';
                    document.getElementById('settings-storage-bar').style.width = `${percent}%`;
                    document.getElementById('stat-storage-used').textContent = `${usedMB} MB`;
                    document.getElementById('storage-bar-fill').style.width = `${percent}%`;
                    
                    return { usedMB, quotaMB, percent };
                } catch (e) {
                    console.error('Storage estimate failed:', e);
                }
            }
            return null;
        }

        // ==================== DATE UTILITIES ====================
        function formatDateForInput(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        function parseDate(dateString) {
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            }
            return new Date(dateString);
        }
        
        function formatWeekRange(startDate, endDate) {
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
        }

        // ==================== DATA STORE ====================
        const DB_LS = {
            getUsers: () => JSON.parse(localStorage.getItem('ts_users') || '[]'),
            saveUsers: (users) => localStorage.setItem('ts_users', JSON.stringify(users)),
            getTimesheets: (username) => JSON.parse(localStorage.getItem(`ts_data_${username}`) || '[]'),
            saveTimesheets: (username, data) => localStorage.setItem(`ts_data_${username}`, JSON.stringify(data)),
            deleteUser: (username) => {
                localStorage.removeItem(`ts_data_${username}`);
                localStorage.removeItem(`ts_settings_${username}`);
                localStorage.removeItem(`biometric_${username}`);
                localStorage.removeItem('lastLoggedInUser');
                const users = DB_LS.getUsers().filter(u => u.username !== username);
                DB_LS.saveUsers(users);
            }
        };

        // ==================== AUTH ====================
        function initAuth() {
            document.getElementById('version-display').textContent = 'v' + APP_VERSION;
            document.getElementById('settings-version').textContent = 'v' + APP_VERSION + ' (Biometric Edition)';
            
            const users = DB_LS.getUsers();
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                users.map(u => `<option value="${u.username}">${u.username}</option>`).join('');
            
            if (users.length === 1) {
                select.value = users[0].username;
                document.getElementById('pin-section').classList.remove('hidden');
            }
            
            select.addEventListener('change', function() {
                document.getElementById('pin-section').classList.toggle('hidden', !this.value);
                // Update biometric button visibility based on selection
                if (this.value && biometricAvailable) {
                    const hasBiometric = localStorage.getItem(`biometric_${this.value}`) === 'true';
                    if (hasBiometric) {
                        updateBiometricLoginButton(this.value);
                    }
                }
            });

            updateApiKeyStatus();
            updateStorageWidgetToggle();
            
            // Check biometric availability and update UI
            checkBiometricAvailability().then(available => {
                biometricAvailable = available;
                if (available) {
                    updateBiometricLoginButton();
                }
                // Attempt auto-login after checking availability
                attemptAutoLogin();
            });
        }

        function updateStorageWidgetToggle() {
            const toggle = document.getElementById('storage-widget-toggle');
            if (showStorageWidget) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function toggleStorageWidget() {
            showStorageWidget = !showStorageWidget;
            localStorage.setItem('showStorageWidget', showStorageWidget);
            updateStorageWidgetToggle();
            
            const widget = document.getElementById('storage-widget');
            if (widget) {
                widget.style.display = showStorageWidget ? 'block' : 'none';
            }
            
            showToast(showStorageWidget ? 'Storage widget enabled' : 'Storage widget hidden');
        }

        function updateApiKeyStatus() {
            const isConfigured = GEMINI_API_KEY && GEMINI_API_KEY.length > 10;
            const badge = document.getElementById('api-status-badge');
            const btnText = document.getElementById('api-key-btn-text');
            const status = document.getElementById('api-key-status');
            const warning = document.getElementById('api-key-warning');
            const vorWarning = document.getElementById('vor-api-key-warning');
            
            if (isConfigured) {
                if (badge) {
                    badge.textContent = 'Active';
                    badge.className = 'px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium';
                }
                if (btnText) btnText.textContent = 'Update API Key';
                if (status) status.textContent = 'Key ending in ...' + GEMINI_API_KEY.slice(-4);
                if (warning) warning.classList.add('hidden');
                if (vorWarning) vorWarning.classList.add('hidden');
            } else {
                if (badge) {
                    badge.textContent = 'Not Configured';
                    badge.className = 'px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium';
                }
                if (btnText) btnText.textContent = 'Configure API Key';
                if (status) status.textContent = 'Required for AI scanning';
                if (warning && document.getElementById('scan-view').classList.contains('hidden') === false) {
                    warning.classList.remove('hidden');
                }
                if (vorWarning && document.getElementById('vor-view').classList.contains('hidden') === false) {
                    vorWarning.classList.remove('hidden');
                }
            }
        }

        function loginWithPin() {
            const username = document.getElementById('user-select').value;
            const pin = document.getElementById('pin-input').value;
            
            if (!username) return showToast('Please select a user', 'error');
            if (!pin || pin.length !== 4) return showToast('Enter 4-digit PIN', 'error');
            
            const users = DB_LS.getUsers();
            const user = users.find(u => u.username === username && u.pin === hashPin(pin));
            
            if (!user) {
                showToast('Invalid PIN', 'error');
                document.getElementById('pin-input').value = '';
                return;
            }
            
            completeLogin(user, false); // false = not from biometric
        }

        function completeLogin(user, fromBiometric = false) {
            currentUser = user;
            lastLoggedInUser = user.username;
            localStorage.setItem('lastLoggedInUser', user.username);
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('header-username').textContent = user.username;
            
            const today = new Date();
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + (6 - today.getDay()));
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            
            // Set VOR date to today
            document.getElementById('vor-date-select').value = formatDateForInput(today);
            
            // Theme is already initialized by the inline script, just update the label
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
            
            // Check biometric status for this user
            biometricEnabled = localStorage.getItem(`biometric_${user.username}`) === 'true';
            
            renderCalendar();
            updateStats();
            renderRecent();
            checkStorageQuota();
            updateApiKeyStatus();
            updateStorageWidgetVisibility();
            
            const deviceInfo = getDeviceInfo();
            const welcomeMsg = fromBiometric ? 
                `Welcome, ${user.username} (${deviceInfo.platform})` : 
                `Welcome, ${user.username}`;
            
            showToast(welcomeMsg);
        }

        function updateStorageWidgetVisibility() {
            const widget = document.getElementById('storage-widget');
            if (widget) {
                widget.style.display = showStorageWidget ? 'block' : 'none';
            }
        }

        function updateScanWeekDisplay() {
            const dateInput = document.getElementById('scan-date-select');
            if (dateInput.value) {
                const endDate = parseDate(dateInput.value);
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                document.getElementById('selected-week-info').textContent = 
                    `Week: ${formatWeekRange(startDate, endDate)}`;
            }
        }

        function showCreateUser() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('create-user-form').classList.remove('hidden');
        }

        function hideCreateUser() {
            document.getElementById('create-user-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            // Reset biometric registration state
            pendingBiometricRegistration = false;
            tempUserForBiometric = null;
            userJustCreated = null;
        }

        function createUser() {
            const username = document.getElementById('new-username').value.trim();
            const pin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            
            if (!username) return showToast('Enter driver name', 'error');
            if (!pin || pin.length !== 4) return showToast('PIN must be 4 digits', 'error');
            if (pin !== confirmPin) return showToast('PINs do not match', 'error');
            
            const users = DB_LS.getUsers();
            if (users.find(u => u.username === username)) return showToast('User already exists', 'error');
            
            const newUser = { username, pin: hashPin(pin), created: new Date().toISOString() };
            users.push(newUser);
            DB_LS.saveUsers(users);
            
            // Store the newly created user for biometric setup prompt
            userJustCreated = newUser;
            
            showToast('Driver created successfully');
            
            // Hide create form and show biometric setup prompt instead of immediately logging in
            document.getElementById('create-user-form').classList.add('hidden');
            
            // Check if biometric is available before showing prompt
            checkBiometricAvailability().then(available => {
                if (available) {
                    showBiometricSetupPrompt();
                } else {
                    // Biometric not available, just login normally
                    completeLogin(newUser, false);
                }
            });
        }

        function logout() {
            currentUser = null;
            biometricEnabled = false;
            autoLoginAttempted = false; // Reset so we can auto-login next time
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-section').classList.add('hidden');
            document.getElementById('user-select').value = '';
            
            // Don't clear lastLoggedInUser so auto-login can work next time
            // But we do want to show the biometric button if available
            updateBiometricLoginButton();
        }

        function hashPin(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ==================== CALENDAR ====================
        async function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const weekData = {};
            const docData = {};
            const vorData = {};
            
            timesheets.forEach(ts => {
                const date = parseDate(ts.weekStart);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    weekData[date.getDate()] = ts;
                }
            });
            
            const allDocs = await getAllFromStore(STORES.documents);
            allDocs.forEach(doc => {
                const date = parseDate(doc.weekStart);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    if (!docData[date.getDate()]) docData[date.getDate()] = 0;
                    docData[date.getDate()]++;
                }
            });

            // Get VOR reports for calendar
            const vorReports = await getVORReportsForUser(currentUser.username);
            vorReports.forEach(vor => {
                const date = parseDate(vor.date);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    vorData[date.getDate()] = vor;
                }
            });
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = startPadding - 1; i >= 0; i--) {
                grid.appendChild(createCalendarDay(prevMonthDays - i, true));
            }
            
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (day === todayDate && month === todayMonth && year === todayYear);
                const hasData = weekData[day];
                const hasDocs = docData[day] > 0;
                const hasVOR = vorData[day];
                const cell = createCalendarDay(day, false, isToday, hasData, hasDocs, hasVOR);
                
                if (hasData || hasDocs || hasVOR) cell.onclick = () => selectWeek(weekData[day], day, hasDocs, hasVOR);
                else cell.onclick = () => selectEmptyWeek(year, month, day);
                
                grid.appendChild(cell);
            }
            
            const remaining = (7 - ((startPadding + daysInMonth) % 7)) % 7;
            for (let day = 1; day <= remaining; day++) {
                grid.appendChild(createCalendarDay(day, true));
            }
        }

        function createCalendarDay(day, isOtherMonth, isToday = false, hasData = false, hasDocs = false, hasVOR = false) {
            const div = document.createElement('div');
            let className = 'calendar-day';
            
            if (isOtherMonth) className += ' other-month bg-gray-100 dark:bg-dark-surface text-gray-400';
            else className += ' bg-white dark:bg-dark-surface text-gray-900 dark:text-white';
            
            if (isToday) className += ' today';
            if (hasData) className += ' has-data';
            if (hasDocs) className += ' has-docs';
            if (hasVOR) className += ' has-vor';
            
            div.className = className;
            
            let todayIndicator = '';
            if (isToday) {
                todayIndicator = '<div class="absolute -top-1 -right-1 w-3 h-3 bg-primary rounded-full border-2 border-white dark:border-dark-card"></div>';
            }
            
            let docIndicator = '';
            if (hasDocs && !hasData && !hasVOR) {
                docIndicator = '<div class="absolute bottom-1 w-1.5 h-1.5 bg-purple-500 rounded-full"></div>';
            }
            
            let vorIndicator = '';
            if (hasVOR) {
                vorIndicator = '<div class="absolute bottom-1 right-1 w-2 h-2 bg-orange-500 rounded-full"></div>';
            }
            
            div.innerHTML = `
                <span class="text-lg font-bold">${day}</span>
                ${hasData ? '<div style="background: rgba(255,255,255,0.5); height: 3px; width: 60%; border-radius: 2px; margin-top: 2px;"></div>' : ''}
                ${docIndicator}
                ${vorIndicator}
                ${todayIndicator}
            `;
            return div;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        async function selectWeek(timesheet, day, hasDocs, hasVOR) {
            selectedWeekStart = timesheet ? timesheet.weekStart : 
                formatDateForInput(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day));
            
            const preview = document.getElementById('week-preview');
            preview.classList.remove('hidden');
            
            if (timesheet) {
                document.getElementById('preview-week-range').textContent = timesheet.weekRange;
                document.getElementById('preview-total-hours').textContent = timesheet.totalHours + 'h';
                
                const daysContainer = document.getElementById('preview-days');
                daysContainer.innerHTML = timesheet.days.map((day, i) => `
                    <div class="flex-shrink-0 w-16 h-16 rounded-xl ${day.hours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex flex-col items-center justify-center">
                        <span class="text-xs">${['S','M','T','W','T','F','S'][i]}</span>
                        <span class="font-bold">${day.hours > 0 ? day.hours : '-'}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('preview-week-range').textContent = 'Week of ' + 
                    new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('preview-total-hours').textContent = '-';
                document.getElementById('preview-days').innerHTML = '<div class="text-gray-400 text-sm">No timesheet data</div>';
            }
            
            const docs = await getDocumentsForWeek(selectedWeekStart);
            const docPreview = document.getElementById('preview-documents');
            if (docs.length > 0) {
                docPreview.classList.remove('hidden');
                document.getElementById('preview-doc-count').textContent = `${docs.length} doc${docs.length > 1 ? 's' : ''} attached`;
            } else {
                docPreview.classList.add('hidden');
            }
        }

        function selectEmptyWeek(year, month, day) {
            const date = new Date(year, month, day, 12, 0, 0);
            const saturday = new Date(date);
            saturday.setDate(date.getDate() + (6 - date.getDay()));
            
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            switchView('scan');
            showToast('Selected week for new upload');
        }

        function openSelectedWeek() {
            if (!selectedWeekStart) return;
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === selectedWeekStart);
            if (ts) openWeekDetails(ts);
            else showToast('No timesheet data for this week', 'error');
        }

        // ==================== IMAGE PREPROCESSING ====================
        async function preprocessImage(imageDataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxWidth = 2000;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        
                        ctx.filter = 'contrast(1.3) brightness(1.05)';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const processed = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(processed);
                    } catch (err) {
                        resolve(imageDataUrl);
                    }
                };
                
                img.onerror = () => resolve(imageDataUrl);
                img.src = imageDataUrl;
            });
        }

        // ==================== DOCUMENT HANDLING ====================
        
        function handleDocItemClick(docNum) {
            const doc = currentDocs[docNum];
            if (!doc) {
                document.getElementById(`file-doc-${docNum}`).click();
            }
        }

        function updateDocCountBadge() {
            const docs = Object.values(currentDocs).filter(d => d !== null);
            const count = docs.length;
            const badge = document.getElementById('doc-count-badge');
            if (badge) {
                badge.textContent = `${count}/3`;
                if (count === 3) {
                    badge.className = 'text-xs text-white bg-green-500 px-2 py-1 rounded-full font-medium';
                } else {
                    badge.className = 'text-xs text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full font-medium';
                }
            }
        }

        async function handleDocSelect(event, docNum) {
            event.stopPropagation();
            const file = event.target.files[0];
            if (!file) return;
            
            const MAX_SIZE = 20 * 1024 * 1024;
            
            if (file.size > MAX_SIZE) {
                showToast('File too large (max 20MB)', 'error');
                return;
            }
            
            const icon = document.getElementById(`doc-${docNum}-icon`);
            const status = document.getElementById(`doc-${docNum}-status`);
            
            icon.className = 'fas fa-spinner fa-spin text-primary';
            status.textContent = 'Loading...';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                currentDocs[docNum] = {
                    file: file,
                    dataUrl: e.target.result,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    docName: DOC_NAMES[docNum]
                };
                
                updateDocUI(docNum);
                updateDocCountBadge();
                showToast(`${DOC_NAMES[docNum]} added`);
            };
            
            reader.onerror = () => {
                status.textContent = 'Error';
                showToast('Error reading file', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        function updateDocUI(docNum) {
            const doc = currentDocs[docNum];
            if (!doc) return;
            
            const item = document.getElementById(`doc-${docNum}-item`);
            const icon = document.getElementById(`doc-${docNum}-icon`);
            const status = document.getElementById(`doc-${docNum}-status`);
            const preview = document.getElementById(`doc-${docNum}-preview`);
            const actions = document.getElementById(`doc-${docNum}-actions`);
            
            item.classList.add('has-file');
            icon.className = 'hidden';
            status.textContent = 'Added';
            
            if (doc.type.startsWith('image/')) {
                preview.src = doc.dataUrl;
                preview.classList.remove('hidden');
            } else {
                icon.className = 'fas fa-file-pdf text-red-500 text-2xl';
                icon.classList.remove('hidden');
            }
            
            if (actions) {
                actions.style.display = 'flex';
            }
        }

        function viewDoc(docNum) {
            const doc = currentDocs[docNum];
            if (!doc) return;
            
            if (doc.type.startsWith('image/')) {
                openFullscreenViewer(doc.dataUrl, doc.name, doc.docName || DOC_NAMES[docNum], doc);
            } else {
                const link = document.createElement('a');
                link.href = doc.dataUrl;
                link.download = doc.name;
                link.click();
                showToast('PDF download started');
            }
        }

        async function shareDoc(docNum) {
            const doc = currentDocs[docNum];
            if (!doc) return;
            
            if (navigator.share && navigator.canShare) {
                try {
                    const response = await fetch(doc.dataUrl);
                    const blob = await response.blob();
                    const file = new File([blob], doc.name, { type: doc.type });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: doc.docName || DOC_NAMES[docNum],
                            text: `${doc.docName || DOC_NAMES[docNum]} - ${doc.name}`,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log('Native share failed, falling back');
                }
            }
            
            const link = document.createElement('a');
            link.href = doc.dataUrl;
            link.download = doc.name;
            link.click();
            showToast('Document saved to downloads');
        }

        function removeDoc(docNum) {
            currentDocs[docNum] = null;
            
            const item = document.getElementById(`doc-${docNum}-item`);
            const icon = document.getElementById(`doc-${docNum}-icon`);
            const status = document.getElementById(`doc-${docNum}-status`);
            const preview = document.getElementById(`doc-${docNum}-preview`);
            const input = document.getElementById(`file-doc-${docNum}`);
            const actions = document.getElementById(`doc-${docNum}-actions`);
            
            item.classList.remove('has-file');
            
            icon.className = `fas ${DOC_ICONS[docNum]} text-gray-400`;
            icon.classList.remove('hidden');
            
            status.textContent = 'Add';
            preview.src = '';
            preview.classList.add('hidden');
            input.value = '';
            
            if (actions) {
                actions.style.display = 'none';
            }
            
            updateDocCountBadge();
            
            showToast('Document removed');
        }

        // ==================== FULLSCREEN VIEWER ====================
        
        let shareFallbackDoc = null;
        
        function openFullscreenViewer(imageUrl, filename, docType, docData) {
            currentViewerDoc = docData;
            shareFallbackDoc = docData;
            document.getElementById('viewer-image').src = imageUrl;
            document.getElementById('viewer-filename').textContent = filename;
            document.getElementById('viewer-doc-type').textContent = docType;
            document.getElementById('fullscreen-viewer').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            document.addEventListener('keydown', handleViewerEscapeKey);
        }

        function closeFullscreenViewer(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            document.getElementById('fullscreen-viewer').classList.add('hidden');
            document.body.style.overflow = '';
            currentViewerDoc = null;
            
            document.removeEventListener('keydown', handleViewerEscapeKey);
        }

        function handleViewerEscapeKey(e) {
            if (e.key === 'Escape') {
                closeFullscreenViewer();
            }
        }

        function handleViewerBackdropClick(event) {
            if (event.target === event.currentTarget) {
                closeFullscreenViewer();
            }
        }

        function handleViewerContentClick(event) {
            if (event.target === event.currentTarget) {
                closeFullscreenViewer();
            }
        }

        async function shareViewerDocument(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if (!currentViewerDoc) return;
            
            let shareSucceeded = false;
            
            if (navigator.share && navigator.canShare) {
                try {
                    const response = await fetch(currentViewerDoc.dataUrl);
                    const blob = await response.blob();
                    const file = new File([blob], currentViewerDoc.name, { type: currentViewerDoc.type });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: currentViewerDoc.docName || 'Document',
                            text: `${currentViewerDoc.docName || 'Document'} - ${currentViewerDoc.name}`,
                            files: [file]
                        });
                        shareSucceeded = true;
                        return;
                    }
                } catch (e) {
                    console.log('Native share failed or was cancelled:', e);
                }
            }
            
            showShareFallback();
        }

        function showShareFallback() {
            const modal = document.getElementById('share-fallback-modal');
            const text = document.getElementById('share-fallback-text');
            
            if (shareFallbackDoc) {
                text.textContent = `${shareFallbackDoc.docName || 'Document'}: ${shareFallbackDoc.name}`;
            }
            
            modal.classList.remove('hidden');
        }

        function closeShareFallback(event) {
            if (event) {
                event.stopPropagation();
            }
            document.getElementById('share-fallback-modal').classList.add('hidden');
        }

        function downloadCurrentDocument() {
            if (!shareFallbackDoc) return;
            
            const link = document.createElement('a');
            link.href = shareFallbackDoc.dataUrl;
            link.download = shareFallbackDoc.name;
            link.click();
            
            closeShareFallback();
            showToast('Document saved to downloads');
        }

        // ==================== SCAN & OCR ====================
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('active');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('active');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processFile(file, type);
        }

        function handleFileSelect(e, type) {
            const file = e.target.files[0];
            if (file) processFile(file, type);
        }

        async function processFile(file, type) {
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                showToast('Image too large (max 10MB)', 'error');
                return;
            }
            
            document.getElementById('image-processing-indicator').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    currentImage = e.target.result;
                    processedImage = await preprocessImage(currentImage);
                    
                    document.getElementById('preview-front').src = processedImage;
                    document.getElementById('preview-front').classList.remove('hidden');
                    document.getElementById('upload-front-default').classList.add('hidden');
                    document.getElementById('front-status').textContent = 'Ready';
                    document.getElementById('front-status').className = 'text-xs text-green-600 font-medium';
                    document.getElementById('timesheet-upload-zone').classList.remove('required');
                    
                    showToast('Timesheet loaded. Tap "Auto-Extract Times" to scan.');
                } catch (err) {
                    processedImage = currentImage;
                    document.getElementById('preview-front').src = currentImage;
                    document.getElementById('preview-front').classList.remove('hidden');
                    document.getElementById('upload-front-default').classList.add('hidden');
                } finally {
                    document.getElementById('image-processing-indicator').classList.add('hidden');
                }
            };
            reader.onerror = () => {
                showToast('Error reading image', 'error');
                document.getElementById('image-processing-indicator').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // ==================== VOR HANDLING ====================
        
        function handleVORDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processVORFile(file);
        }

        function handleVORFileSelect(e) {
            const file = e.target.files[0];
            if (file) processVORFile(file);
        }

        async function processVORFile(file) {
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                showToast('Image too large (max 10MB)', 'error');
                return;
            }
            
            document.getElementById('vor-processing-indicator').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    vorCurrentImage = e.target.result;
                    vorProcessedImage = await preprocessImage(vorCurrentImage);
                    
                    document.getElementById('vor-preview-main').src = vorProcessedImage;
                    document.getElementById('vor-preview-main').classList.remove('hidden');
                    document.getElementById('vor-upload-default').classList.add('hidden');
                    document.getElementById('vor-photo-status').textContent = 'Ready';
                    document.getElementById('vor-photo-status').className = 'text-xs text-orange-600 font-medium';
                    document.getElementById('vor-upload-zone').classList.remove('required');
                    
                    showToast('Defect photo loaded. Tap "Scan Defect Report" to extract.');
                } catch (err) {
                    vorProcessedImage = vorCurrentImage;
                    document.getElementById('vor-preview-main').src = vorCurrentImage;
                    document.getElementById('vor-preview-main').classList.remove('hidden');
                    document.getElementById('vor-upload-default').classList.add('hidden');
                } finally {
                    document.getElementById('vor-processing-indicator').classList.add('hidden');
                }
            };
            reader.onerror = () => {
                showToast('Error reading image', 'error');
                document.getElementById('vor-processing-indicator').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function handleVORAdditionalSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const MAX_SIZE = 10 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                showToast('Image too large (max 10MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                vorAdditionalImage = e.target.result;
                document.getElementById('vor-preview-additional').src = vorAdditionalImage;
                document.getElementById('vor-preview-additional').classList.remove('hidden');
                document.getElementById('vor-additional-default').classList.add('hidden');
                document.getElementById('vor-additional-status').textContent = 'Added';
                document.getElementById('vor-additional-status').className = 'text-xs text-green-600 font-medium';
                showToast('Additional photo added');
            };
            reader.readAsDataURL(file);
        }

        function updateVOROcrProgress(percentage, stage) {
            const bar = document.getElementById('vor-ocr-progress-bar');
            const pct = document.getElementById('vor-ocr-percentage');
            const stageText = document.getElementById('vor-ocr-stage');
            const statusText = document.getElementById('vor-ocr-status-text');
            
            if (bar) bar.style.width = percentage + '%';
            if (pct) pct.textContent = percentage + '%';
            if (stageText) stageText.textContent = stage;
            if (statusText) statusText.textContent = stage;
        }

        async function performVOROCR(imageDataUrl) {
            if (!isGeminiConfigured()) {
                throw new Error('Gemini API key not configured. Please add your API key in settings.');
            }

            const base64Image = imageDataUrl.split(',')[1];
            if (!base64Image) {
                throw new Error('Invalid image format');
            }

            const prompt = `You are an expert OCR system specialized in extracting data from Vehicle Defect Reports (VDR) and VOR (Vehicle Off Road) forms.

Analyze this defect report image and extract the following information:

1. DEFECT NUMBER (usually starts with "No" or just a number, e.g., "092018")
2. DATE (format DD-MM-YY or similar)
3. TIME (24-hour format, e.g., "16:00")
4. REG/TRAILER NUMBER (vehicle registration, e.g., "WU69 XDY")
5. NATURE OF DEFECT (description of the problem, e.g., "FAULT IN 12/24 VOLT SYSTEM")

Look for fields labeled:
- "No" or "Defect No"
- "DATE"
- "TIME"  
- "REG.No./TRAILER No" or "VEHICLE"
- "NATURE OF DEFECT"

Return ONLY a JSON object in this exact format:
{
  "defectNumber": "string or null",
  "date": "DD-MM-YYYY or null",
  "time": "HH:MM or null",
  "regNumber": "string or null",
  "natureOfDefect": "string or null",
  "confidence": "high|medium|low"
}

Rules:
- Use null for fields not found
- Convert dates to DD-MM-YYYY format
- Convert times to HH:MM format
- Reg numbers may have spaces (e.g., "WU69 XDY")
- Nature of defect may be handwritten - extract as clearly as possible
- Confidence is high if 4+ fields clear, medium if 2-3, low if fewer`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.1,
                    maxOutputTokens: 2048
                }
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${apiUrl}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error (${response.status}): ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();

                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('No response from Gemini API');
                }

                const text = data.candidates[0].content.parts[0].text;

                let parsedData;
                try {
                    const jsonMatch = text.match(/```json\s*([\s\S]*?)```/) || 
                                     text.match(/```\s*([\s\S]*?)```/) ||
                                     [null, text];
                    const jsonStr = jsonMatch[1] || text;
                    parsedData = JSON.parse(jsonStr);
                } catch (e) {
                    parsedData = extractVORDataFromText(text);
                }

                return parsedData;

            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please check your internet connection.');
                }
                throw error;
            }
        }

        function extractVORDataFromText(text) {
            const data = {
                defectNumber: null,
                date: null,
                time: null,
                regNumber: null,
                natureOfDefect: null,
                confidence: 'low'
            };

            const defectMatch = text.match(/defectNumber["\s:]+([^"\n,}]+)/i) ||
                               text.match(/No["\s:]+([^"\n,}]+)/i) ||
                               text.match(/(\d{5,6})/);
            if (defectMatch) data.defectNumber = defectMatch[1].trim();

            const dateMatch = text.match(/date["\s:]+([^"\n,}]+)/i) ||
                             text.match(/(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})/);
            if (dateMatch) data.date = dateMatch[1].trim();

            const timeMatch = text.match(/time["\s:]+([^"\n,}]+)/i) ||
                             text.match(/(\d{1,2}:\d{2})/);
            if (timeMatch) data.time = timeMatch[1].trim();

            const regMatch = text.match(/regNumber["\s:]+([^"\n,}]+)/i) ||
                            text.match(/reg["\s:]+([^"\n,}]+)/i) ||
                            text.match(/([A-Z]{2}\d{2}\s*[A-Z]{3})/i);
            if (regMatch) data.regNumber = regMatch[1].trim();

            const natureMatch = text.match(/natureOfDefect["\s:]+([^"\n}]+)/i) ||
                               text.match(/nature["\s:]+([^"\n}]+)/i);
            if (natureMatch) data.natureOfDefect = natureMatch[1].trim();

            return data;
        }

        async function startVOROCR() {
            if (!vorProcessedImage && !vorCurrentImage) {
                showToast('Defect photo is required', 'error');
                document.getElementById('vor-upload-zone').classList.add('required');
                return;
            }

            if (!isGeminiConfigured()) {
                showGeminiKeyModal();
                return;
            }

            const imageToProcess = vorProcessedImage || vorCurrentImage;

            document.getElementById('vor-ocr-error').classList.add('hidden');
            document.getElementById('vor-scan-btn').classList.add('hidden');
            document.getElementById('vor-ocr-progress').classList.remove('hidden');
            document.getElementById('vor-auto-results').classList.add('hidden');

            updateVOROcrProgress(5, 'Preparing image...');

            try {
                await new Promise(r => setTimeout(r, 100));
                updateVOROcrProgress(15, 'Connecting to Gemini AI...');
                
                const geminiResult = await performVOROCR(imageToProcess);
                
                updateVOROcrProgress(80, 'Processing results...');
                
                vorAutoDetectedData = geminiResult;

                // Fill in the form
                if (geminiResult.defectNumber) {
                    document.getElementById('vor-defect-number').value = geminiResult.defectNumber;
                    document.getElementById('vor-defect-number').classList.add('auto-filled');
                    document.getElementById('vor-defect-number-badge').classList.remove('hidden');
                }

                if (geminiResult.date) {
                    const parsedDate = parseVORDate(geminiResult.date);
                    if (parsedDate) {
                        document.getElementById('vor-date-select').value = formatDateForInput(parsedDate);
                        document.getElementById('vor-date-select').classList.add('auto-filled');
                        document.getElementById('vor-auto-detected-badge').classList.remove('hidden');
                    }
                }

                if (geminiResult.time) {
                    document.getElementById('vor-time').value = geminiResult.time;
                    document.getElementById('vor-time').classList.add('auto-filled');
                    document.getElementById('vor-time-badge').classList.remove('hidden');
                }

                if (geminiResult.regNumber) {
                    document.getElementById('vor-reg-number').value = geminiResult.regNumber.toUpperCase();
                    document.getElementById('vor-reg-number').classList.add('auto-filled');
                    document.getElementById('vor-reg-badge').classList.remove('hidden');
                }

                if (geminiResult.natureOfDefect) {
                    document.getElementById('vor-nature').value = geminiResult.natureOfDefect;
                    document.getElementById('vor-nature').classList.add('auto-filled');
                    document.getElementById('vor-nature-badge').classList.remove('hidden');
                }

                updateVOROcrProgress(100, 'Complete!');

                setTimeout(() => {
                    document.getElementById('vor-ocr-progress').classList.add('hidden');
                    showVORAutoResults();
                }, 500);

                const filledFields = [geminiResult.defectNumber, geminiResult.date, geminiResult.time, 
                                    geminiResult.regNumber, geminiResult.natureOfDefect].filter(f => f).length;
                const confidence = filledFields >= 4 ? 'high' : filledFields >= 2 ? 'medium' : 'low';
                
                showToast(`✅ Extracted ${filledFields}/5 fields with Gemini AI`);

            } catch (err) {
                console.error('VOR OCR Error:', err);
                
                document.getElementById('vor-ocr-progress').classList.add('hidden');
                document.getElementById('vor-ocr-error').classList.remove('hidden');
                document.getElementById('vor-scan-btn').classList.remove('hidden');
                
                let errorMsg = err.message || 'OCR failed. Please try again.';
                document.getElementById('vor-error-message').textContent = errorMsg;
                
                showToast(errorMsg, 'error');
            }
        }

        function parseVORDate(dateStr) {
            const formats = [
                /(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})/,
                /(\d{1,2})\s+(\w+)\s+(\d{4})/i
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    let day, month, year;
                    
                    if (match[0].match(/\d{1,2}\s+\w+\s+\d{4}/)) {
                        day = parseInt(match[1]);
                        const monthNames = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                        month = monthNames.indexOf(match[2].toLowerCase());
                        year = parseInt(match[3]);
                    } else {
                        day = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        year = parseInt(match[3]);
                    }

                    if (year < 100) year = 2000 + year;

                    const date = new Date(year, month, day);
                    if (date.getDate() === day) return date;
                }
            }
            return null;
        }

        function showVORAutoResults() {
            document.getElementById('vor-auto-results').classList.remove('hidden');
            document.getElementById('vor-save-btn').classList.remove('hidden');
            
            const data = vorAutoDetectedData || {};
            
            document.getElementById('vor-result-defect-number').textContent = data.defectNumber || '--';
            document.getElementById('vor-result-date').textContent = data.date || '--';
            document.getElementById('vor-result-time').textContent = data.time || '--';
            document.getElementById('vor-result-reg').textContent = data.regNumber ? data.regNumber.toUpperCase() : '--';
            
            const filledFields = [data.defectNumber, data.date, data.time, data.regNumber, data.natureOfDefect].filter(f => f).length;
            const confidence = filledFields >= 4 ? 'High' : filledFields >= 2 ? 'Medium' : 'Low';
            
            const badge = document.getElementById('vor-confidence-badge');
            badge.textContent = confidence + ' Confidence';
            badge.className = 'text-xs px-2 py-1 rounded-full ' + 
                (confidence === 'High' ? 'bg-green-200 text-green-800' :
                 confidence === 'Medium' ? 'bg-yellow-200 text-yellow-800' :
                 'bg-red-200 text-red-800');
        }

        function retryVOROCR() {
            document.getElementById('vor-ocr-error').classList.add('hidden');
            startVOROCR();
        }

        function showVORManualEntry() {
            document.getElementById('vor-ocr-error').classList.add('hidden');
            document.getElementById('vor-auto-results').classList.remove('hidden');
            document.getElementById('vor-save-btn').classList.remove('hidden');
            showToast('Enter details manually', 'info');
        }

        async function saveVORReport() {
            const defectNumber = document.getElementById('vor-defect-number').value.trim();
            const date = document.getElementById('vor-date-select').value;
            const time = document.getElementById('vor-time').value;
            const regNumber = document.getElementById('vor-reg-number').value.trim().toUpperCase();
            const nature = document.getElementById('vor-nature').value.trim();

            if (!defectNumber) {
                showToast('Defect number is required', 'error');
                return;
            }
            if (!date) {
                showToast('Date is required', 'error');
                return;
            }

            const vorId = `vor_${currentUser.username}_${Date.now()}`;
            
            // Save main image
            const mainImageId = `${vorId}_main`;
            if (vorProcessedImage || vorCurrentImage) {
                await saveToStore(STORES.images, mainImageId, { 
                    data: vorProcessedImage || vorCurrentImage 
                });
            }

            // Save additional image if present
            let additionalImageId = null;
            if (vorAdditionalImage) {
                additionalImageId = `${vorId}_additional`;
                await saveToStore(STORES.images, additionalImageId, { 
                    data: vorAdditionalImage 
                });
            }

            const vorReport = {
                id: vorId,
                username: currentUser.username,
                defectNumber: defectNumber,
                date: date,
                time: time || null,
                regNumber: regNumber || null,
                natureOfDefect: nature || null,
                mainImageId: mainImageId,
                additionalImageId: additionalImageId,
                createdAt: new Date().toISOString(),
                ocrData: vorAutoDetectedData
            };

            await saveToStore(STORES.vorReports, vorId, vorReport);

            resetVORForm();
            
            showToast(`VOR Report #${defectNumber} saved successfully`);
            switchView('history');
        }

        function resetVORForm() {
            vorCurrentImage = null;
            vorProcessedImage = null;
            vorAdditionalImage = null;
            vorAutoDetectedData = null;

            document.getElementById('vor-defect-number').value = '';
            document.getElementById('vor-date-select').value = formatDateForInput(new Date());
            document.getElementById('vor-time').value = '';
            document.getElementById('vor-reg-number').value = '';
            document.getElementById('vor-nature').value = '';

            document.getElementById('vor-preview-main').src = '';
            document.getElementById('vor-preview-main').classList.add('hidden');
            document.getElementById('vor-upload-default').classList.remove('hidden');
            document.getElementById('vor-file-main').value = '';

            document.getElementById('vor-preview-additional').src = '';
            document.getElementById('vor-preview-additional').classList.add('hidden');
            document.getElementById('vor-additional-default').classList.remove('hidden');
            document.getElementById('vor-file-additional').value = '';

            document.getElementById('vor-defect-number').classList.remove('auto-filled');
            document.getElementById('vor-date-select').classList.remove('auto-filled');
            document.getElementById('vor-time').classList.remove('auto-filled');
            document.getElementById('vor-reg-number').classList.remove('auto-filled');
            document.getElementById('vor-nature').classList.remove('auto-filled');

            document.getElementById('vor-defect-number-badge').classList.add('hidden');
            document.getElementById('vor-auto-detected-badge').classList.add('hidden');
            document.getElementById('vor-time-badge').classList.add('hidden');
            document.getElementById('vor-reg-badge').classList.add('hidden');
            document.getElementById('vor-nature-badge').classList.add('hidden');

            document.getElementById('vor-photo-status').textContent = 'Required';
            document.getElementById('vor-photo-status').className = 'text-xs text-red-500 font-medium';
            document.getElementById('vor-additional-status').textContent = 'Optional';
            document.getElementById('vor-additional-status').className = 'text-xs text-gray-400 font-medium';

            document.getElementById('vor-auto-results').classList.add('hidden');
            document.getElementById('vor-save-btn').classList.add('hidden');
            document.getElementById('vor-scan-btn').classList.remove('hidden');
        }

        // ==================== GEMINI AI OCR (Timesheet) ====================
        function isGeminiConfigured() {
            return GEMINI_API_KEY && GEMINI_API_KEY.length > 10 && GEMINI_API_KEY.startsWith('AIza');
        }

        function showGeminiKeyModal() {
            const modal = document.getElementById('gemini-key-modal');
            const input = document.getElementById('gemini-api-key-input');
            if (GEMINI_API_KEY) input.value = GEMINI_API_KEY;
            modal.classList.remove('hidden');
        }

        function closeGeminiKeyModal() {
            document.getElementById('gemini-key-modal').classList.add('hidden');
        }

        function saveGeminiKey() {
            const input = document.getElementById('gemini-api-key-input');
            const key = input.value.trim();

            if (!key || key.length < 10 || !key.startsWith('AIza')) {
                showToast('Please enter a valid Gemini API key (starts with AIza...)', 'error');
                return;
            }

            GEMINI_API_KEY = key;
            localStorage.setItem('gemini_api_key', key);
            closeGeminiKeyModal();
            updateApiKeyStatus();
            showToast('API key saved successfully!');
        }

        function updateOcrProgress(percentage, stage) {
            const bar = document.getElementById('ocr-progress-bar');
            const pct = document.getElementById('ocr-percentage');
            const stageText = document.getElementById('ocr-stage');
            const statusText = document.getElementById('ocr-status-text');
            
            if (bar) bar.style.width = percentage + '%';
            if (pct) pct.textContent = percentage + '%';
            if (stageText) stageText.textContent = stage;
            if (statusText) statusText.textContent = stage;
        }

        async function performGeminiOCR(imageDataUrl) {
            if (!isGeminiConfigured()) {
                throw new Error('Gemini API key not configured. Please add your API key in settings.');
            }

            const base64Image = imageDataUrl.split(',')[1];
            if (!base64Image) {
                throw new Error('Invalid image format');
            }

            const prompt = `You are an expert OCR system specialized in extracting data from truck driver timesheets.

Analyze this timesheet image and extract the following information:

1. WEEK ENDING date (usually in top right corner, format DD-MM-YY or similar)
2. For each day (SUN, MON, TUE, WED, THU, FRI, SAT):
   - Booking ON time (start time, 24-hour format)
   - Booking OFF time (end time, 24-hour format)
   - Location/depot code if visible

The timesheet has:
- "BOOKING ON" column with LOCATION and TIME sub-columns
- "BOOKING OFF" column with LOCATION and TIME sub-columns
- Days are listed as SUN AM/PM, MON AM/PM, etc.
- Times are in 24-hour format (e.g., 0758, 2040)

Return ONLY a JSON object in this exact format:
{
  "weekEnding": "DD-MM-YYYY",
  "days": {
    "SUN": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "MON": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "TUE": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "WED": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "THU": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "FRI": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"},
    "SAT": {"onTime": "HH:MM", "offTime": "HH:MM", "location": "code"}
  },
  "confidence": "high|medium|low"
}

Rules:
- Use null for missing times
- Convert all times to HH:MM format (e.g., "0758" → "07:58", "2040" → "20:40")
- If only one time found per day, assume it's the ON time
- Look carefully at handwritten text - it may be messy
- The WEEK ENDING date is usually near the top right
- Confidence is high if most fields are clear, medium if some unclear, low if many unclear`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.1,
                    maxOutputTokens: 2048
                }
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${apiUrl}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json();
                    
                    if (response.status === 400) {
                        throw new Error(`Invalid request: ${errorData.error?.message || 'Bad request'}`);
                    } else if (response.status === 401 || response.status === 403) {
                        throw new Error('Invalid API key. Please check your Gemini API key.');
                    } else if (response.status === 429) {
                        throw new Error('API quota exceeded. Please try again later.');
                    } else {
                        throw new Error(`API error (${response.status}): ${errorData.error?.message || 'Unknown error'}`);
                    }
                }

                const data = await response.json();

                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('No response from Gemini API. The image may be unclear.');
                }

                const text = data.candidates[0].content.parts[0].text;

                let parsedData;
                try {
                    const jsonMatch = text.match(/```json\s*([\s\S]*?)```/) || 
                                     text.match(/```\s*([\s\S]*?)```/) ||
                                     [null, text];
                    const jsonStr = jsonMatch[1] || text;
                    parsedData = JSON.parse(jsonStr);
                } catch (e) {
                    parsedData = extractDataFromText(text);
                }

                return parsedData;

            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please check your internet connection and try again.');
                }
                throw error;
            }
        }

        function extractDataFromText(text) {
            const data = {
                weekEnding: null,
                days: {},
                confidence: 'low'
            };

            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            days.forEach(day => {
                data.days[day] = { onTime: null, offTime: null, location: null };
            });

            const weekMatch = text.match(/weekEnding["\s:]+([^"\n,}]+)/i) ||
                             text.match(/week ending["\s:]+([^"\n,}]+)/i) ||
                             text.match(/(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})/);
            if (weekMatch) {
                data.weekEnding = weekMatch[1].trim();
            }

            days.forEach(day => {
                const dayPattern = new RegExp(`${day}["\\s:]+{([^}]+)}`, 'i');
                const dayMatch = text.match(dayPattern);

                if (dayMatch) {
                    const dayContent = dayMatch[1];

                    const onMatch = dayContent.match(/onTime["\s:]+([^"\n,}]+)/i) ||
                                   dayContent.match(/(\d{2}:\d{2})/);
                    const offMatch = dayContent.match(/offTime["\s:]+([^"\n,}]+)/i) ||
                                    dayContent.match(/(\d{2}:\d{2})/g);

                    if (onMatch) data.days[day].onTime = onMatch[1].replace(/"/g, '').trim();
                    if (offMatch) {
                        if (Array.isArray(offMatch)) {
                            data.days[day].offTime = offMatch[offMatch.length - 1].replace(/"/g, '').trim();
                        } else {
                            data.days[day].offTime = offMatch[1].replace(/"/g, '').trim();
                        }
                    }
                }
            });

            return data;
        }

        function convertGeminiToInternal(geminiData) {
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = {};

            let firstWorkingDay = null;
            let totalHours = 0;
            let workingDays = 0;

            days.forEach(day => {
                const geminiDay = geminiData.days?.[day] || {};
                const onTime = geminiDay.onTime || null;
                const offTime = geminiDay.offTime || null;
                const hasData = onTime && offTime;

                let hours = 0;
                if (hasData) {
                    hours = calculateHoursBetween(onTime, offTime);
                    totalHours += hours;
                    workingDays++;
                    if (!firstWorkingDay) firstWorkingDay = day;
                }

                dayData[day] = {
                    day: day,
                    onTime: onTime,
                    offTime: offTime,
                    hasData: hasData,
                    hours: Math.round(hours * 10) / 10,
                    location: geminiDay.location || null
                };
            });

            let weekEndingDate = null;
            if (geminiData.weekEnding) {
                weekEndingDate = parseWeekEndingDate(geminiData.weekEnding);
            }

            return {
                days: dayData,
                firstWorkingDay: firstWorkingDay,
                totalHours: Math.round(totalHours * 10) / 10,
                workingDays: workingDays,
                weekEnding: weekEndingDate,
                confidence: geminiData.confidence || 'medium',
                rawGeminiData: geminiData
            };
        }

        function parseWeekEndingDate(dateStr) {
            const formats = [
                /(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})/,
                /(\d{1,2})[-/](\d{1,2})[-/](\d{2})/,
                /(\d{1,2})\s+(\w+)\s+(\d{4})/i
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    let day, month, year;
                    
                    if (match[0].match(/\d{1,2}\s+\w+\s+\d{4}/)) {
                        day = parseInt(match[1]);
                        const monthNames = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                        month = monthNames.indexOf(match[2].toLowerCase());
                        year = parseInt(match[3]);
                    } else {
                        day = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        year = parseInt(match[3]);
                    }

                    if (year < 100) {
                        year = 2000 + year;
                    }

                    const date = new Date(year, month, day);
                    if (date.getDate() === day) {
                        return date;
                    }
                }
            }

            return null;
        }

        function calculateHoursBetween(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            if (isNaN(startHour) || isNaN(endHour)) return 0;

            let startMinutes = startHour * 60 + startMin;
            let endMinutes = endHour * 60 + endMin;

            if (endMinutes < startMinutes) {
                endMinutes += 24 * 60;
            }

            return (endMinutes - startMinutes) / 60;
        }

        async function startOCR() {
            if (!processedImage && !currentImage) {
                showToast('Timesheet photo is required', 'error');
                document.getElementById('timesheet-upload-zone').classList.add('required');
                document.getElementById('timesheet-upload-zone').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            if (!isGeminiConfigured()) {
                showGeminiKeyModal();
                return;
            }

            const imageToProcess = processedImage || currentImage;

            document.getElementById('ocr-error').classList.add('hidden');
            document.getElementById('scan-btn').classList.add('hidden');
            document.getElementById('ocr-progress').classList.remove('hidden');
            document.getElementById('auto-results').classList.add('hidden');

            updateOcrProgress(5, 'Preparing image...');

            try {
                await new Promise(r => setTimeout(r, 100));
                updateOcrProgress(15, 'Connecting to Gemini AI...');
                
                const geminiResult = await performGeminiOCR(imageToProcess);
                
                updateOcrProgress(80, 'Processing results...');
                
                autoDetectedData = convertGeminiToInternal(geminiResult);
                autoDetectedWeekEnding = autoDetectedData.weekEnding;

                if (autoDetectedWeekEnding) {
                    document.getElementById('scan-date-select').value = formatDateForInput(autoDetectedWeekEnding);
                    document.getElementById('scan-date-select').classList.add('auto-filled');
                    document.getElementById('auto-detected-badge').classList.remove('hidden');
                    updateScanWeekDisplay();
                }

                updateOcrProgress(100, 'Complete!');

                setTimeout(() => {
                    document.getElementById('ocr-progress').classList.add('hidden');
                    showAutoDetectionResults();
                }, 500);

                const confidenceEmoji = autoDetectedData.confidence === 'high' ? '✅' : 
                                       autoDetectedData.confidence === 'medium' ? '⚠️' : '❓';
                showToast(`${confidenceEmoji} Extracted ${autoDetectedData.workingDays} days with Gemini AI`);

            } catch (err) {
                console.error('OCR Error:', err);
                
                document.getElementById('ocr-progress').classList.add('hidden');
                document.getElementById('ocr-error').classList.remove('hidden');
                document.getElementById('scan-btn').classList.remove('hidden');
                
                let errorMsg = err.message || 'OCR failed. Please try again.';
                
                if (err.message.includes('API key')) {
                    errorMsg = 'Invalid API key. Please check your Gemini API key in Settings.';
                } else if (err.message.includes('quota')) {
                    errorMsg = 'API quota exceeded. Please check your Google AI Studio quota.';
                } else if (err.message.includes('network') || err.message.includes('fetch')) {
                    errorMsg = 'Network error. Please check your internet connection.';
                } else if (err.message.includes('timed out')) {
                    errorMsg = 'Request timed out. Please try again with a clearer image.';
                }

                document.getElementById('error-message').textContent = errorMsg;
                
                const debugInfo = document.getElementById('ocr-debug-info');
                debugInfo.textContent = `Error: ${err.message}\n\nStack: ${err.stack || 'No stack trace'}`;
                
                showToast(errorMsg, 'error');
            }
        }

        function retryOCR() {
            document.getElementById('ocr-error').classList.add('hidden');
            startOCR();
        }

        function showAutoDetectionResults() {
            document.getElementById('auto-results').classList.remove('hidden');
            
            if (autoDetectedWeekEnding) {
                document.getElementById('result-week-ending').textContent = 
                    autoDetectedWeekEnding.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } else {
                document.getElementById('result-week-ending').textContent = 'Not detected';
            }
            
            const workingDays = Object.values(autoDetectedData.days).filter(d => d.hasData).length;
            document.getElementById('result-working-days').textContent = workingDays + ' days';
            document.getElementById('result-total-shifts').textContent = workingDays + ' shifts';
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
            
            const confidence = workingDays >= 3 ? 'High' : workingDays >= 1 ? 'Medium' : 'Low';
            const badge = document.getElementById('confidence-badge');
            badge.textContent = confidence + ' Confidence';
            badge.className = 'text-xs px-2 py-1 rounded-full ' + 
                (confidence === 'High' ? 'bg-green-200 text-green-800' :
                 confidence === 'Medium' ? 'bg-yellow-200 text-yellow-800' :
                 'bg-red-200 text-red-800');
            
            renderDetectionGrid();
            renderCorrectionTable();
        }

        function renderDetectionGrid() {
            const grid = document.getElementById('detection-grid');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            grid.innerHTML = days.map((day, idx) => {
                const data = autoDetectedData.days[day];
                const isFirst = day === autoDetectedData.firstWorkingDay;
                
                let cellClass = 'day-cell';
                if (data.hasData) cellClass += ' has-data';
                if (isFirst) cellClass += ' first-day';
                
                let content = `<div class="font-bold text-xs mb-1 ${isFirst ? 'text-green-600' : ''}">${dayLabels[idx]}</div>`;
                
                if (data.hasData) {
                    content += `<div class="time-display text-green-700">${data.onTime || '--:--'}</div>`;
                    content += `<div class="text-[0.6rem] text-gray-400">to</div>`;
                    content += `<div class="time-display text-blue-700">${data.offTime || '--:--'}</div>`;
                } else {
                    content += '<div class="text-gray-300">-</div>';
                }
                
                if (isFirst) {
                    content += '<div class="absolute -top-2 -left-2 bg-green-500 text-white text-[8px] px-1 rounded">1st</div>';
                }
                
                return `<div class="${cellClass}">${content}</div>`;
            }).join('');
        }

        function renderCorrectionTable() {
            const container = document.getElementById('correction-table');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let html = '';
            
            days.forEach((day, idx) => {
                const data = autoDetectedData.days[day];
                if (data.hasData || idx === 0) {
                    const isFirst = day === autoDetectedData.firstWorkingDay;
                    
                    html += `
                        <div class="correction-row ${isFirst ? 'ring-2 ring-green-400 rounded-lg' : ''} ${!data.hasData ? 'opacity-50' : ''}">
                            <div class="day-label ${isFirst ? 'first-day' : ''}">
                                ${dayNames[idx]}${isFirst ? '*' : ''}
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <span class="column-indicator col-on"></span>Booking ON
                                </label>
                                <input type="time" 
                                    value="${data.onTime || ''}" 
                                    onchange="updateDayTime('${day}', 'onTime', this.value)">
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <span class="column-indicator col-off"></span>Booking OFF
                                </label>
                                <input type="time" 
                                    value="${data.offTime || ''}" 
                                    onchange="updateDayTime('${day}', 'offTime', this.value)">
                            </div>
                            <div>
                                <label>Hrs</label>
                                <input type="number" 
                                    value="${data.hours || ''}" 
                                    step="0.5" min="0" max="24"
                                    onchange="updateDayTime('${day}', 'hours', this.value)">
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function updateDayTime(day, field, value) {
            if (!autoDetectedData) return;
            
            const dayData = autoDetectedData.days[day];
            if (!dayData) return;
            
            if (field === 'onTime') dayData.onTime = value || null;
            if (field === 'offTime') dayData.offTime = value || null;
            if (field === 'hours') dayData.hours = parseFloat(value) || 0;
            
            if (value) dayData.hasData = true;
            
            let total = 0;
            Object.values(autoDetectedData.days).forEach(d => {
                if (d.hours) total += d.hours;
            });
            autoDetectedData.totalHours = Math.round(total * 10) / 10;
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
        }

        function resetToAuto() {
            if (confirm('Reset all times to auto-detected values?')) {
                showToast('Reset to auto-detected values');
                renderCorrectionTable();
            }
        }

        function showManualEntryFallback() {
            document.getElementById('ocr-error').classList.add('hidden');
            document.getElementById('auto-results').classList.remove('hidden');
            
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = {};
            days.forEach(day => {
                dayData[day] = { day: day, onTime: null, offTime: null, hasData: false, hours: 0 };
            });
            
            autoDetectedData = {
                days: dayData,
                firstWorkingDay: null,
                totalHours: 0,
                workingDays: 0,
                rawText: 'MANUAL_ENTRY'
            };
            
            showToast('OCR failed - please enter times manually', 'error');
            renderDetectionGrid();
            renderCorrectionTable();
        }

        function reprocessImage() {
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            document.getElementById('scan-date-select').classList.remove('auto-filled');
            document.getElementById('auto-detected-badge').classList.add('hidden');
            startOCR();
        }

        async function confirmAndSave() {
            if (!autoDetectedData) return;
            
            const weekEnding = document.getElementById('scan-date-select').value;
            if (!weekEnding) {
                showToast('Please select week ending date', 'error');
                return;
            }
            
            const endDate = parseDate(weekEnding);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = [];
            let totalHours = 0;
            let longDays = 0;
            
            days.forEach((dayName, idx) => {
                const dayKey = dayKeys[idx];
                const detected = autoDetectedData.days[dayKey];
                
                let hours = 0;
                let start = '-';
                let end = '-';
                
                if (detected && detected.hasData) {
                    start = detected.onTime || '-';
                    end = detected.offTime || '-';
                    hours = detected.hours || 0;
                    
                    if (hours === 0 && start !== '-' && end !== '-') {
                        hours = Math.round(calculateHoursBetween(start, end) * 10) / 10;
                    }
                    
                    totalHours += hours;
                    if (hours > 10) longDays++;
                }
                
                dayData.push({
                    day: dayName,
                    hours: Math.round(hours * 10) / 10,
                    start: start,
                    end: end,
                    rest: hours > 0 ? '11h' : '-',
                    flag: hours > 10 ? 'warning' : (hours > 0 ? 'ok' : 'none')
                });
            });
            
            const timesheetId = Date.now().toString();
            const imageIds = { front: `${timesheetId}_front` };
            
            const imageToSave = processedImage || currentImage;
            await saveToStore(STORES.images, imageIds.front, { data: imageToSave });
            
            // Save additional documents if present
            for (let i = 1; i <= 3; i++) {
                const doc = currentDocs[i];
                if (doc) {
                    const docId = `doc_${currentUser.username}_${formatDateForInput(startDate)}_${i}_${Date.now()}`;
                    await saveToStore(STORES.documents, docId, {
                        weekStart: formatDateForInput(startDate),
                        weekEnd: weekEnding,
                        docNum: i,
                        docName: DOC_NAMES[i],
                        filename: doc.name,
                        fileType: doc.type,
                        fileSize: doc.size,
                        data: doc.dataUrl,
                        uploadedAt: new Date().toISOString()
                    });
                }
            }
            
            const timesheet = {
                id: parseInt(timesheetId),
                weekStart: formatDateForInput(startDate),
                weekEnd: weekEnding,
                weekRange: formatWeekRange(startDate, endDate),
                totalHours: Math.round(totalHours * 10) / 10,
                longDays,
                lowRestDays: 0,
                firstWorkingDay: autoDetectedData.firstWorkingDay,
                pattern: 'standard',
                imageIds,
                days: dayData,
                uploadedAt: new Date().toISOString(),
                ocrVersion: APP_VERSION,
                autoDetectedDate: autoDetectedWeekEnding ? formatDateForInput(autoDetectedWeekEnding) : null,
                archived: false
            };
            
            const existing = DB_LS.getTimesheets(currentUser.username);
            existing.push(timesheet);
            DB_LS.saveTimesheets(currentUser.username, existing);
            
            resetScanForm();
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            
            renderCalendar();
            updateStats();
            renderRecent();
            checkStorageQuota();
            
            const msg = autoDetectedData.firstWorkingDay ? 
                `Saved! ${autoDetectedData.firstWorkingDay} start, ${totalHours.toFixed(1)}h total` :
                `Saved! ${totalHours.toFixed(1)}h total`;
            
            showToast(msg);
            switchView('dashboard');
        }

        function resetScanForm() {
            currentImage = null;
            processedImage = null;
            autoDetectedData = null;
            autoDetectedWeekEnding = null;
            ocrAttempts = 0;
            lastOcrResult = null;
            
            // Reset documents
            for (let i = 1; i <= 3; i++) {
                currentDocs[i] = null;
                
                const item = document.getElementById(`doc-${i}-item`);
                const icon = document.getElementById(`doc-${i}-icon`);
                const status = document.getElementById(`doc-${i}-status`);
                const preview = document.getElementById(`doc-${i}-preview`);
                const input = document.getElementById(`file-doc-${i}`);
                const actions = document.getElementById(`doc-${i}-actions`);
                
                item.classList.remove('has-file');
                
                icon.className = `fas ${DOC_ICONS[i]} text-gray-400`;
                icon.classList.remove('hidden');
                
                status.textContent = 'Add';
                preview.src = '';
                preview.classList.add('hidden');
                input.value = '';
                
                if (actions) {
                    actions.style.display = 'none';
                }
            }
            
            // Reset badge
            updateDocCountBadge();
            
            // Reset timesheet upload
            document.getElementById('preview-front').src = '';
            document.getElementById('preview-front').classList.add('hidden');
            document.getElementById('upload-front-default').classList.remove('hidden');
            document.getElementById('file-front').value = '';
            document.getElementById('front-status').textContent = 'Required';
            document.getElementById('front-status').className = 'text-xs text-red-500 font-medium';
            document.getElementById('timesheet-upload-zone').classList.remove('required');
            document.getElementById('scan-date-select').classList.remove('auto-filled');
            document.getElementById('auto-detected-badge').classList.add('hidden');
            
            const today = new Date();
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + (6 - today.getDay()));
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
        }

        function toggleDebugInfo() {
            const debugInfo = document.getElementById('ocr-debug-info');
            debugInfo.classList.toggle('hidden');
        }

        // ==================== ARCHIVE FEATURE ====================
        async function archiveSelectedWeek() {
            if (!selectedWeekStart) return;
            
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const tsIndex = timesheets.findIndex(t => t.weekStart === selectedWeekStart);
            
            if (tsIndex === -1) return;
            
            const ts = timesheets[tsIndex];
            ts.archived = true;
            ts.archivedAt = new Date().toISOString();
            
            await saveToStore(STORES.archives, `archive_${currentUser.username}_${ts.weekStart}`, ts);
            
            timesheets.splice(tsIndex, 1);
            DB_LS.saveTimesheets(currentUser.username, timesheets);
            
            document.getElementById('week-preview').classList.add('hidden');
            selectedWeekStart = null;
            
            renderCalendar();
            updateStats();
            renderRecent();
            showToast('Week archived successfully');
        }

        async function unarchiveWeek(weekStart) {
            const archiveKey = `archive_${currentUser.username}_${weekStart}`;
            const archived = await getFromStore(STORES.archives, archiveKey);
            
            if (!archived) {
                showToast('Archive not found', 'error');
                return;
            }
            
            delete archived.archived;
            delete archived.archivedAt;
            
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            timesheets.push(archived);
            DB_LS.saveTimesheets(currentUser.username, timesheets);
            
            await deleteFromStore(STORES.archives, archiveKey);
            
            renderCalendar();
            updateStats();
            renderRecent();
            showToast('Week restored from archive');
        }

        function showArchiveView() {
            switchView('archive');
            renderArchiveList();
        }

        async function renderArchiveList() {
            const list = document.getElementById('archive-list');
            const archives = await getAllFromStore(STORES.archives);
            const userArchives = archives.filter(a => a.id && a.id.includes(currentUser.username));
            
            if (userArchives.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-archive text-4xl mb-2"></i><p>No archived weeks</p></div>';
                return;
            }
            
            list.innerHTML = userArchives.map(ts => `
                <div class="archive-item bg-gray-100 dark:bg-dark-surface rounded-2xl p-4 border border-gray-200 dark:border-gray-700 flex justify-between items-center cursor-pointer" onclick="restoreArchivedWeek('${ts.weekStart}')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-400 flex items-center justify-center">
                            <i class="fas fa-archive text-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm text-gray-700 dark:text-gray-300">${ts.weekRange}</h4>
                            <p class="text-xs text-gray-500">${ts.totalHours}h • Archived ${new Date(ts.archivedAt).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <button class="px-3 py-1 bg-primary text-white text-xs rounded-lg" onclick="event.stopPropagation(); restoreArchivedWeek('${ts.weekStart}')">
                        Restore
                    </button>
                </div>
            `).join('');
        }

        function manageArchives() {
            showArchiveView();
        }

        // ==================== DATA MANAGEMENT ====================
        function showDeleteOptions(type) {
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-modal-title');
            const content = document.getElementById('delete-options-content');
            
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            
            if (type === 'week') {
                title.textContent = 'Delete Specific Week';
                const weeks = [...new Set(timesheets.map(ts => ts.weekRange))];
                
                content.innerHTML = weeks.length === 0 ? '<p class="text-gray-500 text-center py-4">No weeks to delete</p>' :
                    weeks.map(week => {
                        const ts = timesheets.find(t => t.weekRange === week);
                        return `
                            <button onclick="confirmDeleteWeek('${ts.weekStart}')" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                <div>
                                    <span class="font-medium text-gray-900 dark:text-white block">${week}</span>
                                    <span class="text-xs text-gray-500">${ts.totalHours}h • ${ts.firstWorkingDay || 'Unknown'} start</span>
                                </div>
                                <i class="fas fa-trash text-red-500"></i>
                            </button>
                        `;
                    }).join('');
                    
            } else if (type === 'month') {
                title.textContent = 'Delete Month';
                const months = {};
                timesheets.forEach(ts => {
                    const date = parseDate(ts.weekStart);
                    const key = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!months[key]) months[key] = { year: date.getFullYear(), month: date.getMonth(), count: 0, hours: 0 };
                    months[key].count++;
                    months[key].hours += ts.totalHours;
                });
                
                content.innerHTML = Object.keys(months).length === 0 ? '<p class="text-gray-500 text-center py-4">No data to delete</p>' :
                    Object.values(months).map(m => `
                        <button onclick="confirmDeleteMonth(${m.year}, ${m.month})" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <div>
                                <span class="font-medium text-gray-900 dark:text-white block">${new Date(m.year, m.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                                <span class="text-xs text-gray-500">${m.count} weeks • ${m.hours.toFixed(1)}h</span>
                            </div>
                            <i class="fas fa-trash text-red-500"></i>
                        </button>
                    `).join('');
            }
            
            modal.classList.remove('hidden');
        }

        async function showDeleteVOROptions() {
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-modal-title');
            const content = document.getElementById('delete-options-content');
            
            title.textContent = 'Delete VOR Reports';
            
            const vorReports = await getVORReportsForUser(currentUser.username);
            
            if (vorReports.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-4">No VOR reports to delete</p>';
            } else {
                content.innerHTML = vorReports.map(vor => `
                    <button onclick="confirmDeleteVOR('${vor.id}')" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                        <div>
                            <span class="font-medium text-gray-900 dark:text-white block">Defect #${vor.defectNumber}</span>
                            <span class="text-xs text-gray-500">${vor.date} • ${vor.regNumber || 'No reg'}</span>
                        </div>
                        <i class="fas fa-trash text-red-500"></i>
                    </button>
                `).join('');
            }
            
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        function confirmDeleteWeek(weekStart) {
            if (confirm('Delete this week permanently?')) {
                deleteWeek(weekStart);
                closeDeleteModal();
            }
        }

        async function deleteWeek(weekStart) {
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === weekStart);
            
            if (ts && ts.imageIds.front) await deleteFromStore(STORES.images, ts.imageIds.front);
            
            const docs = await getDocumentsForWeek(weekStart);
            for (const doc of docs) {
                await deleteFromStore(STORES.documents, doc.id);
            }
            
            const updated = timesheets.filter(t => t.weekStart !== weekStart);
            DB_LS.saveTimesheets(currentUser.username, updated);
            
            renderCalendar();
            updateStats();
            renderRecent();
            checkStorageQuota();
            
            if (selectedWeekStart === weekStart) {
                document.getElementById('week-preview').classList.add('hidden');
                selectedWeekStart = null;
            }
            
            showToast('Week deleted');
        }

        function confirmDeleteMonth(year, month) {
            if (confirm(`Delete all data for ${new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}?`)) {
                deleteMonthData(year, month);
                closeDeleteModal();
            }
        }

        async function deleteMonthData(year, month) {
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const toDelete = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            
            for (const ts of toDelete) {
                if (ts.imageIds.front) await deleteFromStore(STORES.images, ts.imageIds.front);
                const docs = await getDocumentsForWeek(ts.weekStart);
                for (const doc of docs) {
                    await deleteFromStore(STORES.documents, doc.id);
                }
            }
            
            const remaining = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return !(d.getFullYear() === year && d.getMonth() === month);
            });
            
            DB_LS.saveTimesheets(currentUser.username, remaining);
            renderCalendar();
            updateStats();
            renderRecent();
            checkStorageQuota();
            showToast('Month deleted');
        }

        async function confirmDeleteVOR(vorId) {
            if (confirm('Delete this VOR report permanently?')) {
                await deleteVORReport(vorId);
                closeDeleteModal();
            }
        }

        async function deleteVORReport(vorId) {
            const vor = await getFromStore(STORES.vorReports, vorId);
            if (vor) {
                if (vor.mainImageId) await deleteFromStore(STORES.images, vor.mainImageId);
                if (vor.additionalImageId) await deleteFromStore(STORES.images, vor.additionalImageId);
                await deleteFromStore(STORES.vorReports, vorId);
            }
            renderHistory();
            showToast('VOR report deleted');
        }

        async function deleteAllData() {
            if (confirm('DELETE ALL TIMESHEET DATA?\n\nThis will remove every timesheet and document. This cannot be undone.')) {
                if (confirm('Are you absolutely sure?')) {
                    await clearAllStores();
                    
                    DB_LS.saveTimesheets(currentUser.username, []);
                    renderCalendar();
                    updateStats();
                    renderRecent();
                    document.getElementById('week-preview').classList.add('hidden');
                    checkStorageQuota();
                    showToast('All data deleted');
                }
            }
        }

        // ==================== ACCOUNT DELETION ====================
        function showRemoveAccountConfirm() {
            document.getElementById('remove-account-modal').classList.remove('hidden');
        }

        function hideRemoveAccountModal() {
            document.getElementById('remove-account-modal').classList.add('hidden');
        }

        async function executeRemoveAccount() {
            hideRemoveAccountModal();
            
            const removalScreen = document.getElementById('final-removal-screen');
            removalScreen.classList.remove('hidden');
            
            try {
                await clearAllStores();
            } catch (e) {
                console.log('Store clearing failed:', e);
            }
            
            if (currentUser) {
                DB_LS.deleteUser(currentUser.username);
            }
            
            const keysToRemove = Object.keys(localStorage).filter(k => k.startsWith('ts_'));
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            await new Promise(r => setTimeout(r, 300));
            document.getElementById('removal-check').classList.remove('opacity-0');
            await new Promise(r => setTimeout(r, 300));
            document.getElementById('removal-title').classList.remove('opacity-0');
            await new Promise(r => setTimeout(r, 200));
            document.getElementById('removal-text').classList.remove('opacity-0');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                } catch (e) {
                    console.log('Cache clearing failed:', e);
                }
            }
        }

        // ==================== HISTORY & VOR ====================
        async function renderHistory(filter = 'all') {
            // Render Timesheets
            const list = document.getElementById('history-list');
            let timesheets = DB_LS.getTimesheets(currentUser.username);
            timesheets.sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart));
            
            const now = new Date();
            if (filter === 'month') {
                timesheets = timesheets.filter(t => {
                    const d = parseDate(t.weekStart);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (filter === 'year') {
                timesheets = timesheets.filter(t => parseDate(t.weekStart).getFullYear() === now.getFullYear());
            }
            
            if (timesheets.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><p>No timesheets found</p></div>';
            } else {
                list.innerHTML = timesheets.map(ts => `
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer" onclick="openWeekDetailsById(${ts.id})">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl ${ts.totalHours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-600' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex items-center justify-center">
                                <i class="fas fa-calendar-week text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm text-gray-900 dark:text-white">${ts.weekRange}</h4>
                                <p class="text-xs text-gray-500">${ts.totalHours}h • ${ts.firstWorkingDay || '?'} start</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                `).join('');
            }

            // Render VOR Reports
            await renderVORHistory(filter);
        }

        async function renderVORHistory(filter = 'all') {
            const list = document.getElementById('vor-history-list');
            let vorReports = await getVORReportsForUser(currentUser.username);
            
            const now = new Date();
            if (filter === 'month') {
                vorReports = vorReports.filter(v => {
                    const d = parseDate(v.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (filter === 'year') {
                vorReports = vorReports.filter(v => parseDate(v.date).getFullYear() === now.getFullYear());
            }
            
            if (vorReports.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><p>No VOR reports found</p></div>';
                return;
            }
            
            list.innerHTML = vorReports.map(vor => `
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer vor-card" onclick="openVORDetails('${vor.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm text-gray-900 dark:text-white">Defect #${vor.defectNumber}</h4>
                            <p class="text-xs text-gray-500">${vor.date} • ${vor.regNumber || 'No reg'} • ${vor.time || 'No time'}</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            `).join('');
        }

        // ==================== UPDATED VOR SEARCH FUNCTION ====================
        async function searchDefectNumber() {
            const searchTerm = document.getElementById('defect-search-input').value.trim();
            if (!searchTerm) {
                renderHistory();
                return;
            }
            
            const searchTermLower = searchTerm.toLowerCase();
            const vorReports = await getVORReportsForUser(currentUser.username);
            
            // Search in both defectNumber and regNumber fields
            const filtered = vorReports.filter(v => {
                const defectMatch = v.defectNumber && v.defectNumber.toLowerCase().includes(searchTermLower);
                const regMatch = v.regNumber && v.regNumber.toLowerCase().includes(searchTermLower);
                return defectMatch || regMatch;
            });
            
            const list = document.getElementById('vor-history-list');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><p>No matching defects found</p></div>';
            } else {
                list.innerHTML = filtered.map(vor => `
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border-2 border-orange-400 dark:border-orange-600 flex justify-between items-center cursor-pointer vor-card" onclick="openVORDetails('${vor.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm text-gray-900 dark:text-white">Defect #${vor.defectNumber}</h4>
                                <p class="text-xs text-gray-500">${vor.date} • ${vor.regNumber || 'No reg'}</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-orange-500"></i>
                    </div>
                `).join('');
            }
            
            // Clear timesheets when searching defects
            document.getElementById('history-list').innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><p>Search active - showing defects only</p></div>';
            
            // Show search summary toast
            if (filtered.length > 0) {
                showToast(`Found ${filtered.length} VOR report${filtered.length !== 1 ? 's' : ''} matching "${searchTerm}"`);
            } else {
                showToast(`No VOR reports found for "${searchTerm}"`, 'error');
            }
        }

        function clearDefectSearch() {
            document.getElementById('defect-search-input').value = '';
            renderHistory();
            showToast('Search cleared');
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                }
            });
            renderHistory(type);
        }

        function openWeekDetailsById(id) {
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.id === id);
            if (ts) openWeekDetails(ts);
        }

        async function openVORDetails(vorId) {
            const vor = await getFromStore(STORES.vorReports, vorId);
            if (!vor) {
                showToast('VOR report not found', 'error');
                return;
            }
            
            const mainImg = vor.mainImageId ? await getFromStore(STORES.images, vor.mainImageId) : null;
            const additionalImg = vor.additionalImageId ? await getFromStore(STORES.images, vor.additionalImageId) : null;
            
            document.getElementById('vor-detail-content').innerHTML = `
                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-2xl p-4 border border-orange-200 dark:border-orange-800 mb-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Defect Number:</span>
                            <span class="font-bold text-gray-900 dark:text-white font-mono text-lg block">${vor.defectNumber}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Date:</span>
                            <span class="font-bold text-gray-900 dark:text-white block">${vor.date}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Time:</span>
                            <span class="font-bold text-gray-900 dark:text-white block">${vor.time || 'Not recorded'}</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Reg/Trailer:</span>
                            <span class="font-bold text-gray-900 dark:text-white font-mono block">${vor.regNumber || 'Not recorded'}</span>
                        </div>
                    </div>
                </div>
                
                ${vor.natureOfDefect ? `
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Nature of Defect</h4>
                    <p class="text-gray-700 dark:text-gray-300 text-sm">${vor.natureOfDefect}</p>
                </div>
                ` : ''}
                
                ${mainImg ? `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Defect Photo</h4>
                    <img src="${mainImg.data}" class="w-full rounded-xl cursor-pointer" onclick="viewVORImage('${vor.mainImageId}')" alt="Defect">
                </div>
                ` : ''}
                
                ${additionalImg ? `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Additional Photo</h4>
                    <img src="${additionalImg.data}" class="w-full rounded-xl cursor-pointer" onclick="viewVORImage('${vor.additionalImageId}')" alt="Additional">
                </div>
                ` : ''}
                
                <button onclick="deleteVORReport('${vor.id}'); closeVORDetailModal();" class="w-full py-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Delete This Report
                </button>
            `;
            
            document.getElementById('vor-detail-modal').classList.remove('hidden');
        }

        async function viewVORImage(imageId) {
            const img = await getFromStore(STORES.images, imageId);
            if (img) {
                const docData = {
                    dataUrl: img.data,
                    name: 'VOR_Defect_Photo.jpg',
                    type: 'image/jpeg',
                    docName: 'VOR Defect Photo'
                };
                openFullscreenViewer(img.data, 'VOR_Defect_Photo.jpg', 'VOR Defect Photo', docData);
            }
        }

        function closeVORDetailModal() {
            document.getElementById('vor-detail-modal').classList.add('hidden');
        }

        // ==================== WEEK DETAILS MODAL ====================
        async function openWeekDetails(ts) {
            currentTimesheetForShare = ts;
            
            document.getElementById('week-modal-title').textContent = ts.weekRange;
            const content = document.getElementById('week-modal-content');
            
            const frontImg = await getFromStore(STORES.images, ts.imageIds.front);
            const docs = await getDocumentsForWeek(ts.weekStart);
            
            let docsHtml = '';
            if (docs.length > 0) {
                docsHtml = `
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800 mb-4">
                        <h4 class="font-semibold text-purple-800 dark:text-purple-300 mb-2">
                            <i class="fas fa-paperclip mr-2"></i>Attached Documents (${docs.length})
                        </h4>
                        <div class="grid grid-cols-3 gap-2">
                            ${docs.map((doc, idx) => `
                                <div class="attached-doc-thumbnail" onclick="openHistoryDocument('${doc.id}')">
                                    ${doc.fileType.startsWith('image/') ? 
                                        `<img src="${doc.data}" class="w-full h-20 object-cover">` :
                                        `<div class="w-full h-20 flex items-center justify-center bg-red-100 dark:bg-red-900/30 text-red-600">
                                            <i class="fas fa-file-pdf text-2xl"></i>
                                        </div>`
                                    }
                                    <div class="doc-overlay">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-1 truncate">
                                        ${doc.docName || doc.filename}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            let timesheetImageHtml = '';
            if (frontImg) {
                timesheetImageHtml = `
                    <div class="mb-4 relative group">
                        <img src="${frontImg.data}" class="w-full rounded-xl cursor-pointer" onclick="viewTimesheetFullScreen()" alt="Timesheet">
                        
                        <div class="absolute top-3 right-3 flex gap-2">
                            <button onclick="shareMainTimesheet(event)" class="bg-blue-500 hover:bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-transform hover:scale-110" title="Share Timesheet">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 rounded-b-xl">
                            <p class="text-white text-sm font-medium">
                                <i class="fas fa-image mr-2"></i>Main Timesheet Image
                            </p>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                ${timesheetImageHtml}
                
                ${docsHtml}
                
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800 mb-4">
                    <p class="text-sm text-green-800 dark:text-green-300">
                        <i class="fas fa-robot mr-2"></i>Auto-detected • First: ${ts.firstWorkingDay || 'Unknown'}
                        ${ts.autoDetectedDate ? `• Date auto-filled` : ''}
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${ts.totalHours}h</p>
                        <p class="text-xs text-blue-600 dark:text-blue-400">Total Hours</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${ts.longDays}</p>
                        <p class="text-xs text-orange-600 dark:text-orange-400">Long Days</p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400">${ts.lowRestDays}</p>
                        <p class="text-xs text-red-600 dark:text-red-400">Low Rest</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-surface rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-dark-card">
                            <tr>
                                <th class="text-left p-3 text-gray-500 font-medium">Day</th>
                                <th class="text-left p-3 text-gray-500 font-medium">Booking On</th>
                                <th class="text-left p-3 text-gray-500 font-medium">Booking Off</th>
                                <th class="text-right p-3 text-gray-500 font-medium">Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ts.days.map(day => `
                                <tr class="border-t border-gray-100 dark:border-gray-700 ${day.hours > 0 ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''}">
                                    <td class="p-3 font-medium">${day.day}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.start}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.end}</td>
                                    <td class="p-3 text-right font-bold ${day.hours > 10 ? 'text-orange-500' : 'text-green-600'}">${day.hours > 0 ? day.hours + 'h' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <button onclick="deleteWeek('${ts.weekStart}')" class="w-full py-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-colors mt-4">
                    <i class="fas fa-trash mr-2"></i>Delete This Week
                </button>
            `;
            
            document.getElementById('week-modal').classList.remove('hidden');
        }

        async function viewTimesheetFullScreen() {
            if (!currentTimesheetForShare) return;
            
            const frontImg = await getFromStore(STORES.images, currentTimesheetForShare.imageIds.front);
            if (!frontImg) {
                showToast('Image not found', 'error');
                return;
            }
            
            const docData = {
                dataUrl: frontImg.data,
                name: `timesheet_${currentTimesheetForShare.weekRange.replace(/\s/g, '_')}.jpg`,
                type: 'image/jpeg',
                docName: 'Main Timesheet'
            };
            
            openFullscreenViewer(frontImg.data, docData.name, 'Main Timesheet', docData);
        }

        async function shareMainTimesheet(event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!currentTimesheetForShare) return;
            
            const frontImg = await getFromStore(STORES.images, currentTimesheetForShare.imageIds.front);
            if (!frontImg) {
                showToast('Image not found', 'error');
                return;
            }
            
            const docData = {
                dataUrl: frontImg.data,
                name: `timesheet_${currentTimesheetForShare.weekRange.replace(/\s/g, '_')}.jpg`,
                type: 'image/jpeg',
                docName: 'Main Timesheet'
            };
            
            if (navigator.share && navigator.canShare) {
                try {
                    const response = await fetch(frontImg.data);
                    const blob = await response.blob();
                    const file = new File([blob], docData.name, { type: 'image/jpeg' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'Timesheet - ' + currentTimesheetForShare.weekRange,
                            text: `Timesheet for week ${currentTimesheetForShare.weekRange}`,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log('Native share failed:', e);
                }
            }
            
            openFullscreenViewer(frontImg.data, docData.name, 'Main Timesheet', docData);
            showToast('Tap Share button to download', 'info');
        }

        async function openHistoryDocument(docId) {
            const doc = await getFromStore(STORES.documents, docId);
            if (!doc) return;
            
            if (doc.fileType.startsWith('image/')) {
                openFullscreenViewer(doc.data, doc.filename, doc.docName || 'Document', doc);
            } else {
                const link = document.createElement('a');
                link.href = doc.data;
                link.download = doc.filename;
                link.click();
                showToast('PDF download started');
            }
        }

        function closeWeekModal() {
            document.getElementById('week-modal').classList.add('hidden');
            currentTimesheetForShare = null;
        }

        function updateStats() {
            const timesheets = DB_LS.getTimesheets(currentUser.username);
            const now = new Date();
            
            const monthSheets = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const monthHours = monthSheets.reduce((sum, t) => sum + t.totalHours, 0);
            
            document.getElementById('stat-month-hours').textContent = monthHours.toFixed(1) + 'h';
        }

        function renderRecent() {
            const list = document.getElementById('recent-list');
            const timesheets = DB_LS.getTimesheets(currentUser.username)
                .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt))
                .slice(0, 3);
            
            if (timesheets.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No uploads yet</p>';
                return;
            }
            
            list.innerHTML = timesheets.map(ts => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-dark-surface rounded-xl cursor-pointer" onclick="openWeekDetailsById(${ts.id})">
                    <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-sm text-gray-900 dark:text-white">${ts.weekRange}</p>
                        <p class="text-xs text-gray-500">${ts.totalHours} hours • ${ts.firstWorkingDay || 'Unknown'} start</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>
            `).join('');
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-primary', 'vor-active');
                el.classList.add('text-gray-400');
            });
            
            if (viewName === 'vor') {
                document.getElementById('vor-view').classList.remove('hidden');
                const activeBtn = document.querySelector(`[data-view="vor"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'vor-active');
                    activeBtn.classList.remove('text-gray-400');
                }
                updateApiKeyStatus();
            } else {
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
                const activeBtn = document.querySelector(`[data-view="${viewName}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'text-primary');
                    activeBtn.classList.remove('text-gray-400');
                }
            }
            
            if (viewName === 'history') renderHistory();
            if (viewName === 'dashboard') { renderCalendar(); updateStats(); }
            if (viewName === 'scan') updateApiKeyStatus();
            if (viewName === 'settings') { 
                updateApiKeyStatus(); 
                checkStorageQuota(); 
                updateStorageWidgetToggle();
                updateBiometricSettingsUI();
            }
            if (viewName === 'archive') renderArchiveList();
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');
            
            msgEl.textContent = message;
            iconEl.className = type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 
                              type === 'info' ? 'fas fa-info-circle text-blue-400' :
                              'fas fa-check-circle text-green-400';
            
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 3000);
        }

        // ==================== BIOMETRIC SETTINGS ====================
        
        async function updateBiometricSettingsUI() {
            if (!currentUser) return;
            
            const title = document.getElementById('biometric-setting-title');
            const status = document.getElementById('biometric-setting-status');
            const iconStatus = document.getElementById('biometric-icon-status');
            const toggle = document.getElementById('biometric-toggle');
            const infoBox = document.getElementById('biometric-info-box');
            const infoText = document.getElementById('biometric-info-text');
            const setupBtn = document.getElementById('setup-biometric-btn');

            const deviceInfo = getDeviceInfo();

            if (!biometricAvailable) {
                title.textContent = deviceInfo.platform;
                status.textContent = 'Not available on this device';
                status.className = 'text-xs text-gray-500';
                iconStatus.innerHTML = '<i class="fas fa-times text-gray-400"></i>';
                iconStatus.className = 'w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center';
                toggle.classList.remove('active');
                toggle.style.display = 'none';
                infoBox.classList.remove('hidden');
                infoText.textContent = 'Your device does not support biometric authentication or it is not enabled in system settings.';
                setupBtn.classList.add('hidden');
                return;
            }

            // Check if user has biometric registered
            const cred = await getBiometricCredentials(currentUser.username);
            const userEnabled = localStorage.getItem(`biometric_${currentUser.username}`) === 'true';

            if (cred && userEnabled) {
                title.textContent = deviceInfo.platform;
                status.textContent = 'Enabled and ready';
                status.className = 'text-xs text-green-600 dark:text-green-400';
                iconStatus.innerHTML = '<i class="fas fa-check text-white"></i>';
                iconStatus.className = 'w-10 h-10 rounded-full bg-green-500 flex items-center justify-center';
                toggle.classList.add('active');
                toggle.style.display = 'block';
                infoBox.classList.add('hidden');
                setupBtn.classList.add('hidden');
            } else {
                title.textContent = deviceInfo.platform;
                status.textContent = 'Not set up';
                status.className = 'text-xs text-gray-500';
                iconStatus.innerHTML = '<i class="fas fa-fingerprint text-gray-400"></i>';
                iconStatus.className = 'w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center';
                toggle.classList.remove('active');
                toggle.style.display = 'block';
                infoBox.classList.remove('hidden');
                infoText.textContent = `Enable ${deviceInfo.platform} for faster, more secure login on this device. Your biometric data never leaves this device.`;
                setupBtn.classList.remove('hidden');
            }
        }

        async function toggleBiometricAuth() {
            if (!currentUser) return;
            
            const toggle = document.getElementById('biometric-toggle');
            const isEnabled = toggle.classList.contains('active');
            
            if (isEnabled) {
                // Disable biometric
                if (confirm('Disable Face ID / Touch ID login?')) {
                    await deleteBiometricCredential(currentUser.username);
                    biometricEnabled = false;
                    localStorage.setItem(`biometric_${currentUser.username}`, 'false');
                    toggle.classList.remove('active');
                    updateBiometricSettingsUI();
                    showToast('Biometric login disabled');
                }
            } else {
                // Enable biometric - show setup modal
                showBiometricSetupModal();
            }
        }

        function showBiometricSetupModal() {
            document.getElementById('biometric-setup-modal').classList.remove('hidden');
        }

        function closeBiometricSetupModal() {
            document.getElementById('biometric-setup-modal').classList.add('hidden');
        }

        async function startBiometricRegistration() {
            const btn = document.getElementById('start-biometric-setup-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting up...';
            btn.disabled = true;

            try {
                await registerBiometric(currentUser.username);
                
                biometricEnabled = true;
                localStorage.setItem(`biometric_${currentUser.username}`, 'true');
                lastLoggedInUser = currentUser.username;
                localStorage.setItem('lastLoggedInUser', lastLoggedInUser);
                
                closeBiometricSetupModal();
                
                const toggle = document.getElementById('biometric-toggle');
                toggle.classList.add('active');
                updateBiometricSettingsUI();
                
                showToast(`${getDeviceInfo().platform} enabled successfully!`);
                
            } catch (error) {
                console.error('Setup error:', error);
                showToast('Setup failed. Please try again.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function setupBiometricNow() {
            showBiometricSetupModal();
        }

        // Prevent zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await initImageDB();
            initAuth();
            
            document.getElementById('scan-date-select').addEventListener('change', updateScanWeekDisplay);
        });
    </script>
</body>
</html>
