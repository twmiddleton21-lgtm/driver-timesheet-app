
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <title>Driver Timesheet Pro v2.3.2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#0F172A',
                        'dark-card': '#1E293B',
                        'dark-surface': '#334155'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }
        
        .calendar-day:active { transform: scale(0.95); }
        .calendar-day.has-data { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .calendar-day.today { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.3); z-index: 10; }
        .calendar-day.today.has-data { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.5); }
        .calendar-day.other-month { opacity: 0.3; }
        
        .upload-zone { transition: all 0.3s ease; border: 2px dashed #cbd5e1; }
        .upload-zone.active { border-color: #3B82F6; background-color: rgba(59, 130, 246, 0.05); transform: scale(1.02); }
        
        .nav-item { transition: all 0.3s ease; }
        .nav-item.active { color: #3B82F6; }
        .nav-item.active i { transform: translateY(-2px); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .extraction-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 0.7rem;
        }
        
        .day-cell {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 2px;
            text-align: center;
            min-height: 50px;
            background: white;
            position: relative;
        }
        
        .day-cell.has-am { background: #fef3c7; border-color: #f59e0b; }
        .day-cell.has-pm { background: #e0e7ff; border-color: #6366f1; }
        .day-cell.has-both { background: linear-gradient(135deg, #fef3c7 0%, #e0e7ff 100%); border-color: #8b5cf6; }
        .day-cell.first-day { box-shadow: 0 0 0 2px #10B981; }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 0.65rem;
        }
        
        .correction-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 60px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 4px;
        }
        
        .danger-zone {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
        
        .dark .danger-zone {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            border-color: #dc2626;
        }
        
        /* New styles for improved UI */
        .ocr-debug-info {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f3f4f6;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .dark .ocr-debug-info {
            background: #1f2937;
            color: #d1d5db;
        }
        
        .manual-entry-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .image-preview-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-processing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }
        
        .ocr-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-800 dark:text-gray-100 transition-colors duration-300 min-h-screen pb-20">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-white dark:bg-dark flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shadow-blue-500/30 mx-auto mb-4">
                    <i class="fas fa-truck"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Driver Timesheet Pro</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2 flex items-center justify-center gap-2">
                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded" id="version-display">v2.3.2</span>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Auto-Detect v3.2</span>
                </p>
            </div>

            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Driver</label>
                    <select id="user-select" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                
                <div id="pin-section" class="hidden">
                    <input type="password" id="pin-input" maxlength="4" inputmode="numeric" 
                        class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest" 
                        placeholder="••••">
                </div>

                <button onclick="login()" id="login-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95">
                    Login
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-dark text-gray-500">Admin Only</span></div>
                </div>

                <button onclick="showCreateUser()" class="w-full border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-4 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-card transition-all">
                    <i class="fas fa-user-plus mr-2"></i>Create New Driver
                </button>
            </div>

            <!-- Create User Form -->
            <div id="create-user-form" class="hidden space-y-4">
                <h2 class="text-xl font-bold text-center mb-4">Create New Driver</h2>
                
                <input type="text" id="new-username" placeholder="Driver Name" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none">
                
                <input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="Create 4-digit PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest">
                
                <input type="password" id="confirm-pin" maxlength="4" inputmode="numeric" placeholder="Confirm PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest">
                
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                    <label class="block text-sm font-medium text-blue-900 dark:text-blue-300 mb-2">
                        <i class="fas fa-magic mr-2"></i>Smart Auto-Detection v3.2
                    </label>
                    <p class="text-xs text-blue-700 dark:text-blue-400">Fixed OCR engine initialization with robust error handling and automatic fallback to manual entry.</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="hideCreateUser()" class="flex-1 py-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold">Cancel</button>
                    <button onclick="createUser()" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-dark-card shadow-sm sticky top-0 z-40">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                        <i class="fas fa-truck text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight" id="header-username">Driver</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="sync-status"><i class="fas fa-shield-alt text-green-500"></i> Local Storage</p>
                    </div>
                </div>
                <button onclick="logout()" class="touch-btn flex items-center justify-center text-gray-500 hover:text-red-500 transition-colors">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </header>

        <main class="px-4 py-4 max-w-lg mx-auto">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section fade-in space-y-4">
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="changeMonth(-1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400"></i>
                        </button>
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white" id="calendar-month-year">February 2024</h2>
                        <button onclick="changeMonth(1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">M</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">W</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">F</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                    </div>
                    
                    <div id="calendar-grid" class="calendar-grid"></div>
                    
                    <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-green-500"></div><span>Complete</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-gray-300 dark:bg-gray-600"></div><span>Empty</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-primary ring-2 ring-primary ring-offset-2"></div><span>Today</span></div>
                    </div>
                </div>

                <div id="week-preview" class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 dark:text-white" id="preview-week-range">Week of Feb 5-11</h3>
                        <span class="text-sm font-bold text-primary" id="preview-total-hours">60h</span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="preview-days"></div>
                    <button onclick="openSelectedWeek()" class="w-full mt-3 py-3 bg-primary/10 dark:bg-primary/20 text-primary font-semibold rounded-xl hover:bg-primary/20 transition-colors">
                        View Full Details
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">This Month</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-month-hours">0h</p>
                    </div>
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">This Year</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-year-hours">0h</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Uploads</h3>
                    <div id="recent-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Scan View with Improved OCR -->
            <div id="scan-view" class="view-section hidden fade-in space-y-4">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Scan Timesheet</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Enhanced OCR with error correction v3.2</p>
                </div>

                <!-- Smart Detection Info -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-2xl p-4 border border-green-200 dark:border-green-800">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-brain text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-900 dark:text-white">Smart Detection v3.2</p>
                            <p class="text-xs text-gray-500">Robust OCR Engine • Auto-Fallback • Debug Mode</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Week Ending Date (Saturday)</label>
                    <input type="date" id="scan-date-select" class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-primary outline-none">
                    <p class="text-xs text-gray-500 mt-2" id="selected-week-info">Select the Saturday date from your timesheet</p>
                </div>

                <!-- Upload Zone -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white">Timesheet Image <span class="text-red-500">*</span></h3>
                        <span class="text-xs text-gray-500" id="front-status">Required</span>
                    </div>
                    <div class="upload-zone rounded-xl p-6 text-center cursor-pointer relative overflow-hidden bg-gray-50 dark:bg-dark-surface image-preview-container" 
                         onclick="document.getElementById('file-front').click()"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="file-front" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
                        <div id="upload-front-default">
                            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Tap to take photo or browse</p>
                            <p class="text-xs text-gray-400 mt-1">Ensure all 7 days are visible</p>
                        </div>
                        <img id="preview-front" class="hidden w-full h-48 object-cover rounded-lg mx-auto">
                        <div id="image-processing-indicator" class="image-processing-overlay hidden">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Processing...</p>
                            </div>
                        </div>
                    </div>
                    <!-- Image Quality Tips -->
                    <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <p class="text-xs text-blue-700 dark:text-blue-400">
                            <i class="fas fa-lightbulb mr-1"></i>
                            <strong>Tips:</strong> Ensure good lighting, flat paper, and all text is visible. Avoid shadows and glare.
                        </p>
                    </div>
                </div>

                <!-- Error Display with Debug Info -->
                <div id="ocr-error" class="hidden bg-red-50 dark:bg-red-900/20 rounded-2xl p-4 border border-red-200 dark:border-red-800">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-red-800 dark:text-red-300">Extraction Failed</p>
                            <p class="text-xs text-red-600 dark:text-red-400" id="error-message">Please try again or enter manually</p>
                        </div>
                    </div>
                    
                    <!-- Debug Info (collapsible) -->
                    <div class="mt-3">
                        <button onclick="toggleDebugInfo()" class="text-xs text-red-600 underline mb-2">
                            <i class="fas fa-bug mr-1"></i>Show Debug Info
                        </button>
                        <div id="ocr-debug-info" class="ocr-debug-info hidden"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="retryOCR()" class="py-2 bg-red-100 dark:bg-red-900/30 text-red-700 rounded-lg text-sm font-medium">
                            <i class="fas fa-redo mr-1"></i>Retry OCR
                        </button>
                        <button onclick="showManualEntryFallback()" class="py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 rounded-lg text-sm font-medium manual-entry-btn text-white">
                            <i class="fas fa-edit mr-1"></i>Enter Manually
                        </button>
                    </div>
                </div>

                <!-- OCR Progress -->
                <div id="ocr-progress" class="hidden bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Analyzing timesheet...</span>
                        <span class="text-sm text-primary" id="ocr-status">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-surface rounded-full h-2">
                        <div id="ocr-progress-bar" class="bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                        <i class="fas fa-spinner fa-spin" id="ocr-spinner"></i>
                        <span id="ocr-stage">Initializing...</span>
                    </div>
                </div>

                <!-- Auto-Detection Results -->
                <div id="auto-results" class="hidden space-y-4">
                    
                    <!-- Detection Summary -->
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-2xl p-4 border border-green-200 dark:border-green-800">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-green-800 dark:text-green-300">
                                <i class="fas fa-check-circle mr-2"></i>Detection Complete
                            </h3>
                            <span class="text-xs bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full" id="confidence-badge">High Confidence</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">First Shift:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-first-day">Thursday AM</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Working Days:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-days">3 days</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Pattern:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-pattern">Double Shifts</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Total Hours:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-hours">~38h</span>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Grid -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Detected Schedule</h3>
                        <div class="extraction-grid relative" id="detection-grid">
                            <!-- Generated by JS -->
                        </div>
                        <div class="flex gap-4 mt-3 text-xs justify-center">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-amber-200 rounded"></div><span>AM Start</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-indigo-200 rounded"></div><span>PM End</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gradient-to-r from-amber-200 to-indigo-200 rounded"></div><span>Both</span></div>
                        </div>
                    </div>

                    <!-- Time Correction Table -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-900 dark:text-white text-sm">Review & Correct Times</h3>
                            <button onclick="resetToAuto()" class="text-xs text-primary hover:underline">Reset to Auto</button>
                        </div>
                        <div id="correction-table" class="space-y-2">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="reprocessImage()" class="flex-1 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-50 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-redo mr-2"></i>Re-scan
                        </button>
                        <button onclick="confirmAndSave()" class="flex-1 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Timesheet
                        </button>
                    </div>
                </div>

                <button onclick="startOCR()" id="scan-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    <i class="fas fa-magic mr-2"></i>Auto-Extract Times
                </button>
            </div>

            <!-- History View -->
            <div id="history-view" class="view-section hidden fade-in">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">All Timesheets</h2>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterHistory('all')" class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm font-medium whitespace-nowrap" data-filter="all">All</button>
                    <button onclick="filterHistory('month')" class="filter-btn px-4 py-2 rounded-full bg-gray-200 dark:bg-dark-surface text-gray-700 dark:text-gray-300 text-sm font-medium whitespace-nowrap" data-filter="month">This Month</button>
                    <button onclick="filterHistory('year')" class="filter-btn px-4 py-2 rounded-full bg-gray-200 dark:bg-dark-surface text-gray-700 dark:text-gray-300 text-sm font-medium whitespace-nowrap" data-filter="year">This Year</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-section hidden fade-in space-y-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Settings</h2>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Appearance</h3>
                    <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                            <i class="fas fa-moon text-blue-400 hidden dark:block"></i>
                            <span class="font-medium text-gray-900 dark:text-white" id="theme-label">Dark Mode</span>
                        </div>
                        <div class="w-12 h-6 bg-gray-300 dark:bg-primary rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 dark:left-6 transition-all shadow-sm"></div>
                        </div>
                    </button>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-info-circle text-primary mr-2"></i>About</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <p><strong>Version:</strong> <span id="settings-version">v2.3.2</span></p>
                        <p><strong>Features:</strong> Robust OCR v3.2, Error Correction, Manual Fallback, Debug Mode</p>
                        <p class="text-xs">Fixed Tesseract.js initialization issues with comprehensive error handling and automatic fallback.</p>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-database text-primary mr-2"></i>Data Management</h3>
                    
                    <div class="space-y-2">
                        <button onclick="showDeleteOptions('week')" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete Specific Week</p>
                                <p class="text-xs text-gray-500">Remove one week's data</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="showDeleteOptions('month')" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete Month</p>
                                <p class="text-xs text-gray-500">Remove all data for a month</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="showDeleteOptions('year')" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left">
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">Delete Year</p>
                                <p class="text-xs text-gray-500">Remove entire year</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="deleteAllData()" class="w-full p-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors mt-2">
                            <i class="fas fa-trash-alt mr-2"></i>Delete All Timesheet Data
                        </button>
                    </div>
                </div>

                <!-- Account Deletion Section -->
                <div class="danger-zone rounded-2xl p-4">
                    <h3 class="font-semibold text-red-600 dark:text-red-400 mb-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i> Danger Zone
                    </h3>
                    <p class="text-sm text-red-600/80 dark:text-red-400/80 mb-4">
                        This will permanently delete your account, all stored data, and remove the app from this device.
                    </p>
                    <button onclick="showRemoveAccountConfirm()" class="w-full p-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-red-500/30 flex items-center justify-center gap-2">
                        <i class="fas fa-user-slash"></i>
                        Delete Account & All Data
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t border-gray-200 dark:border-gray-700 z-40">
            <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
                <button onclick="switchView('dashboard')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center active" data-view="dashboard">
                    <i class="fas fa-calendar-alt text-xl transition-transform"></i>
                    <span class="text-xs font-medium">Calendar</span>
                </button>
                <button onclick="switchView('scan')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="scan">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-500/30 -mt-6 border-4 border-gray-50 dark:border-dark">
                        <i class="fas fa-plus text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">Scan</span>
                </button>
                <button onclick="switchView('history')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="history">
                    <i class="fas fa-list text-xl transition-transform"></i>
                    <span class="text-xs font-medium">History</span>
                </button>
                <button onclick="switchView('settings')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="settings">
                    <i class="fas fa-cog text-xl transition-transform"></i>
                    <span class="text-xs font-medium">Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Delete Options Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-md md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[80vh] overflow-y-auto">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="delete-modal-title">Delete Data</h3>
                    <button onclick="closeDeleteModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4" id="delete-options-content"></div>
            </div>
        </div>
    </div>

    <!-- Remove Account Confirmation Modal -->
    <div id="remove-account-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card rounded-2xl p-6 max-w-sm w-full text-center border-2 border-red-500">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-red-600 mb-2">Delete Account?</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
                This will permanently delete:
            </p>
            <ul class="text-left text-sm text-gray-600 dark:text-gray-400 mb-6 space-y-2 bg-gray-100 dark:bg-dark-surface rounded-lg p-4">
                <li class="flex items-center gap-2"><i class="fas fa-user text-red-500"></i> Your user account</li>
                <li class="flex items-center gap-2"><i class="fas fa-database text-red-500"></i> All timesheet data</li>
                <li class="flex items-center gap-2"><i class="fas fa-image text-red-500"></i> All uploaded photos</li>
                <li class="flex items-center gap-2"><i class="fas fa-cog text-red-500"></i> App settings</li>
            </ul>
            <p class="text-xs text-red-500 font-medium mb-4">This action cannot be undone!</p>
            
            <div class="space-y-2">
                <button onclick="executeRemoveAccount()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl">
                    Yes, Delete Everything
                </button>
                <button onclick="hideRemoveAccountModal()" class="w-full text-gray-500 py-2 text-sm">
                    Cancel - Keep My Data
                </button>
            </div>
        </div>
    </div>

    <!-- Final Removal Screen -->
    <div id="final-removal-screen" class="fixed inset-0 z-[100] bg-red-600 hidden flex flex-col items-center justify-center p-6 text-white">
        <div class="text-center">
            <i class="fas fa-check-circle text-6xl mb-6 opacity-0" id="removal-check"></i>
            <h2 class="text-3xl font-bold mb-4 opacity-0" id="removal-title">Account Deleted</h2>
            <p class="text-white/80 mb-8 opacity-0" id="removal-text">All data has been permanently removed.</p>
            <div class="opacity-0" id="removal-instructions">
                <p class="text-sm text-white/60 mb-4">To complete removal:</p>
                <div class="bg-white/10 rounded-xl p-4 text-left text-sm space-y-2">
                    <p>1. Close this browser tab</p>
                    <p>2. Remove from Home Screen:</p>
                    <p class="pl-4 text-white/80">• iOS: Long press icon → Remove App</p>
                    <p class="pl-4 text-white/80">• Android: Drag to "Uninstall"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Details Modal -->
    <div id="week-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeWeekModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-10">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="week-modal-title">Week Details</h3>
                    <button onclick="closeWeekModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4" id="week-modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-xl shadow-lg transform -translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 max-w-md">
        <i id="toast-icon" class="fas fa-check-circle text-green-400 dark:text-green-600"></i>
        <span id="toast-message" class="font-medium text-sm">Operation successful</span>
    </div>

    <script>
        // ==================== CONFIG ====================
        const APP_VERSION = '2.3.2';
        let currentUser = null;
        let currentMonth = new Date();
        let selectedWeekStart = null;
        let currentImage = null;
        let processedImage = null;
        let imageDB = null;
        let autoDetectedData = null;
        let ocrWorker = null;
        let ocrAttempts = 0; // Track OCR attempts for debugging

        // ==================== INDEXEDDB ====================
        const DB_NAME = 'TimesheetImagesDB';
        const STORE_NAME = 'images';
        
        function initImageDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { imageDB = request.result; resolve(imageDB); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveImage(id, dataUrl) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id, data: dataUrl, timestamp: Date.now() });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getImage(id) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result ? request.result.data : null);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteImage(id) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function clearAllImages() {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ==================== DATE UTILITIES ====================
        function formatDateForInput(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        function parseDate(dateString) {
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            }
            return new Date(dateString);
        }
        
        function formatWeekRange(startDate, endDate) {
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
        }

        // ==================== DATA STORE ====================
        const DB = {
            getUsers: () => JSON.parse(localStorage.getItem('ts_users') || '[]'),
            saveUsers: (users) => localStorage.setItem('ts_users', JSON.stringify(users)),
            getTimesheets: (username) => JSON.parse(localStorage.getItem(`ts_data_${username}`) || '[]'),
            saveTimesheets: (username, data) => localStorage.setItem(`ts_data_${username}`, JSON.stringify(data)),
            deleteUser: (username) => {
                localStorage.removeItem(`ts_data_${username}`);
                localStorage.removeItem(`ts_settings_${username}`);
                const users = DB.getUsers().filter(u => u.username !== username);
                DB.saveUsers(users);
            }
        };

        // ==================== AUTH ====================
        function initAuth() {
            document.getElementById('version-display').textContent = 'v' + APP_VERSION;
            document.getElementById('settings-version').textContent = 'v' + APP_VERSION;
            const users = DB.getUsers();
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                users.map(u => `<option value="${u.username}">${u.username}</option>`).join('');
            
            if (users.length === 1) {
                select.value = users[0].username;
                document.getElementById('pin-section').classList.remove('hidden');
            }
            
            select.addEventListener('change', function() {
                document.getElementById('pin-section').classList.toggle('hidden', !this.value);
            });
        }

        function login() {
            const username = document.getElementById('user-select').value;
            const pin = document.getElementById('pin-input').value;
            
            if (!username) return showToast('Please select a user', 'error');
            if (!pin || pin.length !== 4) return showToast('Enter 4-digit PIN', 'error');
            
            const users = DB.getUsers();
            const user = users.find(u => u.username === username && u.pin === hashPin(pin));
            
            if (!user) {
                showToast('Invalid PIN', 'error');
                document.getElementById('pin-input').value = '';
                return;
            }
            
            currentUser = user;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('header-username').textContent = user.username;
            
            // Set default date to upcoming Saturday
            const today = new Date();
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + (6 - today.getDay()));
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            
            initTheme();
            renderCalendar();
            updateStats();
            renderRecent();
            
            showToast(`Welcome, ${user.username}`);
        }

        function updateScanWeekDisplay() {
            const dateInput = document.getElementById('scan-date-select');
            if (dateInput.value) {
                const endDate = parseDate(dateInput.value);
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                document.getElementById('selected-week-info').textContent = 
                    `Week: ${formatWeekRange(startDate, endDate)}`;
            }
        }

        function showCreateUser() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('create-user-form').classList.remove('hidden');
        }

        function hideCreateUser() {
            document.getElementById('create-user-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function createUser() {
            const username = document.getElementById('new-username').value.trim();
            const pin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            
            if (!username) return showToast('Enter driver name', 'error');
            if (!pin || pin.length !== 4) return showToast('PIN must be 4 digits', 'error');
            if (pin !== confirmPin) return showToast('PINs do not match', 'error');
            
            const users = DB.getUsers();
            if (users.find(u => u.username === username)) return showToast('User already exists', 'error');
            
            users.push({ username, pin: hashPin(pin), created: new Date().toISOString() });
            DB.saveUsers(users);
            
            showToast('Driver created successfully');
            hideCreateUser();
            initAuth();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-section').classList.add('hidden');
            document.getElementById('user-select').value = '';
        }

        function hashPin(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ==================== CALENDAR ====================
        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const timesheets = DB.getTimesheets(currentUser.username);
            const weekData = {};
            
            timesheets.forEach(ts => {
                const date = parseDate(ts.weekStart);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    weekData[date.getDate()] = ts;
                }
            });
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = startPadding - 1; i >= 0; i--) {
                grid.appendChild(createCalendarDay(prevMonthDays - i, true));
            }
            
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (day === todayDate && month === todayMonth && year === todayYear);
                const hasData = weekData[day];
                const cell = createCalendarDay(day, false, isToday, hasData);
                
                if (hasData) cell.onclick = () => selectWeek(hasData);
                else cell.onclick = () => selectEmptyWeek(year, month, day);
                
                grid.appendChild(cell);
            }
            
            const remaining = (7 - ((startPadding + daysInMonth) % 7)) % 7;
            for (let day = 1; day <= remaining; day++) {
                grid.appendChild(createCalendarDay(day, true));
            }
        }

        function createCalendarDay(day, isOtherMonth, isToday = false, data = null) {
            const div = document.createElement('div');
            let className = 'calendar-day';
            
            if (isOtherMonth) className += ' other-month bg-gray-100 dark:bg-dark-surface text-gray-400';
            else className += ' bg-white dark:bg-dark-surface text-gray-900 dark:text-white';
            
            if (isToday) className += ' today';
            if (data) className += ' has-data';
            
            div.className = className;
            
            let todayIndicator = '';
            if (isToday) {
                todayIndicator = '<div class="absolute -top-1 -right-1 w-3 h-3 bg-primary rounded-full border-2 border-white dark:border-dark-card"></div>';
            }
            
            div.innerHTML = `
                <span class="text-lg font-bold">${day}</span>
                ${data ? '<div style="background: rgba(255,255,255,0.5); height: 3px; width: 60%; border-radius: 2px; margin-top: 2px;"></div>' : ''}
                ${todayIndicator}
            `;
            return div;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function selectWeek(timesheet) {
            selectedWeekStart = timesheet.weekStart;
            const preview = document.getElementById('week-preview');
            preview.classList.remove('hidden');
            
            document.getElementById('preview-week-range').textContent = timesheet.weekRange;
            document.getElementById('preview-total-hours').textContent = timesheet.totalHours + 'h';
            
            const daysContainer = document.getElementById('preview-days');
            daysContainer.innerHTML = timesheet.days.map((day, i) => `
                <div class="flex-shrink-0 w-16 h-16 rounded-xl ${day.hours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex flex-col items-center justify-center">
                    <span class="text-xs">${['S','M','T','W','T','F','S'][i]}</span>
                    <span class="font-bold">${day.hours > 0 ? day.hours : '-'}</span>
                </div>
            `).join('');
        }

        function selectEmptyWeek(year, month, day) {
            const date = new Date(year, month, day, 12, 0, 0);
            const saturday = new Date(date);
            saturday.setDate(date.getDate() + (6 - date.getDay()));
            
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            switchView('scan');
            showToast('Selected week for new upload');
        }

        function openSelectedWeek() {
            if (!selectedWeekStart) return;
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === selectedWeekStart);
            if (ts) openWeekDetails(ts);
        }

        // ==================== IMAGE PREPROCESSING ====================
        async function preprocessImage(imageDataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize if too large (Tesseract works best at 300 DPI equivalent)
                        const maxWidth = 2000;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Fill white background first (helps with transparent images)
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        
                        // Increase contrast and brightness for better OCR
                        ctx.filter = 'contrast(1.2) brightness(1.1)';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const processed = canvas.toDataURL('image/jpeg', 0.9);
                        console.log('Image preprocessed successfully:', width, 'x', height);
                        resolve(processed);
                    } catch (err) {
                        console.error('Image preprocessing error:', err);
                        resolve(imageDataUrl); // Fallback to original
                    }
                };
                
                img.onerror = (err) => {
                    console.error('Image load error:', err);
                    resolve(imageDataUrl); // Fallback to original
                };
                
                img.src = imageDataUrl;
            });
        }

        // ==================== SCAN & OCR (ROBUST VERSION 2.3.2) ====================
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('active');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('active');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processFile(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            // Validate file
            const MAX_SIZE = 10 * 1024 * 1024; // 10MB
            if (file.size > MAX_SIZE) {
                showToast('Image too large (max 10MB)', 'error');
                return;
            }
            
            // Show processing indicator
            document.getElementById('image-processing-indicator').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    currentImage = e.target.result;
                    
                    // Preprocess image for better OCR
                    processedImage = await preprocessImage(currentImage);
                    
                    document.getElementById('preview-front').src = processedImage;
                    document.getElementById('preview-front').classList.remove('hidden');
                    document.getElementById('upload-front-default').classList.add('hidden');
                    document.getElementById('front-status').textContent = 'Ready';
                    document.getElementById('front-status').className = 'text-xs text-green-600 font-medium';
                } catch (err) {
                    console.error('Image processing error:', err);
                    // Fallback to original
                    processedImage = currentImage;
                    document.getElementById('preview-front').src = currentImage;
                    document.getElementById('preview-front').classList.remove('hidden');
                    document.getElementById('upload-front-default').classList.add('hidden');
                } finally {
                    document.getElementById('image-processing-indicator').classList.add('hidden');
                }
            };
            reader.onerror = () => {
                showToast('Error reading image', 'error');
                document.getElementById('image-processing-indicator').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // ROBUST OCR with comprehensive error handling and fallback
        async function startOCR() {
            if (!processedImage && !currentImage) return showToast('Please upload timesheet image', 'error');
            
            const weekEnding = document.getElementById('scan-date-select').value;
            if (!weekEnding) return showToast('Please select week ending date', 'error');
            
            // Use processed image if available, otherwise original
            const imageToProcess = processedImage || currentImage;
            
            // Reset error state
            document.getElementById('ocr-error').classList.add('hidden');
            document.getElementById('scan-btn').classList.add('hidden');
            document.getElementById('ocr-progress').classList.remove('hidden');
            
            // Initialize debug info at the start so it's available in catch block
            let debugInfo = {
                attempt: ++ocrAttempts,
                stage: 'initializing',
                error: null,
                rawText: null,
                workerCreated: false,
                recognitionStarted: false,
                recognitionCompleted: false
            };
            
            let worker = null;
            
            try {
                updateOcrProgress(5, 'Initializing OCR engine (attempt ' + debugInfo.attempt + ')...');
                
                // Check if Tesseract is loaded
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract.js library not loaded. Please check your internet connection and refresh the page.');
                }
                
                // Check if createWorker exists
                if (!Tesseract.createWorker) {
                    throw new Error('Tesseract.js API not available. Please refresh the page.');
                }
                
                updateOcrProgress(10, 'Creating worker...');
                debugInfo.stage = 'creating_worker';
                
                // ROBUST v4 API: Create worker with extensive error handling
                // Wrap in separate try-catch to capture worker creation errors specifically
                try {
                    worker = await Promise.race([
                        Tesseract.createWorker('eng', 1, {
                            logger: m => {
                                console.log('Tesseract:', m);
                                if (m.status === 'recognizing text') {
                                    updateOcrProgress(20 + Math.round(m.progress * 60), 'Reading timesheet...');
                                }
                            },
                            errorHandler: err => {
                                console.error('Tesseract worker error:', err);
                                debugInfo.error = err;
                            }
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Worker creation timeout')), 30000)
                        )
                    ]);
                    
                    debugInfo.workerCreated = true;
                } catch (workerErr) {
                    console.error('Worker creation failed:', workerErr);
                    throw new Error(`Failed to create OCR worker: ${workerErr.message}. This may be due to network issues or browser compatibility.`);
                }
                
                updateOcrProgress(25, 'Configuring OCR parameters...');
                debugInfo.stage = 'configuring';
                
                // Set parameters
                try {
                    await worker.setParameters({
                        tessedit_pageseg_mode: '6',
                        preserve_interword_spaces: '1',
                        tessedit_char_whitelist: '0123456789:AMPMSUNMONTUEWEDTHUFRISAT ',
                    });
                } catch (paramErr) {
                    console.warn('Failed to set parameters:', paramErr);
                    // Continue anyway, parameters are optional
                }
                
                updateOcrProgress(30, 'Starting text recognition...');
                debugInfo.stage = 'recognizing';
                debugInfo.recognitionStarted = true;
                
                // Recognize with timeout
                let result;
                try {
                    result = await Promise.race([
                        worker.recognize(imageToProcess),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('OCR recognition timeout - took too long')), 60000)
                        )
                    ]);
                    debugInfo.recognitionCompleted = true;
                } catch (recognizeErr) {
                    console.error('Recognition failed:', recognizeErr);
                    throw new Error(`Text recognition failed: ${recognizeErr.message}`);
                }
                
                updateOcrProgress(95, 'Processing results...');
                debugInfo.stage = 'processing';
                
                // Validate result
                if (!result) {
                    throw new Error('OCR returned no result object');
                }
                
                if (!result.data) {
                    throw new Error('OCR returned no data object');
                }
                
                // Store raw text for debug
                debugInfo.rawText = result.data.text || '';
                console.log('Raw OCR result:', result);
                console.log('Raw OCR text:', debugInfo.rawText);
                
                // Check if we got meaningful text
                if (!debugInfo.rawText || debugInfo.rawText.trim().length < 3) {
                    throw new Error('No readable text found in image. The OCR engine could not detect any text. Please ensure the image is clear, well-lit, and contains text.');
                }
                
                // Parse with improved logic
                autoDetectedData = parseTimesheetImproved(debugInfo.rawText);
                
                if (!autoDetectedData.firstWorkingDay) {
                    throw new Error('Could not detect any working days. The timesheet may be in an unexpected format or the text may be unclear. Please enter times manually.');
                }
                
                // Calculate hours
                let totalHours = 0;
                let workingDays = 0;
                Object.values(autoDetectedData.days).forEach(day => {
                    if (day.hasData) {
                        workingDays++;
                        if (day.amTime && day.pmTime) {
                            const hours = calculateHoursBetween(day.amTime, day.pmTime);
                            day.hours = Math.round(hours * 10) / 10;
                            totalHours += day.hours;
                        }
                    }
                });
                
                autoDetectedData.totalHours = Math.round(totalHours * 10) / 10;
                autoDetectedData.workingDays = workingDays;
                
                updateOcrProgress(100, 'Complete!');
                
                // Cleanup
                try {
                    await worker.terminate();
                } catch (termErr) {
                    console.warn('Worker termination error:', termErr);
                }
                
                setTimeout(() => {
                    document.getElementById('ocr-progress').classList.add('hidden');
                    showAutoDetectionResults();
                }, 500);
                
            } catch (err) {
                console.error('OCR Error:', err);
                debugInfo.error = err;
                
                // Ensure cleanup happens even on error
                if (worker) {
                    try { 
                        await worker.terminate(); 
                    } catch(e) { 
                        console.log('Worker termination error:', e); 
                    }
                }
                
                document.getElementById('ocr-progress').classList.add('hidden');
                document.getElementById('ocr-error').classList.remove('hidden');
                
                // Better error message handling
                let errorMsg = err.message || 'Failed to extract times. Please try again or enter manually.';
                
                // Check for specific error types
                if (err.message && err.message.includes('network')) {
                    errorMsg = 'Network error loading OCR engine. Please check your internet connection.';
                } else if (err.message && err.message.includes('timeout')) {
                    errorMsg = 'OCR took too long. Try with a smaller image or better lighting.';
                } else if (err.message && err.message.includes('not loaded')) {
                    errorMsg = 'OCR library failed to load. Please refresh the page.';
                }
                
                document.getElementById('error-message').textContent = errorMsg;
                document.getElementById('scan-btn').classList.remove('hidden');
                
                // Build comprehensive debug info
                const debugText = `OCR Debug Info:
==================
Attempt: ${debugInfo.attempt}
Stage: ${debugInfo.stage}
Worker Created: ${debugInfo.workerCreated}
Recognition Started: ${debugInfo.recognitionStarted}
Recognition Completed: ${debugInfo.recognitionCompleted}

Error: ${err.message || 'Unknown error'}
Error Stack: ${err.stack ? err.stack.substring(0, 500) : 'No stack trace'}

Raw OCR Text: ${debugInfo.rawText ? debugInfo.rawText.substring(0, 500) : '[NO TEXT CAPTURED]'}

Browser Info: ${navigator.userAgent.substring(0, 100)}
Tesseract Version: ${typeof Tesseract !== 'undefined' ? (Tesseract.version || 'v4.x') : 'NOT LOADED'}
                `;
                
                const debugDiv = document.getElementById('ocr-debug-info');
                if (debugDiv) {
                    debugDiv.textContent = debugText;
                }
                
                // Auto-fallback to manual entry after 2 failed attempts
                if (debugInfo.attempt >= 2) {
                    console.log('Auto-fallback to manual entry after', debugInfo.attempt, 'attempts');
                }
                
                showToast(errorMsg, 'error');
            }
        }

        function retryOCR() {
            document.getElementById('ocr-error').classList.add('hidden');
            startOCR();
        }

        function toggleDebugInfo() {
            const debugDiv = document.getElementById('ocr-debug-info');
            debugDiv.classList.toggle('hidden');
        }

        function updateOcrProgress(percent, stage) {
            document.getElementById('ocr-progress-bar').style.width = percent + '%';
            document.getElementById('ocr-status').textContent = percent + '%';
            document.getElementById('ocr-stage').textContent = stage;
        }

        // IMPROVED: Robust parser with OCR error correction
        function parseTimesheetImproved(ocrText) {
            // Clean up common OCR errors
            let cleanedText = ocrText
                .replace(/[Oo]/g, '0')  // O -> 0
                .replace(/[lI]/g, '1')  // l, I -> 1
                .replace(/[S]/g, '5')   // S -> 5
                .replace(/[Z]/g, '2')   // Z -> 2
                .replace(/[\r\n]+/g, '\n')  // Normalize line breaks
                .toUpperCase();
            
            const lines = cleanedText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = {};
            
            // Initialize all days
            days.forEach(day => {
                dayData[day] = { 
                    amTime: null, 
                    pmTime: null, 
                    hasData: false,
                    hours: 0,
                    rawMatches: []
                };
            });
            
            // More flexible patterns for day detection
            const dayPatterns = days.map(day => ({
                day: day,
                amRegex: new RegExp(`${day}[\\s_]*AM|${day}AM|${day}.*AM`, 'i'),
                pmRegex: new RegExp(`${day}[\\s_]*PM|${day}PM|${day}.*PM`, 'i'),
                genericRegex: new RegExp(`\\b${day}\\b`, 'i')
            }));
            
            // Process each line
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const nextLine = i + 1 < lines.length ? lines[i + 1] : '';
                const combinedText = line + ' ' + nextLine;
                
                dayPatterns.forEach(({ day, amRegex, pmRegex }) => {
                    // Check for AM shift
                    if (amRegex.test(line) || (line.includes(day) && line.includes('AM'))) {
                        const times = extractTimesFlexible(combinedText);
                        const amTime = findAmTime(times);
                        if (amTime && !dayData[day].amTime) {
                            dayData[day].amTime = amTime;
                            dayData[day].hasData = true;
                            dayData[day].rawMatches.push(`AM:${amTime}`);
                        }
                    }
                    
                    // Check for PM shift
                    if (pmRegex.test(line) || (line.includes(day) && line.includes('PM'))) {
                        const times = extractTimesFlexible(combinedText);
                        const pmTime = findPmTime(times);
                        if (pmTime && !dayData[day].pmTime) {
                            dayData[day].pmTime = pmTime;
                            dayData[day].hasData = true;
                            dayData[day].rawMatches.push(`PM:${pmTime}`);
                        }
                    }
                });
            }
            
            // Fallback: If no explicit AM/PM labels, look for day + time patterns
            days.forEach(day => {
                if (!dayData[day].hasData) {
                    // Search all lines for day name followed by times
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes(day)) {
                            const times = extractTimesFlexible(lines[i] + ' ' + (lines[i+1] || ''));
                            if (times.length >= 2 && !dayData[day].hasData) {
                                dayData[day].amTime = times[0];
                                dayData[day].pmTime = times[1];
                                dayData[day].hasData = true;
                            } else if (times.length === 1 && !dayData[day].hasData) {
                                // Single time - determine if AM or PM based on value
                                const hour = parseInt(times[0].split(':')[0]);
                                if (hour < 12) dayData[day].amTime = times[0];
                                else dayData[day].pmTime = times[0];
                                dayData[day].hasData = true;
                            }
                        }
                    }
                }
            });
            
            // Find first working day
            let firstWorkingDay = null;
            let firstShiftType = null;
            
            for (const day of days) {
                if (dayData[day].hasData) {
                    firstWorkingDay = day;
                    if (dayData[day].amTime && !dayData[day].pmTime) firstShiftType = 'AM';
                    else if (!dayData[day].amTime && dayData[day].pmTime) firstShiftType = 'PM';
                    else firstShiftType = 'BOTH';
                    break;
                }
            }
            
            // Detect pattern
            let doubleShiftDays = 0;
            days.forEach(day => {
                if (dayData[day].amTime && dayData[day].pmTime) doubleShiftDays++;
            });
            
            let pattern = 'single';
            if (doubleShiftDays >= 2) pattern = 'double';
            if (doubleShiftDays >= 4) pattern = 'continuous';
            
            return {
                days: dayData,
                firstWorkingDay: firstWorkingDay,
                firstShiftType: firstShiftType,
                pattern: pattern,
                doubleShiftDays: doubleShiftDays,
                rawText: ocrText,
                cleanedText: cleanedText
            };
        }

        // Flexible time extraction with multiple patterns
        function extractTimesFlexible(text) {
            const times = [];
            const seen = new Set();
            
            // Pattern 1: HH:MM (most common)
            const pattern1 = /(\d{1,2})[:.](\d{2})/g;
            let match;
            while ((match = pattern1.exec(text)) !== null) {
                let hour = parseInt(match[1]);
                let minute = parseInt(match[2]);
                
                // Validate
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    // Skip if looks like a year (2000-2030)
                    if (hour === 20 && minute <= 30) continue;
                    
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    if (!seen.has(timeStr)) {
                        times.push(timeStr);
                        seen.add(timeStr);
                    }
                }
            }
            
            // Pattern 2: HHMM (4 digits, common in tables)
            // Look for spaces around to avoid matching random numbers
            const pattern2 = /(?:^|\s)(\d{2})(\d{2})(?:\s|$)/g;
            while ((match = pattern2.exec(text)) !== null) {
                let hour = parseInt(match[1]);
                let minute = parseInt(match[2]);
                
                if (hour >= 4 && hour <= 23 && minute >= 0 && minute <= 59 && minute % 5 === 0) {
                    // Likely a time if minute is multiple of 5 (00, 05, 10, etc.)
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    if (!seen.has(timeStr)) {
                        times.push(timeStr);
                        seen.add(timeStr);
                    }
                }
            }
            
            return times.sort();
        }

        function findAmTime(times) {
            // AM times are typically 04:00-11:59
            return times.find(t => {
                const h = parseInt(t.split(':')[0]);
                return h >= 4 && h < 12;
            }) || times[0]; // fallback to first time
        }

        function findPmTime(times) {
            // PM times are typically 12:00-23:59, or could be morning times if PM labeled
            return times.find(t => {
                const h = parseInt(t.split(':')[0]);
                return h >= 12 || h < 4; // Afternoon or late night
            }) || times[times.length - 1]; // fallback to last time
        }

        function calculateHoursBetween(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let startMinutes = startHour * 60 + startMin;
            let endMinutes = endHour * 60 + endMin;
            
            // Handle overnight
            if (endMinutes < startMinutes) {
                endMinutes += 24 * 60;
            }
            
            return (endMinutes - startMinutes) / 60;
        }

        function showAutoDetectionResults() {
            document.getElementById('auto-results').classList.remove('hidden');
            
            const dayNames = {
                'SUN': 'Sunday', 'MON': 'Monday', 'TUE': 'Tuesday',
                'WED': 'Wednesday', 'THU': 'Thursday', 'FRI': 'Friday', 'SAT': 'Saturday'
            };
            
            const firstDayFull = autoDetectedData.firstWorkingDay ? 
                dayNames[autoDetectedData.firstWorkingDay] : 'Unknown';
            const shiftType = autoDetectedData.firstShiftType || '';
            
            document.getElementById('result-first-day').textContent = 
                firstDayFull + (shiftType ? ` ${shiftType}` : '');
            document.getElementById('result-total-days').textContent = autoDetectedData.workingDays + ' days';
            document.getElementById('result-pattern').textContent = 
                autoDetectedData.pattern === 'double' ? 'Double Shifts' : 
                autoDetectedData.pattern === 'continuous' ? 'Continuous Double' : 'Single Shifts';
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
            
            // Confidence
            const confidence = autoDetectedData.workingDays >= 3 ? 'High' : 
                              autoDetectedData.workingDays >= 1 ? 'Medium' : 'Low';
            const badge = document.getElementById('confidence-badge');
            badge.textContent = confidence + ' Confidence';
            badge.className = 'text-xs px-2 py-1 rounded-full ' + 
                (confidence === 'High' ? 'bg-green-200 text-green-800' :
                 confidence === 'Medium' ? 'bg-yellow-200 text-yellow-800' :
                 'bg-red-200 text-red-800');
            
            renderDetectionGrid();
            renderCorrectionTable();
        }

        function renderDetectionGrid() {
            const grid = document.getElementById('detection-grid');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            grid.innerHTML = days.map((day, idx) => {
                const data = autoDetectedData.days[day];
                const isFirst = day === autoDetectedData.firstWorkingDay;
                
                let cellClass = 'day-cell';
                if (data.amTime && data.pmTime) cellClass += ' has-both';
                else if (data.amTime) cellClass += ' has-am';
                else if (data.pmTime) cellClass += ' has-pm';
                if (isFirst) cellClass += ' first-day';
                
                return `
                    <div class="${cellClass}">
                        <div class="font-bold text-xs mb-1 ${isFirst ? 'text-green-600' : ''}">${dayLabels[idx]}</div>
                        ${data.amTime ? `<div class="time-display text-amber-700">${data.amTime}</div>` : ''}
                        ${data.pmTime ? `<div class="time-display text-indigo-700">${data.pmTime}</div>` : ''}
                        ${!data.amTime && !data.pmTime ? '<div class="text-gray-300">-</div>' : ''}
                        ${isFirst ? '<div class="absolute -top-2 -left-2 bg-green-500 text-white text-[8px] px-1 rounded">1st</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderCorrectionTable() {
            const container = document.getElementById('correction-table');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            const workingDays = days.filter(day => autoDetectedData.days[day].hasData);
            
            // If no working days detected, show all days for manual entry
            const daysToShow = workingDays.length > 0 ? workingDays : days;
            
            container.innerHTML = daysToShow.map(day => {
                const data = autoDetectedData.days[day];
                const idx = days.indexOf(day);
                const isFirst = day === autoDetectedData.firstWorkingDay;
                
                return `
                    <div class="correction-row ${isFirst ? 'ring-2 ring-green-400 rounded-lg' : ''}">
                        <div class="font-bold text-sm ${isFirst ? 'text-green-600' : ''}">${dayNames[idx]}${isFirst ? '*' : ''}</div>
                        <div>
                            <label class="text-xs text-gray-500">Start (AM)</label>
                            <input type="time" class="w-full p-1 text-sm border rounded" 
                                value="${data.amTime || ''}" 
                                onchange="updateCorrectedTime('${day}', 'am', this.value)">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">End (PM)</label>
                            <input type="time" class="w-full p-1 text-sm border rounded" 
                                value="${data.pmTime || ''}" 
                                onchange="updateCorrectedTime('${day}', 'pm', this.value)">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Hrs</label>
                            <input type="number" class="w-full p-1 text-sm border rounded text-center" 
                                value="${data.hours || ''}" 
                                step="0.5" min="0" max="24"
                                onchange="updateCorrectedTime('${day}', 'hours', this.value)">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCorrectedTime(day, field, value) {
            if (!autoDetectedData) return;
            
            if (field === 'am') autoDetectedData.days[day].amTime = value || null;
            if (field === 'pm') autoDetectedData.days[day].pmTime = value || null;
            if (field === 'hours') autoDetectedData.days[day].hours = parseFloat(value) || 0;
            
            // Mark as hasData if any value entered
            if (value) autoDetectedData.days[day].hasData = true;
            
            // Recalculate
            let total = 0;
            Object.values(autoDetectedData.days).forEach(d => {
                if (d.hours) total += d.hours;
            });
            autoDetectedData.totalHours = Math.round(total * 10) / 10;
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
        }

        function resetToAuto() {
            if (confirm('Reset all times to auto-detected values?')) {
                // Re-parse from raw text
                if (autoDetectedData && autoDetectedData.rawText) {
                    autoDetectedData = parseTimesheetImproved(autoDetectedData.rawText);
                    
                    // Recalculate
                    let totalHours = 0;
                    Object.values(autoDetectedData.days).forEach(day => {
                        if (day.amTime && day.pmTime) {
                            day.hours = Math.round(calculateHoursBetween(day.amTime, day.pmTime) * 10) / 10;
                            totalHours += day.hours;
                        }
                    });
                    autoDetectedData.totalHours = Math.round(totalHours * 10) / 10;
                    
                    renderCorrectionTable();
                    showToast('Reset to auto-detected values');
                }
            }
        }

        // Manual entry fallback when OCR fails
        function showManualEntryFallback() {
            document.getElementById('ocr-error').classList.add('hidden');
            document.getElementById('auto-results').classList.remove('hidden');
            
            // Create empty template for manual entry
            autoDetectedData = {
                days: {
                    'SUN': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'MON': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'TUE': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'WED': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'THU': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'FRI': {amTime: null, pmTime: null, hasData: false, hours: 0},
                    'SAT': {amTime: null, pmTime: null, hasData: false, hours: 0}
                },
                firstWorkingDay: null,
                firstShiftType: null,
                pattern: 'manual',
                totalHours: 0,
                workingDays: 0,
                rawText: 'MANUAL_ENTRY'
            };
            
            showToast('OCR failed - please enter times manually', 'error');
            renderDetectionGrid();
            renderCorrectionTable(); // Show empty table for manual entry
        }

        function reprocessImage() {
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            startOCR();
        }

        async function confirmAndSave() {
            if (!autoDetectedData) return;
            
            const weekEnding = document.getElementById('scan-date-select').value;
            const endDate = parseDate(weekEnding);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            
            // Build final data
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayKeys = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = [];
            let totalHours = 0;
            let longDays = 0;
            
            days.forEach((dayName, idx) => {
                const dayKey = dayKeys[idx];
                const detected = autoDetectedData.days[dayKey];
                
                let hours = 0;
                let start = '-';
                let end = '-';
                
                if (detected && detected.hasData) {
                    start = detected.amTime || detected.pmTime || '-';
                    end = detected.pmTime || detected.amTime || '-';
                    hours = detected.hours || 0;
                    
                    if (hours === 0 && start !== '-' && end !== '-') {
                        hours = Math.round(calculateHoursBetween(start, end) * 10) / 10;
                    }
                    
                    totalHours += hours;
                    if (hours > 10) longDays++;
                }
                
                dayData.push({
                    day: dayName,
                    hours: hours,
                    start: start,
                    end: end,
                    rest: hours > 0 ? '11h' : '-',
                    flag: hours > 10 ? 'warning' : (hours > 0 ? 'ok' : 'none')
                });
            });
            
            // Save
            const timesheetId = Date.now().toString();
            const imageIds = { front: `${timesheetId}_front` };
            
            // Save processed image if available, otherwise original
            const imageToSave = processedImage || currentImage;
            await saveImage(imageIds.front, imageToSave);
            
            const timesheet = {
                id: parseInt(timesheetId),
                weekStart: formatDateForInput(startDate),
                weekEnd: weekEnding,
                weekRange: formatWeekRange(startDate, endDate),
                totalHours: Math.round(totalHours * 10) / 10,
                longDays,
                lowRestDays: 0,
                firstWorkingDay: autoDetectedData.firstWorkingDay,
                firstShiftType: autoDetectedData.firstShiftType,
                pattern: autoDetectedData.pattern,
                imageIds,
                days: dayData,
                uploadedAt: new Date().toISOString(),
                ocrVersion: APP_VERSION
            };
            
            const existing = DB.getTimesheets(currentUser.username);
            existing.push(timesheet);
            DB.saveTimesheets(currentUser.username, existing);
            
            // Reset UI
            resetScanForm();
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            
            renderCalendar();
            updateStats();
            renderRecent();
            
            const msg = autoDetectedData.firstWorkingDay ? 
                `Saved! ${autoDetectedData.firstWorkingDay} ${autoDetectedData.firstShiftType} start, ${totalHours.toFixed(1)}h total` :
                `Saved! ${totalHours.toFixed(1)}h total (manual entry)`;
            
            showToast(msg);
            switchView('dashboard');
        }

        function resetScanForm() {
            currentImage = null;
            processedImage = null;
            autoDetectedData = null;
            ocrAttempts = 0; // Reset attempt counter
            document.getElementById('preview-front').src = '';
            document.getElementById('preview-front').classList.add('hidden');
            document.getElementById('upload-front-default').classList.remove('hidden');
            document.getElementById('file-front').value = '';
            document.getElementById('front-status').textContent = 'Required';
            document.getElementById('front-status').className = 'text-xs text-gray-500';
            const debugDiv = document.getElementById('ocr-debug-info');
            if (debugDiv) {
                debugDiv.textContent = '';
                debugDiv.classList.add('hidden');
            }
        }

        // ==================== DATA MANAGEMENT ====================
        function showDeleteOptions(type) {
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-modal-title');
            const content = document.getElementById('delete-options-content');
            
            const timesheets = DB.getTimesheets(currentUser.username);
            
            if (type === 'week') {
                title.textContent = 'Delete Specific Week';
                const weeks = [...new Set(timesheets.map(ts => ts.weekRange))];
                
                content.innerHTML = weeks.length === 0 ? '<p class="text-gray-500 text-center py-4">No weeks to delete</p>' :
                    weeks.map(week => {
                        const ts = timesheets.find(t => t.weekRange === week);
                        return `
                            <button onclick="confirmDeleteWeek('${ts.weekStart}')" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                <div>
                                    <span class="font-medium text-gray-900 dark:text-white block">${week}</span>
                                    <span class="text-xs text-gray-500">${ts.totalHours}h • ${ts.firstWorkingDay || 'Unknown'} start</span>
                                </div>
                                <i class="fas fa-trash text-red-500"></i>
                            </button>
                        `;
                    }).join('');
                    
            } else if (type === 'month') {
                title.textContent = 'Delete Month';
                const months = {};
                timesheets.forEach(ts => {
                    const date = parseDate(ts.weekStart);
                    const key = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!months[key]) months[key] = { year: date.getFullYear(), month: date.getMonth(), count: 0, hours: 0 };
                    months[key].count++;
                    months[key].hours += ts.totalHours;
                });
                
                content.innerHTML = Object.keys(months).length === 0 ? '<p class="text-gray-500 text-center py-4">No data to delete</p>' :
                    Object.values(months).map(m => `
                        <button onclick="confirmDeleteMonth(${m.year}, ${m.month})" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <div>
                                <span class="font-medium text-gray-900 dark:text-white block">${new Date(m.year, m.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                                <span class="text-xs text-gray-500">${m.count} weeks • ${m.hours.toFixed(1)}h</span>
                            </div>
                            <i class="fas fa-trash text-red-500"></i>
                        </button>
                    `).join('');
                    
            } else if (type === 'year') {
                title.textContent = 'Delete Year';
                const years = {};
                timesheets.forEach(ts => {
                    const year = parseDate(ts.weekStart).getFullYear();
                    if (!years[year]) years[year] = 0;
                    years[year]++;
                });
                
                content.innerHTML = Object.keys(years).length === 0 ? '<p class="text-gray-500 text-center py-4">No data to delete</p>' :
                    Object.entries(years).map(([year, count]) => `
                        <button onclick="confirmDeleteYear(${year})" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-dark-surface rounded-xl mb-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <div>
                                <span class="font-medium text-gray-900 dark:text-white block text-lg">${year}</span>
                                <span class="text-xs text-gray-500">${count} weeks</span>
                            </div>
                            <i class="fas fa-trash text-red-500"></i>
                        </button>
                    `).join('');
            }
            
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        function confirmDeleteWeek(weekStart) {
            if (confirm('Delete this week permanently?')) {
                deleteWeek(weekStart);
                closeDeleteModal();
            }
        }

        async function deleteWeek(weekStart) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === weekStart);
            
            if (ts && ts.imageIds.front) await deleteImage(ts.imageIds.front);
            
            const updated = timesheets.filter(t => t.weekStart !== weekStart);
            DB.saveTimesheets(currentUser.username, updated);
            
            renderCalendar();
            updateStats();
            renderRecent();
            renderHistory();
            
            if (selectedWeekStart === weekStart) {
                document.getElementById('week-preview').classList.add('hidden');
                selectedWeekStart = null;
            }
            
            showToast('Week deleted');
        }

        function confirmDeleteMonth(year, month) {
            if (confirm(`Delete all data for ${new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}?`)) {
                deleteMonthData(year, month);
                closeDeleteModal();
            }
        }

        async function deleteMonthData(year, month) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const toDelete = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            
            // Delete images
            for (const ts of toDelete) {
                if (ts.imageIds.front) await deleteImage(ts.imageIds.front);
            }
            
            const remaining = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return !(d.getFullYear() === year && d.getMonth() === month);
            });
            
            DB.saveTimesheets(currentUser.username, remaining);
            renderCalendar();
            updateStats();
            renderRecent();
            showToast('Month deleted');
        }

        function confirmDeleteYear(year) {
            if (confirm(`Delete ALL data for ${year}? This cannot be undone.`)) {
                deleteYearData(year);
                closeDeleteModal();
            }
        }

        async function deleteYearData(year) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const toDelete = timesheets.filter(t => parseDate(t.weekStart).getFullYear() === year);
            
            for (const ts of toDelete) {
                if (ts.imageIds.front) await deleteImage(ts.imageIds.front);
            }
            
            const remaining = timesheets.filter(t => parseDate(t.weekStart).getFullYear() !== year);
            DB.saveTimesheets(currentUser.username, remaining);
            renderCalendar();
            updateStats();
            renderRecent();
            showToast('Year deleted');
        }

        async function deleteAllData() {
            if (confirm('DELETE ALL TIMESHEET DATA?\n\nThis will remove every timesheet. This cannot be undone.')) {
                if (confirm('Are you absolutely sure?')) {
                    const timesheets = DB.getTimesheets(currentUser.username);
                    for (const ts of timesheets) {
                        if (ts.imageIds.front) await deleteImage(ts.imageIds.front);
                    }
                    
                    DB.saveTimesheets(currentUser.username, []);
                    renderCalendar();
                    updateStats();
                    renderRecent();
                    document.getElementById('week-preview').classList.add('hidden');
                    showToast('All timesheet data deleted');
                }
            }
        }

        // ==================== ACCOUNT DELETION ====================
        function showRemoveAccountConfirm() {
            document.getElementById('remove-account-modal').classList.remove('hidden');
        }

        function hideRemoveAccountModal() {
            document.getElementById('remove-account-modal').classList.add('hidden');
        }

        async function executeRemoveAccount() {
            hideRemoveAccountModal();
            
            const removalScreen = document.getElementById('final-removal-screen');
            const check = document.getElementById('removal-check');
            const title = document.getElementById('removal-title');
            const text = document.getElementById('removal-text');
            const instructions = document.getElementById('removal-instructions');
            
            removalScreen.classList.remove('hidden');
            
            // Delete all images
            try {
                await clearAllImages();
            } catch (e) {
                console.log('Image clearing failed:', e);
            }
            
            // Delete user data
            if (currentUser) {
                DB.deleteUser(currentUser.username);
            }
            
            // Clear all app data
            const keysToRemove = Object.keys(localStorage).filter(k => k.startsWith('ts_'));
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Animate
            await new Promise(r => setTimeout(r, 300));
            check.classList.remove('opacity-0');
            check.classList.add('animate-bounce');
            
            await new Promise(r => setTimeout(r, 300));
            title.classList.remove('opacity-0');
            
            await new Promise(r => setTimeout(r, 200));
            text.classList.remove('opacity-0');
            
            await new Promise(r => setTimeout(r, 300));
            instructions.classList.remove('opacity-0');
            
            // Clear caches
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                } catch (e) {
                    console.log('Cache clearing failed:', e);
                }
            }
        }

        // ==================== HISTORY & OTHER ====================
        function renderHistory(filter = 'all') {
            const list = document.getElementById('history-list');
            let timesheets = DB.getTimesheets(currentUser.username);
            timesheets.sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart));
            
            const now = new Date();
            if (filter === 'month') {
                timesheets = timesheets.filter(t => {
                    const d = parseDate(t.weekStart);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (filter === 'year') {
                timesheets = timesheets.filter(t => parseDate(t.weekStart).getFullYear() === now.getFullYear());
            }
            
            if (timesheets.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-2"></i><p>No timesheets found</p></div>';
                return;
            }
            
            list.innerHTML = timesheets.map(ts => `
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center" onclick="openWeekDetailsById(${ts.id})">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl ${ts.totalHours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-600' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex items-center justify-center">
                            <i class="fas fa-calendar-week text-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">${ts.weekRange}</h4>
                            <p class="text-xs text-gray-500">${ts.totalHours}h • ${ts.firstWorkingDay || '?'} ${ts.firstShiftType || ''}</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            `).join('');
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                }
            });
            renderHistory(type);
        }

        function openWeekDetailsById(id) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.id === id);
            if (ts) openWeekDetails(ts);
        }

        async function openWeekDetails(ts) {
            document.getElementById('week-modal-title').textContent = ts.weekRange;
            const content = document.getElementById('week-modal-content');
            
            const frontImg = await getImage(ts.imageIds.front);
            
            content.innerHTML = `
                ${frontImg ? `<div class="mb-4"><img src="${frontImg}" class="w-full rounded-xl"></div>` : ''}
                
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800 mb-4">
                    <p class="text-sm text-green-800 dark:text-green-300">
                        <i class="fas fa-robot mr-2"></i>Auto-detected • First: ${ts.firstWorkingDay || 'Unknown'} ${ts.firstShiftType || ''}
                        ${ts.pattern ? `• Pattern: ${ts.pattern}` : ''}
                        ${ts.ocrVersion ? `• v${ts.ocrVersion}` : ''}
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${ts.totalHours}h</p>
                        <p class="text-xs text-blue-600 dark:text-blue-400">Total Hours</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${ts.longDays}</p>
                        <p class="text-xs text-orange-600 dark:text-orange-400">Long Days</p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400">${ts.lowRestDays}</p>
                        <p class="text-xs text-red-600 dark:text-red-400">Low Rest</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-surface rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-dark-card">
                            <tr>
                                <th class="text-left p-3 text-gray-500 font-medium">Day</th>
                                <th class="text-left p-3 text-gray-500 font-medium">Start</th>
                                <th class="text-left p-3 text-gray-500 font-medium">End</th>
                                <th class="text-right p-3 text-gray-500 font-medium">Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ts.days.map(day => `
                                <tr class="border-t border-gray-100 dark:border-gray-700 ${day.hours > 0 ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''}">
                                    <td class="p-3 font-medium">${day.day}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.start}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.end}</td>
                                    <td class="p-3 text-right font-bold ${day.hours > 10 ? 'text-orange-500' : 'text-green-600'}">${day.hours > 0 ? day.hours + 'h' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <button onclick="deleteWeek('${ts.weekStart}')" class="w-full py-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-colors mt-4">
                    <i class="fas fa-trash mr-2"></i>Delete This Week
                </button>
            `;
            
            document.getElementById('week-modal').classList.remove('hidden');
        }

        function closeWeekModal() {
            document.getElementById('week-modal').classList.add('hidden');
        }

        function updateStats() {
            const timesheets = DB.getTimesheets(currentUser.username);
            const now = new Date();
            
            const monthSheets = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const monthHours = monthSheets.reduce((sum, t) => sum + t.totalHours, 0);
            
            const yearSheets = timesheets.filter(t => parseDate(t.weekStart).getFullYear() === now.getFullYear());
            const yearHours = yearSheets.reduce((sum, t) => sum + t.totalHours, 0);
            
            document.getElementById('stat-month-hours').textContent = monthHours.toFixed(1) + 'h';
            document.getElementById('stat-year-hours').textContent = yearHours.toFixed(1) + 'h';
        }

        function renderRecent() {
            const list = document.getElementById('recent-list');
            const timesheets = DB.getTimesheets(currentUser.username)
                .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt))
                .slice(0, 3);
            
            if (timesheets.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No uploads yet</p>';
                return;
            }
            
            list.innerHTML = timesheets.map(ts => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-dark-surface rounded-xl" onclick="openWeekDetailsById(${ts.id})">
                    <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-sm text-gray-900 dark:text-white">${ts.weekRange}</p>
                        <p class="text-xs text-gray-500">${ts.totalHours} hours • ${ts.firstWorkingDay || 'Unknown'} start</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>
            `).join('');
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-primary');
                el.classList.add('text-gray-400');
            });
            
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            const activeBtn = document.querySelector(`[data-view="${viewName}"]`);
            activeBtn.classList.add('active', 'text-primary');
            activeBtn.classList.remove('text-gray-400');
            
            if (viewName === 'history') renderHistory();
            if (viewName === 'dashboard') { renderCalendar(); updateStats(); }
        }

        function initTheme() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-label').textContent = 'Light Mode';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');
            
            msgEl.textContent = message;
            iconEl.className = type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-green-400';
            
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 3000);
        }

        // Prevent zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await initImageDB();
            initAuth();
        });
    </script>
</body>
</html>
