<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3B82F6">
    <title>Driver Timesheet Pro v2.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#0F172A',
                        'dark-card': '#1E293B',
                        'dark-surface': '#334155'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }
        
        .calendar-day:active { transform: scale(0.95); }
        .calendar-day.has-data { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .calendar-day.today { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.3); z-index: 10; }
        .calendar-day.today.has-data { box-shadow: 0 0 0 3px #3B82F6, 0 0 0 5px rgba(59, 130, 246, 0.5); }
        .calendar-day.other-month { opacity: 0.3; }
        
        .upload-zone { transition: all 0.3s ease; border: 2px dashed #cbd5e1; }
        .upload-zone.active { border-color: #3B82F6; background-color: rgba(59, 130, 246, 0.05); transform: scale(1.02); }
        
        .nav-item { transition: all 0.3s ease; }
        .nav-item.active { color: #3B82F6; }
        .nav-item.active i { transform: translateY(-2px); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .extraction-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 0.7rem;
        }
        
        .day-cell {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 2px;
            text-align: center;
            min-height: 50px;
            background: white;
        }
        
        .day-cell.has-am { background: #fef3c7; border-color: #f59e0b; }
        .day-cell.has-pm { background: #e0e7ff; border-color: #6366f1; }
        .day-cell.has-both { background: linear-gradient(135deg, #fef3c7 0%, #e0e7ff 100%); border-color: #8b5cf6; }
        .day-cell.first-day { box-shadow: 0 0 0 2px #10B981; }
        .day-cell.auto-detected::after {
            content: 'AUTO';
            position: absolute;
            top: -4px;
            right: -4px;
            background: #10B981;
            color: white;
            font-size: 0.5rem;
            padding: 1px 3px;
            border-radius: 2px;
        }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 0.65rem;
        }
        
        .shift-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: bold;
            margin-top: 2px;
        }
        .shift-am { background: #f59e0b; color: white; }
        .shift-pm { background: #6366f1; color: white; }
        
        .correction-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 60px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 4px;
        }
        
        .confidence-high { color: #10B981; }
        .confidence-medium { color: #F59E0B; }
        .confidence-low { color: #EF4444; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-800 dark:text-gray-100 transition-colors duration-300 min-h-screen pb-20">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-white dark:bg-dark flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shadow-blue-500/30 mx-auto mb-4">
                    <i class="fas fa-truck"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Driver Timesheet Pro</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2 flex items-center justify-center gap-2">
                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded" id="version-display">v2.1.0</span>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Auto-Detection Enabled</span>
                </p>
            </div>

            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Driver</label>
                    <select id="user-select" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                
                <div id="pin-section" class="hidden">
                    <input type="password" id="pin-input" maxlength="4" inputmode="numeric" 
                        class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest" 
                        placeholder="••••">
                </div>

                <button onclick="login()" id="login-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95">
                    Login
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-dark text-gray-500">Admin Only</span></div>
                </div>

                <button onclick="showCreateUser()" class="w-full border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-4 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-card transition-all">
                    <i class="fas fa-user-plus mr-2"></i>Create New Driver
                </button>
            </div>

            <!-- Create User Form -->
            <div id="create-user-form" class="hidden space-y-4">
                <h2 class="text-xl font-bold text-center mb-4">Create New Driver</h2>
                
                <input type="text" id="new-username" placeholder="Driver Name" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none">
                
                <input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="Create 4-digit PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest">
                
                <input type="password" id="confirm-pin" maxlength="4" inputmode="numeric" placeholder="Confirm PIN" class="w-full p-4 bg-gray-100 dark:bg-dark-card rounded-xl border-2 border-transparent focus:border-primary outline-none text-center text-2xl tracking-widest">
                
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                    <label class="block text-sm font-medium text-blue-900 dark:text-blue-300 mb-2">
                        <i class="fas fa-magic mr-2"></i>Auto-Detection Mode
                    </label>
                    <p class="text-xs text-blue-700 dark:text-blue-400 mb-3">The app will automatically detect your first working day and times from the timesheet image.</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="hideCreateUser()" class="flex-1 py-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold">Cancel</button>
                    <button onclick="createUser()" class="flex-1 bg-primary hover:bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-dark-card shadow-sm sticky top-0 z-40">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                        <i class="fas fa-truck text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight" id="header-username">Driver</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="sync-status"><i class="fas fa-shield-alt text-green-500"></i> Local Storage</p>
                    </div>
                </div>
                <button onclick="logout()" class="touch-btn flex items-center justify-center text-gray-500 hover:text-red-500 transition-colors">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </header>

        <main class="px-4 py-4 max-w-lg mx-auto">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section fade-in space-y-4">
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="changeMonth(-1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400"></i>
                        </button>
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white" id="calendar-month-year">February 2024</h2>
                        <button onclick="changeMonth(1)" class="touch-btn w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">M</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">W</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">T</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">F</span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">S</span>
                    </div>
                    
                    <div id="calendar-grid" class="calendar-grid"></div>
                    
                    <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-green-500"></div><span>Complete</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-gray-300 dark:bg-gray-600"></div><span>Empty</span></div>
                        <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-primary ring-2 ring-primary ring-offset-2"></div><span>Today</span></div>
                    </div>
                </div>

                <div id="week-preview" class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-900 dark:text-white" id="preview-week-range">Week of Feb 5-11</h3>
                        <span class="text-sm font-bold text-primary" id="preview-total-hours">60h</span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="preview-days"></div>
                    <button onclick="openSelectedWeek()" class="w-full mt-3 py-3 bg-primary/10 dark:bg-primary/20 text-primary font-semibold rounded-xl hover:bg-primary/20 transition-colors">
                        View Full Details
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">This Month</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-month-hours">0h</p>
                    </div>
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">This Year</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="stat-year-hours">0h</p>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Uploads</h3>
                    <div id="recent-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Scan View with Auto-Detection -->
            <div id="scan-view" class="view-section hidden fade-in space-y-4">
                <div class="text-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Scan Timesheet</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Auto-detects days & times from image</p>
                </div>

                <!-- Auto-Detection Status -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-2xl p-4 border border-green-200 dark:border-green-800">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-900 dark:text-white">Smart Auto-Detection</p>
                            <p class="text-xs text-gray-500">Automatically finds first working day and extracts all times</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Week Ending Date (Saturday)</label>
                    <input type="date" id="scan-date-select" class="w-full p-3 bg-gray-100 dark:bg-dark-surface rounded-xl border-2 border-transparent focus:border-primary outline-none">
                    <p class="text-xs text-gray-500 mt-2" id="selected-week-info">Select the Saturday date from your timesheet</p>
                </div>

                <!-- Upload Zone -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-white">Timesheet Image <span class="text-red-500">*</span></h3>
                        <span class="text-xs text-gray-500" id="front-status">Required</span>
                    </div>
                    <div class="upload-zone rounded-xl p-6 text-center cursor-pointer relative overflow-hidden bg-gray-50 dark:bg-dark-surface" 
                         onclick="document.getElementById('file-front').click()"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="file-front" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
                        <div id="upload-front-default">
                            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Tap to take photo or browse</p>
                            <p class="text-xs text-gray-400 mt-1">Position timesheet flat, good lighting</p>
                        </div>
                        <img id="preview-front" class="hidden w-full h-48 object-cover rounded-lg mx-auto">
                    </div>
                </div>

                <!-- OCR Progress -->
                <div id="ocr-progress" class="hidden bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Analyzing timesheet...</span>
                        <span class="text-sm text-primary" id="ocr-status">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-dark-surface rounded-full h-2">
                        <div id="ocr-progress-bar" class="bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                        <i class="fas fa-spinner fa-spin" id="ocr-spinner"></i>
                        <span id="ocr-stage">Initializing...</span>
                    </div>
                </div>

                <!-- Auto-Detection Results -->
                <div id="auto-results" class="hidden space-y-4">
                    
                    <!-- Detection Summary -->
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-2xl p-4 border border-green-200 dark:border-green-800">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-green-800 dark:text-green-300">
                                <i class="fas fa-check-circle mr-2"></i>Auto-Detection Complete
                            </h3>
                            <span class="text-xs bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full" id="confidence-badge">High Confidence</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">First Day:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-first-day">Thursday</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Total Days:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-days">3 days</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Pattern:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-pattern">Double Shifts</span>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Total Hours:</span>
                                <span class="font-bold text-gray-900 dark:text-white ml-1" id="result-total-hours">~38h</span>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Grid -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-3 text-sm">Detected Schedule</h3>
                        <div class="extraction-grid relative" id="detection-grid">
                            <!-- Generated by JS -->
                        </div>
                        <div class="flex gap-4 mt-3 text-xs justify-center">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-amber-200 rounded"></div><span>AM Start</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-indigo-200 rounded"></div><span>PM End</span></div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gradient-to-r from-amber-200 to-indigo-200 rounded"></div><span>Both</span></div>
                        </div>
                    </div>

                    <!-- Time Correction Table -->
                    <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-900 dark:text-white text-sm">Extracted Times</h3>
                            <button onclick="resetToAuto()" class="text-xs text-primary hover:underline">Reset to Auto</button>
                        </div>
                        <div id="correction-table" class="space-y-2">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="reprocessImage()" class="flex-1 py-3 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-50 dark:hover:bg-dark-surface transition-colors">
                            <i class="fas fa-redo mr-2"></i>Re-scan
                        </button>
                        <button onclick="confirmAndSave()" class="flex-1 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Timesheet
                        </button>
                    </div>
                </div>

                <button onclick="startOCR()" id="scan-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    <i class="fas fa-magic mr-2"></i>Auto-Extract Times
                </button>
            </div>

            <!-- History View -->
            <div id="history-view" class="view-section hidden fade-in">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">All Timesheets</h2>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="filterHistory('all')" class="filter-btn active px-4 py-2 rounded-full bg-primary text-white text-sm font-medium whitespace-nowrap" data-filter="all">All</button>
                    <button onclick="filterHistory('month')" class="filter-btn px-4 py-2 rounded-full bg-gray-200 dark:bg-dark-surface text-gray-700 dark:text-gray-300 text-sm font-medium whitespace-nowrap" data-filter="month">This Month</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-section hidden fade-in space-y-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Settings</h2>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Appearance</h3>
                    <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 bg-gray-100 dark:bg-dark-surface rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                            <i class="fas fa-moon text-blue-400 hidden dark:block"></i>
                            <span class="font-medium text-gray-900 dark:text-white" id="theme-label">Dark Mode</span>
                        </div>
                        <div class="w-12 h-6 bg-gray-300 dark:bg-primary rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 dark:left-6 transition-all shadow-sm"></div>
                        </div>
                    </button>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3"><i class="fas fa-info-circle text-primary mr-2"></i>About</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <p><strong>Version:</strong> <span id="settings-version">v2.1.0</span></p>
                        <p><strong>Auto-Detection:</strong> Enabled</p>
                        <p class="text-xs">Automatically detects grid structure, first working day, and extracts AM/PM times from Spalding Depot timesheets.</p>
                    </div>
                </div>

                <button onclick="deleteAllData()" class="w-full p-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>Delete All Timesheet Data
                </button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t border-gray-200 dark:border-gray-700 z-40">
            <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
                <button onclick="switchView('dashboard')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center active" data-view="dashboard">
                    <i class="fas fa-calendar-alt text-xl transition-transform"></i>
                    <span class="text-xs font-medium">Calendar</span>
                </button>
                <button onclick="switchView('scan')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="scan">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-500/30 -mt-6 border-4 border-gray-50 dark:border-dark">
                        <i class="fas fa-plus text-lg"></i>
                    </div>
                    <span class="text-xs font-medium">Scan</span>
                </button>
                <button onclick="switchView('history')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="history">
                    <i class="fas fa-list text-xl transition-transform"></i>
                    <span class="text-xs font-medium">History</span>
                </button>
                <button onclick="switchView('settings')" class="nav-item flex flex-col items-center gap-1 text-gray-400 flex-1 h-full justify-center" data-view="settings">
                    <i class="fas fa-cog text-xl transition-transform"></i>
                    <span class="text-xs font-medium">Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Week Details Modal -->
    <div id="week-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeWeekModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full md:max-w-2xl md:rounded-2xl rounded-t-2xl shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-10">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white" id="week-modal-title">Week Details</h3>
                    <button onclick="closeWeekModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-dark-surface">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4" id="week-modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-xl shadow-lg transform -translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 max-w-md">
        <i id="toast-icon" class="fas fa-check-circle text-green-400 dark:text-green-600"></i>
        <span id="toast-message" class="font-medium text-sm">Operation successful</span>
    </div>

    <script>
        // ==================== CONFIG ====================
        const APP_VERSION = '2.1.0';
        let currentUser = null;
        let currentMonth = new Date();
        let selectedWeekStart = null;
        let currentImage = null;
        let imageDB = null;
        let extractedData = null;
        let autoDetectedData = null;

        // ==================== INDEXEDDB ====================
        const DB_NAME = 'TimesheetImagesDB';
        const STORE_NAME = 'images';
        
        function initImageDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { imageDB = request.result; resolve(imageDB); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveImage(id, dataUrl) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id, data: dataUrl, timestamp: Date.now() });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getImage(id) {
            if (!imageDB) await initImageDB();
            return new Promise((resolve, reject) => {
                const transaction = imageDB.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result ? request.result.data : null);
                request.onerror = () => reject(request.error);
            });
        }

        // ==================== DATE UTILITIES ====================
        function formatDateForInput(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        function parseDate(dateString) {
            if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            }
            return new Date(dateString);
        }
        
        function formatWeekRange(startDate, endDate) {
            const options = { month: 'short', day: 'numeric' };
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
        }

        // ==================== DATA STORE ====================
        const DB = {
            getUsers: () => JSON.parse(localStorage.getItem('ts_users') || '[]'),
            saveUsers: (users) => localStorage.setItem('ts_users', JSON.stringify(users)),
            getTimesheets: (username) => JSON.parse(localStorage.getItem(`ts_data_${username}`) || '[]'),
            saveTimesheets: (username, data) => localStorage.setItem(`ts_data_${username}`, JSON.stringify(data))
        };

        // ==================== AUTH ====================
        function initAuth() {
            document.getElementById('version-display').textContent = 'v' + APP_VERSION;
            document.getElementById('settings-version').textContent = 'v' + APP_VERSION;
            const users = DB.getUsers();
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                users.map(u => `<option value="${u.username}">${u.username}</option>`).join('');
            
            if (users.length === 1) {
                select.value = users[0].username;
                document.getElementById('pin-section').classList.remove('hidden');
            }
            
            select.addEventListener('change', function() {
                document.getElementById('pin-section').classList.toggle('hidden', !this.value);
            });
        }

        function login() {
            const username = document.getElementById('user-select').value;
            const pin = document.getElementById('pin-input').value;
            
            if (!username) return showToast('Please select a user', 'error');
            if (!pin || pin.length !== 4) return showToast('Enter 4-digit PIN', 'error');
            
            const users = DB.getUsers();
            const user = users.find(u => u.username === username && u.pin === hashPin(pin));
            
            if (!user) {
                showToast('Invalid PIN', 'error');
                document.getElementById('pin-input').value = '';
                return;
            }
            
            currentUser = user;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('header-username').textContent = user.username;
            
            // Set default date to upcoming Saturday
            const today = new Date();
            const saturday = new Date(today);
            saturday.setDate(today.getDate() + (6 - today.getDay()));
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            
            initTheme();
            renderCalendar();
            updateStats();
            renderRecent();
            
            showToast(`Welcome, ${user.username}`);
        }

        function updateScanWeekDisplay() {
            const dateInput = document.getElementById('scan-date-select');
            if (dateInput.value) {
                const endDate = parseDate(dateInput.value);
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                document.getElementById('selected-week-info').textContent = 
                    `Week: ${formatWeekRange(startDate, endDate)}`;
            }
        }

        function showCreateUser() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('create-user-form').classList.remove('hidden');
        }

        function hideCreateUser() {
            document.getElementById('create-user-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function createUser() {
            const username = document.getElementById('new-username').value.trim();
            const pin = document.getElementById('new-pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            
            if (!username) return showToast('Enter driver name', 'error');
            if (!pin || pin.length !== 4) return showToast('PIN must be 4 digits', 'error');
            if (pin !== confirmPin) return showToast('PINs do not match', 'error');
            
            const users = DB.getUsers();
            if (users.find(u => u.username === username)) return showToast('User already exists', 'error');
            
            users.push({ username, pin: hashPin(pin), created: new Date().toISOString() });
            DB.saveUsers(users);
            
            showToast('Driver created successfully');
            hideCreateUser();
            initAuth();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-section').classList.add('hidden');
            document.getElementById('user-select').value = '';
        }

        function hashPin(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ==================== CALENDAR ====================
        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const timesheets = DB.getTimesheets(currentUser.username);
            const weekData = {};
            
            timesheets.forEach(ts => {
                const date = parseDate(ts.weekStart);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    weekData[date.getDate()] = ts;
                }
            });
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = startPadding - 1; i >= 0; i--) {
                grid.appendChild(createCalendarDay(prevMonthDays - i, true));
            }
            
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = (day === todayDate && month === todayMonth && year === todayYear);
                const hasData = weekData[day];
                const cell = createCalendarDay(day, false, isToday, hasData);
                
                if (hasData) cell.onclick = () => selectWeek(hasData);
                else cell.onclick = () => selectEmptyWeek(year, month, day);
                
                grid.appendChild(cell);
            }
            
            const remaining = (7 - ((startPadding + daysInMonth) % 7)) % 7;
            for (let day = 1; day <= remaining; day++) {
                grid.appendChild(createCalendarDay(day, true));
            }
        }

        function createCalendarDay(day, isOtherMonth, isToday = false, data = null) {
            const div = document.createElement('div');
            let className = 'calendar-day';
            
            if (isOtherMonth) className += ' other-month bg-gray-100 dark:bg-dark-surface text-gray-400';
            else className += ' bg-white dark:bg-dark-surface text-gray-900 dark:text-white';
            
            if (isToday) className += ' today';
            if (data) className += ' has-data';
            
            div.className = className;
            
            let todayIndicator = '';
            if (isToday) {
                todayIndicator = '<div class="absolute -top-1 -right-1 w-3 h-3 bg-primary rounded-full border-2 border-white dark:border-dark-card"></div>';
            }
            
            div.innerHTML = `
                <span class="text-lg font-bold">${day}</span>
                ${data ? '<div style="background: rgba(255,255,255,0.5); height: 3px; width: 60%; border-radius: 2px; margin-top: 2px;"></div>' : ''}
                ${todayIndicator}
            `;
            return div;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function selectWeek(timesheet) {
            selectedWeekStart = timesheet.weekStart;
            const preview = document.getElementById('week-preview');
            preview.classList.remove('hidden');
            
            document.getElementById('preview-week-range').textContent = timesheet.weekRange;
            document.getElementById('preview-total-hours').textContent = timesheet.totalHours + 'h';
            
            const daysContainer = document.getElementById('preview-days');
            daysContainer.innerHTML = timesheet.days.map((day, i) => `
                <div class="flex-shrink-0 w-16 h-16 rounded-xl ${day.hours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex flex-col items-center justify-center">
                    <span class="text-xs">${['S','M','T','W','T','F','S'][i]}</span>
                    <span class="font-bold">${day.hours > 0 ? day.hours : '-'}</span>
                </div>
            `).join('');
        }

        function selectEmptyWeek(year, month, day) {
            const date = new Date(year, month, day, 12, 0, 0);
            const saturday = new Date(date);
            saturday.setDate(date.getDate() + (6 - date.getDay()));
            
            document.getElementById('scan-date-select').value = formatDateForInput(saturday);
            updateScanWeekDisplay();
            switchView('scan');
            showToast('Selected week for new upload');
        }

        function openSelectedWeek() {
            if (!selectedWeekStart) return;
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === selectedWeekStart);
            if (ts) openWeekDetails(ts);
        }

        // ==================== SCAN & AUTO-DETECTION ====================
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('active');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('active');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processFile(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                document.getElementById('preview-front').src = currentImage;
                document.getElementById('preview-front').classList.remove('hidden');
                document.getElementById('upload-front-default').classList.add('hidden');
                document.getElementById('front-status').textContent = 'Ready';
                document.getElementById('front-status').className = 'text-xs text-green-600 font-medium';
            };
            reader.readAsDataURL(file);
        }

        // MAIN OCR FUNCTION with Auto-Detection
        async function startOCR() {
            if (!currentImage) return showToast('Please upload timesheet image', 'error');
            
            const weekEnding = document.getElementById('scan-date-select').value;
            if (!weekEnding) return showToast('Please select week ending date', 'error');
            
            document.getElementById('scan-btn').classList.add('hidden');
            document.getElementById('ocr-progress').classList.remove('hidden');
            
            try {
                updateOcrProgress(10, 'Loading OCR engine...');
                
                const result = await Tesseract.recognize(
                    currentImage,
                    'eng',
                    { 
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                updateOcrProgress(10 + Math.round(m.progress * 60), 'Reading timesheet...');
                            }
                        }
                    }
                );
                
                updateOcrProgress(70, 'Analyzing structure...');
                
                // Parse with auto-detection
                autoDetectedData = parseTimesheetWithAutoDetection(result.data.text);
                
                updateOcrProgress(90, 'Calculating hours...');
                
                // Calculate totals
                let totalHours = 0;
                let workingDays = 0;
                autoDetectedData.days.forEach(day => {
                    if (day.hasData) {
                        workingDays++;
                        if (day.amTime && day.pmTime) {
                            const hours = calculateHoursBetween(day.amTime, day.pmTime);
                            day.hours = hours;
                            totalHours += hours;
                        }
                    }
                });
                
                autoDetectedData.totalHours = Math.round(totalHours * 10) / 10;
                autoDetectedData.workingDays = workingDays;
                
                updateOcrProgress(100, 'Complete!');
                
                // Show results
                setTimeout(() => {
                    document.getElementById('ocr-progress').classList.add('hidden');
                    showAutoDetectionResults();
                }, 500);
                
            } catch (err) {
                console.error('OCR Error:', err);
                showToast('OCR failed: ' + err.message, 'error');
                document.getElementById('ocr-progress').classList.add('hidden');
                document.getElementById('scan-btn').classList.remove('hidden');
            }
        }

        function updateOcrProgress(percent, stage) {
            document.getElementById('ocr-progress-bar').style.width = percent + '%';
            document.getElementById('ocr-status').textContent = percent + '%';
            document.getElementById('ocr-stage').textContent = stage;
        }

        // IMPROVED: Auto-detection parser for Spalding Depot format
        function parseTimesheetWithAutoDetection(ocrText) {
            const lines = ocrText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayData = {};
            
            // Initialize all days
            days.forEach(day => {
                dayData[day] = { 
                    amTime: null, 
                    pmTime: null, 
                    amLocation: null,
                    pmLocation: null,
                    hasData: false,
                    confidence: 'low'
                };
            });
            
            // Pattern matching for timesheet rows
            // Look for patterns like "THUR AM", "FRI PM" followed by times
            
            let i = 0;
            while (i < lines.length) {
                const line = lines[i].toUpperCase();
                
                // Check for day + period pattern (e.g., "THUR AM", "FRI PM", "SUN AM")
                const dayPattern = /(SUN|MON|TUE|WED|THU|FRI|SAT)[\s_]*(AM|PM)/i;
                const match = line.match(dayPattern);
                
                if (match) {
                    const dayName = match[1].toUpperCase();
                    const period = match[2].toUpperCase();
                    
                    // Look ahead for times in this line and next few lines
                    const searchText = [line];
                    if (i + 1 < lines.length) searchText.push(lines[i + 1]);
                    if (i + 2 < lines.length) searchText.push(lines[i + 2]);
                    
                    const combinedText = searchText.join(' ');
                    
                    // Extract times using multiple patterns
                    const times = extractAllTimes(combinedText);
                    const locations = extractLocations(combinedText);
                    
                    if (times.length > 0) {
                        // Sort times - earlier is start, later is end
                        times.sort();
                        
                        if (period === 'AM' && times[0]) {
                            dayData[dayName].amTime = times[0];
                            dayData[dayName].amLocation = locations[0] || 'Quay';
                            dayData[dayName].hasData = true;
                            dayData[dayName].confidence = 'high';
                        } else if (period === 'PM' && times[0]) {
                            dayData[dayName].pmTime = times[0];
                            dayData[dayName].pmLocation = locations[0] || 'Quay';
                            dayData[dayName].hasData = true;
                            dayData[dayName].confidence = 'high';
                        }
                        
                        // If we have both AM and PM for same day, it's a double shift
                        if (dayData[dayName].amTime && dayData[dayName].pmTime) {
                            dayData[dayName].shiftType = 'double';
                        }
                    }
                }
                
                // Also check for standalone times near day names
                const looseDayMatch = line.match(/(SUN|MON|TUE|WED|THU|FRI|SAT)/i);
                if (looseDayMatch && !match) {
                    const dayName = looseDayMatch[1].toUpperCase();
                    const times = extractAllTimes(line);
                    
                    if (times.length > 0 && !dayData[dayName].hasData) {
                        // Guess AM/PM based on time value
                        times.forEach(time => {
                            const hour = parseInt(time.split(':')[0]);
                            if (hour >= 4 && hour < 12 && !dayData[dayName].amTime) {
                                dayData[dayName].amTime = time;
                                dayData[dayName].hasData = true;
                            } else if (hour >= 12 && hour <= 23 && !dayData[dayName].pmTime) {
                                dayData[dayName].pmTime = time;
                                dayData[dayName].hasData = true;
                            }
                        });
                    }
                }
                
                i++;
            }
            
            // Find first working day
            let firstWorkingDay = null;
            for (const day of days) {
                if (dayData[day].hasData) {
                    firstWorkingDay = day;
                    break;
                }
            }
            
            // Detect pattern
            let pattern = 'single';
            let doubleShiftDays = 0;
            days.forEach(day => {
                if (dayData[day].amTime && dayData[day].pmTime) doubleShiftDays++;
            });
            
            if (doubleShiftDays >= 2) pattern = 'double';
            if (doubleShiftDays >= 3) pattern = 'continuous';
            
            return {
                days: dayData,
                firstWorkingDay: firstWorkingDay || 'MON',
                pattern: pattern,
                doubleShiftDays: doubleShiftDays,
                rawText: ocrText
            };
        }

        function extractAllTimes(text) {
            const times = [];
            const seen = new Set();
            
            // Pattern 1: HH:MM (24-hour format)
            const pattern1 = /(\d{1,2})[:.](\d{2})/g;
            let match;
            while ((match = pattern1.exec(text)) !== null) {
                const hour = parseInt(match[1]);
                const minute = parseInt(match[2]);
                
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    // Filter out years (2000-2099)
                    if (hour >= 20 && minute >= 0 && minute <= 30 && text.includes('20' + match[1])) continue;
                    
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    if (!seen.has(timeStr)) {
                        times.push(timeStr);
                        seen.add(timeStr);
                    }
                }
            }
            
            // Pattern 2: HHMM (4 digits, no separator)
            const pattern2 = /[^\d](\d{2})(\d{2})[^\d]/g;
            while ((match = pattern2.exec(text)) !== null) {
                const hour = parseInt(match[1]);
                const minute = parseInt(match[2]);
                
                if (hour >= 4 && hour <= 23 && minute >= 0 && minute <= 59) {
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    if (!seen.has(timeStr)) {
                        times.push(timeStr);
                        seen.add(timeStr);
                    }
                }
            }
            
            return times.sort();
        }

        function extractLocations(text) {
            const locations = [];
            // Common location patterns
            const locPatterns = [/Quay/i, /Depot/i, /Spalding/i, /Home/i, /Yard/i];
            
            locPatterns.forEach(pattern => {
                const match = text.match(pattern);
                if (match) locations.push(match[0]);
            });
            
            return locations;
        }

        function calculateHoursBetween(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let hours = endHour - startHour;
            let mins = endMin - startMin;
            
            if (mins < 0) {
                hours--;
                mins += 60;
            }
            
            if (hours < 0) hours += 24; // Overnight shift
            
            return hours + (mins / 60);
        }

        function showAutoDetectionResults() {
            document.getElementById('auto-results').classList.remove('hidden');
            
            // Update summary
            const dayNames = {
                'SUN': 'Sunday', 'MON': 'Monday', 'TUE': 'Tuesday',
                'WED': 'Wednesday', 'THU': 'Thursday', 'FRI': 'Friday', 'SAT': 'Saturday'
            };
            
            document.getElementById('result-first-day').textContent = dayNames[autoDetectedData.firstWorkingDay] || autoDetectedData.firstWorkingDay;
            document.getElementById('result-total-days').textContent = autoDetectedData.workingDays + ' days';
            document.getElementById('result-pattern').textContent = 
                autoDetectedData.pattern === 'double' ? 'Double Shifts' : 
                autoDetectedData.pattern === 'continuous' ? 'Continuous Double' : 'Single Shifts';
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
            
            // Confidence badge
            const confidence = autoDetectedData.workingDays >= 3 ? 'High' : 
                              autoDetectedData.workingDays >= 1 ? 'Medium' : 'Low';
            const badge = document.getElementById('confidence-badge');
            badge.textContent = confidence + ' Confidence';
            badge.className = 'text-xs px-2 py-1 rounded-full ' + 
                (confidence === 'High' ? 'bg-green-200 text-green-800' :
                 confidence === 'Medium' ? 'bg-yellow-200 text-yellow-800' :
                 'bg-red-200 text-red-800');
            
            // Render grid
            renderDetectionGrid();
            
            // Render correction table
            renderCorrectionTable();
        }

        function renderDetectionGrid() {
            const grid = document.getElementById('detection-grid');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            grid.innerHTML = days.map((day, idx) => {
                const data = autoDetectedData.days[day];
                const isFirst = day === autoDetectedData.firstWorkingDay;
                
                let cellClass = 'day-cell relative';
                if (data.amTime && data.pmTime) cellClass += ' has-both';
                else if (data.amTime) cellClass += ' has-am';
                else if (data.pmTime) cellClass += ' has-pm';
                if (isFirst) cellClass += ' first-day';
                
                return `
                    <div class="${cellClass}">
                        <div class="font-bold text-xs mb-1 ${isFirst ? 'text-green-600' : ''}">${dayLabels[idx]}</div>
                        ${data.amTime ? `<div class="time-display text-amber-700">${data.amTime}</div>` : ''}
                        ${data.pmTime ? `<div class="time-display text-indigo-700">${data.pmTime}</div>` : ''}
                        ${!data.amTime && !data.pmTime ? '<div class="text-gray-300">-</div>' : ''}
                        ${isFirst ? '<div class="absolute -top-1 -left-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center text-white text-[8px]">1st</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderCorrectionTable() {
            const container = document.getElementById('correction-table');
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            const workingDays = days.filter(day => autoDetectedData.days[day].hasData);
            
            container.innerHTML = workingDays.map(day => {
                const data = autoDetectedData.days[day];
                const idx = days.indexOf(day);
                const isFirst = day === autoDetectedData.firstWorkingDay;
                
                return `
                    <div class="correction-row ${isFirst ? 'ring-2 ring-green-400 rounded-lg' : ''}">
                        <div class="font-bold text-sm ${isFirst ? 'text-green-600' : ''}">${dayNames[idx]}${isFirst ? '*' : ''}</div>
                        <div>
                            <label class="text-xs text-gray-500">Start (AM)</label>
                            <input type="time" class="w-full p-1 text-sm border rounded" 
                                value="${data.amTime || ''}" 
                                onchange="updateCorrectedTime('${day}', 'am', this.value)"
                                placeholder="--:--">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">End (PM)</label>
                            <input type="time" class="w-full p-1 text-sm border rounded" 
                                value="${data.pmTime || ''}" 
                                onchange="updateCorrectedTime('${day}', 'pm', this.value)"
                                placeholder="--:--">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Hrs</label>
                            <input type="number" class="w-full p-1 text-sm border rounded text-center" 
                                value="${data.hours ? data.hours.toFixed(1) : ''}" 
                                step="0.5" min="0" max="24"
                                onchange="updateCorrectedTime('${day}', 'hours', this.value)">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCorrectedTime(day, field, value) {
            if (!autoDetectedData) return;
            
            if (field === 'am') autoDetectedData.days[day].amTime = value;
            if (field === 'pm') autoDetectedData.days[day].pmTime = value;
            if (field === 'hours') autoDetectedData.days[day].hours = parseFloat(value) || 0;
            
            // Recalculate totals
            let total = 0;
            Object.values(autoDetectedData.days).forEach(d => {
                if (d.hours) total += d.hours;
            });
            autoDetectedData.totalHours = Math.round(total * 10) / 10;
            document.getElementById('result-total-hours').textContent = '~' + autoDetectedData.totalHours + 'h';
        }

        function resetToAuto() {
            if (confirm('Reset all times to auto-detected values?')) {
                renderCorrectionTable();
                showToast('Reset to auto-detected values');
            }
        }

        function reprocessImage() {
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            startOCR();
        }

        async function confirmAndSave() {
            if (!autoDetectedData) return;
            
            const weekEnding = document.getElementById('scan-date-select').value;
            const endDate = parseDate(weekEnding);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            
            // Build final data
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayData = [];
            let totalHours = 0;
            let longDays = 0;
            
            days.forEach((dayName, idx) => {
                const dayKey = dayName.toUpperCase();
                const detected = autoDetectedData.days[dayKey];
                
                let hours = 0;
                let start = '-';
                let end = '-';
                
                if (detected && detected.hasData) {
                    start = detected.amTime || detected.pmTime || '-';
                    end = detected.pmTime || detected.amTime || '-';
                    hours = detected.hours || 0;
                    
                    if (hours === 0 && start !== '-' && end !== '-') {
                        hours = calculateHoursBetween(start, end);
                    }
                    
                    totalHours += hours;
                    if (hours > 10) longDays++;
                }
                
                dayData.push({
                    day: dayName,
                    hours: Math.round(hours * 10) / 10,
                    start: start,
                    end: end,
                    rest: hours > 0 ? '11h' : '-',
                    flag: hours > 10 ? 'warning' : (hours > 0 ? 'ok' : 'none')
                });
            });
            
            // Save
            const timesheetId = Date.now().toString();
            const imageIds = { front: `${timesheetId}_front` };
            
            await saveImage(imageIds.front, currentImage);
            
            const timesheet = {
                id: parseInt(timesheetId),
                weekStart: formatDateForInput(startDate),
                weekEnd: weekEnding,
                weekRange: formatWeekRange(startDate, endDate),
                totalHours: Math.round(totalHours * 10) / 10,
                longDays,
                lowRestDays: 0,
                firstWorkingDay: autoDetectedData.firstWorkingDay,
                pattern: autoDetectedData.pattern,
                imageIds,
                days: dayData,
                uploadedAt: new Date().toISOString()
            };
            
            const existing = DB.getTimesheets(currentUser.username);
            existing.push(timesheet);
            DB.saveTimesheets(currentUser.username, existing);
            
            // Reset UI
            resetScanForm();
            document.getElementById('auto-results').classList.add('hidden');
            document.getElementById('scan-btn').classList.remove('hidden');
            
            renderCalendar();
            updateStats();
            renderRecent();
            
            showToast(`Saved! First day: ${autoDetectedData.firstWorkingDay}, ${totalHours.toFixed(1)} hours`);
            switchView('dashboard');
        }

        function resetScanForm() {
            currentImage = null;
            autoDetectedData = null;
            document.getElementById('preview-front').src = '';
            document.getElementById('preview-front').classList.add('hidden');
            document.getElementById('upload-front-default').classList.remove('hidden');
            document.getElementById('file-front').value = '';
            document.getElementById('front-status').textContent = 'Required';
            document.getElementById('front-status').className = 'text-xs text-gray-500';
        }

        // ==================== HISTORY & OTHER FUNCTIONS ====================
        function renderHistory(filter = 'all') {
            const list = document.getElementById('history-list');
            let timesheets = DB.getTimesheets(currentUser.username);
            timesheets.sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart));
            
            const now = new Date();
            if (filter === 'month') {
                timesheets = timesheets.filter(t => {
                    const d = parseDate(t.weekStart);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            }
            
            if (timesheets.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-2"></i><p>No timesheets found</p></div>';
                return;
            }
            
            list.innerHTML = timesheets.map(ts => `
                <div class="bg-white dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center" onclick="openWeekDetailsById(${ts.id})">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl ${ts.totalHours > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-600' : 'bg-gray-100 dark:bg-dark-surface text-gray-400'} flex items-center justify-center">
                            <i class="fas fa-calendar-week text-lg"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">${ts.weekRange}</h4>
                            <p class="text-xs text-gray-500">${ts.totalHours}h • Starts ${ts.firstWorkingDay || '?'}</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            `).join('');
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === type) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-dark-surface', 'text-gray-700', 'dark:text-gray-300');
                }
            });
            renderHistory(type);
        }

        function openWeekDetailsById(id) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.id === id);
            if (ts) openWeekDetails(ts);
        }

        async function openWeekDetails(ts) {
            document.getElementById('week-modal-title').textContent = ts.weekRange;
            const content = document.getElementById('week-modal-content');
            
            const frontImg = await getImage(ts.imageIds.front);
            
            content.innerHTML = `
                ${frontImg ? `<div class="mb-4"><img src="${frontImg}" class="w-full rounded-xl"></div>` : ''}
                
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800 mb-4">
                    <p class="text-sm text-green-800 dark:text-green-300">
                        <i class="fas fa-robot mr-2"></i>Auto-detected • First day: ${ts.firstWorkingDay || 'Unknown'}
                        ${ts.pattern ? `• Pattern: ${ts.pattern}` : ''}
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${ts.totalHours}h</p>
                        <p class="text-xs text-blue-600 dark:text-blue-400">Total Hours</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${ts.longDays}</p>
                        <p class="text-xs text-orange-600 dark:text-orange-400">Long Days</p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-3 text-center">
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400">${ts.lowRestDays}</p>
                        <p class="text-xs text-red-600 dark:text-red-400">Low Rest</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-surface rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-dark-card">
                            <tr>
                                <th class="text-left p-3 text-gray-500 font-medium">Day</th>
                                <th class="text-left p-3 text-gray-500 font-medium">Start</th>
                                <th class="text-left p-3 text-gray-500 font-medium">End</th>
                                <th class="text-right p-3 text-gray-500 font-medium">Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ts.days.map(day => `
                                <tr class="border-t border-gray-100 dark:border-gray-700 ${day.hours > 0 ? 'bg-blue-50/30 dark:bg-blue-900/10' : ''}">
                                    <td class="p-3 font-medium">${day.day}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.start}</td>
                                    <td class="p-3 text-gray-600 dark:text-gray-400">${day.end}</td>
                                    <td class="p-3 text-right font-bold ${day.hours > 10 ? 'text-orange-500' : 'text-green-600'}">${day.hours > 0 ? day.hours + 'h' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <button onclick="deleteWeek('${ts.weekStart}')" class="w-full py-3 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-colors mt-4">
                    <i class="fas fa-trash mr-2"></i>Delete This Week
                </button>
            `;
            
            document.getElementById('week-modal').classList.remove('hidden');
        }

        function closeWeekModal() {
            document.getElementById('week-modal').classList.add('hidden');
        }

        async function deleteWeek(weekStart) {
            const timesheets = DB.getTimesheets(currentUser.username);
            const ts = timesheets.find(t => t.weekStart === weekStart);
            
            if (ts && ts.imageIds.front) await deleteImage(ts.imageIds.front);
            
            const updated = timesheets.filter(t => t.weekStart !== weekStart);
            DB.saveTimesheets(currentUser.username, updated);
            
            renderCalendar();
            updateStats();
            renderRecent();
            renderHistory();
            closeWeekModal();
            
            if (selectedWeekStart === weekStart) {
                document.getElementById('week-preview').classList.add('hidden');
                selectedWeekStart = null;
            }
            
            showToast('Week deleted');
        }

        function updateStats() {
            const timesheets = DB.getTimesheets(currentUser.username);
            const now = new Date();
            
            const monthSheets = timesheets.filter(t => {
                const d = parseDate(t.weekStart);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const monthHours = monthSheets.reduce((sum, t) => sum + t.totalHours, 0);
            
            const yearSheets = timesheets.filter(t => parseDate(t.weekStart).getFullYear() === now.getFullYear());
            const yearHours = yearSheets.reduce((sum, t) => sum + t.totalHours, 0);
            
            document.getElementById('stat-month-hours').textContent = monthHours.toFixed(1) + 'h';
            document.getElementById('stat-year-hours').textContent = yearHours.toFixed(1) + 'h';
        }

        function renderRecent() {
            const list = document.getElementById('recent-list');
            const timesheets = DB.getTimesheets(currentUser.username)
                .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt))
                .slice(0, 3);
            
            if (timesheets.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No uploads yet</p>';
                return;
            }
            
            list.innerHTML = timesheets.map(ts => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-dark-surface rounded-xl" onclick="openWeekDetailsById(${ts.id})">
                    <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-sm text-gray-900 dark:text-white">${ts.weekRange}</p>
                        <p class="text-xs text-gray-500">${ts.totalHours} hours • ${ts.firstWorkingDay || 'Unknown'} start</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>
            `).join('');
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-primary');
                el.classList.add('text-gray-400');
            });
            
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            const activeBtn = document.querySelector(`[data-view="${viewName}"]`);
            activeBtn.classList.add('active', 'text-primary');
            activeBtn.classList.remove('text-gray-400');
            
            if (viewName === 'history') renderHistory();
            if (viewName === 'dashboard') { renderCalendar(); updateStats(); }
        }

        function initTheme() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-label').textContent = 'Light Mode';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }

        function deleteAllData() {
            if (confirm('DELETE ALL TIMESHEET DATA?\n\nThis cannot be undone.')) {
                if (confirm('Are you absolutely sure?')) {
                    DB.saveTimesheets(currentUser.username, []);
                    renderCalendar();
                    updateStats();
                    renderRecent();
                    document.getElementById('week-preview').classList.add('hidden');
                    showToast('All timesheet data deleted');
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');
            
            msgEl.textContent = message;
            iconEl.className = type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-green-400';
            
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 3000);
        }

        // Prevent zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await initImageDB();
            initAuth();
        });
    </script>
</body>
</html>
